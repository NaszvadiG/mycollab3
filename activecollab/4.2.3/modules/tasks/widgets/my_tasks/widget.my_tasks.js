(function($){var public_methods={init:function(){return this.each(function(){var wrapper=$(this);var user_id=parseInt(wrapper.data("userId"));collapse_long_groups.apply(wrapper[0]);var object_tracking=wrapper.find("span.object_tracking");if(wrapper.data("canUseTracking")&&object_tracking){object_tracking.objectTime()}wrapper.data("refreshInterval",window.setInterval(function(){wrapper.myTasks("refresh")},60000));App.Wireframe.Events.bind("task_created.content task_updated.content",function(event,task){var should_we_refresh=typeof(task.assignee)=="object"&&task.assignee&&task.assignee["id"]==user_id;if(!should_we_refresh&&jQuery.isArray(task.other_assignees)){App.each(task.other_assignees,function(k,assignee){if(assignee.id==user_id){should_we_refresh=true;return false}})}if(should_we_refresh){wrapper.myTasks("refresh",true)}});App.Wireframe.Events.bind("subtask_created.content subtask_updated.content",function(event,subtask){if(typeof(subtask.assignee)=="object"&&subtask.assignee&&subtask.assignee["id"]==user_id){wrapper.myTasks("refresh",true)}});App.Wireframe.Events.bind("my_tasks_settings_updated.content",function(){wrapper.myTasks("refresh",true)});wrapper.on("click","tr.show_more_assignments a",function(event){var link=$(this);var group=link.parents("table:first");if(group.data("showingMore")){group.find("tr.assignment.more_assignments").hide();group.data("showingMore",false);link.text(App.lang("Showing first :num assignments. Click here to show all :total",{num:show_per_group.apply(wrapper[0]),total:group.find("tr.assignment").length}));$("#wireframe_content").scrollTo(group[0],200)}else{group.find("tr.assignment.more_assignments").show();group.data("showingMore",true);link.text(App.lang("Show less assignments"))}return false});var completed_icon_url=App.Wireframe.Utils.imageUrl("/icons/12x12/checkbox-checked.png","complete");var open_icon_url=App.Wireframe.Utils.imageUrl("/icons/12x12/checkbox-unchecked.png","complete");wrapper.on("click","td.name span.my_tasks_name_element.checkbox img",function(event){var img=$(this);var row=img.parents("tr:first");if(img.data("working")){return}img.data("working",true);img.attr("src",App.Wireframe.Utils.indicatorUrl("small"));var update_row_from_response=function(assignment){img.data("working",false);if(typeof(assignment.completed_on)=="object"&&assignment.completed_on){img.data("isCompleted",true).attr("src",completed_icon_url);row.addClass("completed")}else{img.data("isCompleted",false).attr("src",open_icon_url);row.removeClass("completed")}};if(img.data("isCompleted")){$.ajax({type:"post",url:img.data("reopenUrl"),data:{submitted:"submitted"},success:function(response){update_row_from_response(response)},error:function(){img.data("working",false);img.attr("src",completed_icon_url)}})}else{$.ajax({type:"post",url:img.data("completeUrl"),data:{submitted:"submitted"},success:function(response){update_row_from_response(response)},error:function(){img.data("working",false);img.attr("src",open_icon_url)}})}});wrapper.on("click","a.toggle_group",function(event){var link=$(this);var tbody=link.parents("table:first").find("tbody");if(event.shiftKey){if(tbody.is(":visible")){wrapper.find("table.assignment_group tbody").hide();wrapper.find("table.assignment_group a.toggle_group").text(App.lang("Show"))}else{wrapper.find("table.assignment_group tbody").show();wrapper.find("table.assignment_group a.toggle_group").text(App.lang("Hide"))}}else{if(tbody.is(":visible")){tbody.hide();link.text(App.lang("Show"))}else{tbody.show();link.text(App.lang("Hide"))}}return false})})},refresh:function(force){var wrapper=$(this);var refresh_counter=parseInt(wrapper.data("refreshCounter"))+1;if(!force){wrapper.data("refreshCounter",refresh_counter);if(refresh_counter<5){return}}App.Wireframe.LoadingIndicator.show(App.lang("Refreshing"));$.ajax({url:wrapper.data("refreshUrl"),success:function(response){App.Wireframe.LoadingIndicator.hide();if(typeof(response)=="object"&&response){var labels=response.labels;var assignments=App.isMappable(response.assignments)?new App.Map(response.assignments):new App.Map();var late_assignments=App.isMappable(response.late_assignments)?new App.Map(response.late_assignments):new App.Map();var empty_page=wrapper.find("p.empty_page").hide();rebuild_assignments_from_map.apply(wrapper[0],[assignments,labels]);rebuild_late_assignments_from_map.apply(wrapper[0],[late_assignments]);if(wrapper.find(".assignment").length<1){empty_page.show()}}wrapper.data("refreshCounter",0)},error:function(){App.Wireframe.LoadingIndicator.hide()}})}};var rebuild_assignments_from_map=function(map,labels){var wrapper=$(this);var inner_wrapper=wrapper.find("div.my_tasks_inner_wrapper");var user_id=parseInt(wrapper.data("userId")),previous_group=null;inner_wrapper.find("table.assignment_group").addClass("marked");inner_wrapper.find("table.assignment_group tr.assignment").addClass("marked");App.each(map,function(k,v){var existing_group=wrapper.find("table[data-group-name="+k+"]");if(existing_group.length==1){if(typeof(v.url)=="string"&&v.url){var group_label='<a href="'+App.clean(v.url)+'" class="quick_view_item">'+App.clean(v.label)+"</a>"}else{var group_label=App.clean(v.label)}existing_group.find("thead th.group_name").empty().html(group_label);var tbody=existing_group.find("tbody"),previous_assignment=null;App.each(v.assignments,function(assignment_id,assignment){if(assignment.assignee_id==user_id||(jQuery.isArray(assignment.other_assignees)&&assignment.other_assignees.indexOf(user_id)!=-1)){var existing_assignment=tbody.find("tr.task[data-task-id="+assignment_id+"]");if(existing_assignment.length){update_assignment_row.apply(wrapper[0],[existing_assignment,assignment,null,labels,user_id])}else{var existing_assignment=$(assignment_to_row.apply(wrapper[0],[assignment,labels,user_id,false]))}if(previous_assignment===null){tbody.prepend(existing_assignment)}else{previous_assignment.after(existing_assignment)}previous_assignment=existing_assignment}if(jQuery.isArray(assignment.subtasks)&&assignment.subtasks.length){App.each(assignment.subtasks,function(subtask_id,subtask){var existing_assignment=tbody.find("tr.subtask[data-subtask-id="+subtask.id+"]");if(existing_assignment.length){update_assignment_row.apply(wrapper,[existing_assignment,subtask,assignment,labels,user_id,assignment])}else{var existing_assignment=$(render_assignment_row.apply(wrapper[0],[subtask,assignment,labels,user_id]))}if(previous_assignment===null){tbody.prepend(existing_assignment)}else{previous_assignment.after(existing_assignment)}previous_assignment=existing_assignment})}});if(previous_group===null){inner_wrapper.prepend(existing_group)}else{previous_group.after(existing_group)}existing_group.removeClass("marked");previous_group=existing_group}else{if(typeof(v.url)=="string"&&v.url){var group_label='<a href="'+App.clean(v.url)+'" class="quick_view_item">'+App.clean(v.label)+"</a>"}else{var group_label=App.clean(v.label)}var group='<table data-group-name="'+App.clean(k)+'" data-showing-more="0" class="common assignment_group" cellspacing="0"><thead><tr><th class="group_name" colspan="2">'+group_label+'</th><th class="right"><a href="#" class="toggle_group">'+App.lang("Hide")+"</a></th></tr></thead><tbody>";App.each(v.assignments,function(assignment_id,assignment){group+=assignment_to_row.apply(wrapper[0],[assignment,labels,user_id,true])});group+="</tbody></table>";if(previous_group===null){inner_wrapper.prepend(group)}else{previous_group.after(group)}previous_group=wrapper.find("table[data-group-name="+k+"]")}});inner_wrapper.find("table.assignment_group.marked").remove();inner_wrapper.find("table.assignment_group tr.assignment.marked").remove();collapse_long_groups.apply(wrapper[0]);wrapper.find("td.options time").dueOn();var object_tracking=wrapper.find("span.object_tracking");if(wrapper.data("canUseTracking")&&object_tracking){object_tracking.objectTime()}};var rebuild_late_assignments_from_map=function(map,labels){var wrapper=$(this);var late_assignments=wrapper.find("div.my_late_tasks");var list=late_assignments.find("ul").empty(),user_id=parseInt(wrapper.data("userId"));App.each(map,function(assignment_id,assignment){if(should_we_render(assignment,user_id)&&typeof(assignment.due_on)=="object"&&assignment.due_on){list.append('<li class="assignment task"><span class="object_type object_type_task">'+App.lang("Task #:task_id",{task_id:assignment.task_id})+'</span> <a href="'+App.clean(assignment.permalink)+'" class="quick_view_item">'+App.clean(assignment.name)+'</a> &middot; <time datetime="'+assignment.due_on["mysql"]+'" title="'+assignment.due_on["formatted_gmt"]+'">'+assignment.due_on["formatted_gmt"]+"</time></li>")}if(jQuery.isArray(assignment.subtasks)&&assignment.subtasks.length){App.each(assignment.subtasks,function(subtask_id,subtask){list.append('<li class="assignment subtask"><span class="object_type object_type_subtask">'+App.lang("Subtask")+'</span> <a href="'+App.clean(subtask.permalink)+'" class="quick_view_item">'+App.clean(subtask.body)+"</a> "+App.lang("in")+' <span class="object_type object_type_task">'+App.lang("Task #:task_id",{task_id:assignment.task_id})+'</span> <a href="'+App.clean(assignment.permalink)+'" class="quick_view_item">'+App.clean(assignment.name)+'</a>  &middot; <time datetime="'+subtask.due_on["mysql"]+'" title="'+subtask.due_on["formatted_gmt"]+'">'+subtask.due_on["formatted_gmt"]+"</time></li>")})}});if(list.find("li").length>0){late_assignments.show().find("time").dueOn()}else{late_assignments.hide()}};var assignment_to_row=function(assignment,labels,user_id,render_subtasks){var wrapper=$(this),result="";if(should_we_render(assignment,user_id)){result+=render_assignment_row.apply(wrapper[0],[assignment,null,labels,user_id])}if(render_subtasks&&jQuery.isArray(assignment.subtasks)&&assignment.subtasks.length){App.each(assignment.subtasks,function(subtask_id,subtask){result+=render_assignment_row.apply(wrapper[0],[subtask,assignment,labels,user_id])})}return result};var render_assignment_row=function(assignment,parent,labels,user_id){var wrapper=$(this);if(assignment.type=="Task"){var result='<tr class="assignment task" data-task-id="'+assignment.id+'">'}else{var result='<tr class="assignment subtask" data-task-id="'+parent.id+'" data-subtask-id="'+assignment.id+'">'}return result+'<td class="label right">'+render_priority(assignment.priority)+render_label(labels,assignment.label_id)+'</td><td class="name">'+render_name(assignment,parent,wrapper.data("taskCompleteUrl"),wrapper.data("taskReopenUrl"),wrapper.data("subtaskCompleteUrl"),wrapper.data("subtaskReopenUrl"),user_id)+'</td><td class="options right">'+render_options(assignment,parent,wrapper.attr("id"),(wrapper.data("canUseTracking")?wrapper.data("taskTrackingUrl"):""))+"</td></tr>"};var update_assignment_row=function(row,assignment,parent,labels,user_id){var wrapper=$(this);row.find("td.label").html(render_priority(assignment.priority)+render_label(labels,assignment.label_id));row.find("td.name").html(render_name(assignment,parent,wrapper.data("taskCompleteUrl"),wrapper.data("taskReopenUrl"),wrapper.data("subtaskCompleteUrl"),wrapper.data("subtaskReopenUrl"),user_id));var options_cell=row.find("td.options");if(typeof(assignment.due_on)=="object"&&assignment.due_on){var time=options_cell.find("time");if(time.length){if(time.attr("datetime")!=assignment.due_on["mysql"]){time.attr({datetime:assignment.due_on["mysql"],title:assignment.due_on["formatted_gmt"]}).data("dueOnInitialized",false).dueOn()}}else{$('<time datetime="'+assignment.due_on["mysql"]+'" title="'+App.clean(assignment.due_on["formatted_gmt"])+'">'+App.clean(assignment.due_on["formatted_gmt"])+"</time>").dueOn().prependTo(options_cell)}}else{options_cell.find("time").remove()}row.removeClass("marked")};var render_priority=function(priority_id){if(render_priority!=0){return App.Wireframe.Utils.renderPriority(priority_id,true)+" "}};var render_label=function(labels,label_id){return label_id&&typeof(labels[label_id])=="object"&&labels[label_id]?App.Wireframe.Utils.renderLabel(labels[label_id]):""};var render_name=function(assignment,parent,task_complete_url,task_reopen_url,subtask_complete_url,subtask_reopen_url,user_id){var is_task=assignment.type=="Task";if(is_task){var complete_url=task_complete_url.replace("--PROJECT-SLUG--",assignment.project_id).replace("--TASK-ID--",assignment.task_id),reopen_url=task_reopen_url.replace("--PROJECT-SLUG--",assignment.project_id).replace("--TASK-ID--",assignment.task_id)}else{var complete_url=task_complete_url.replace("--PROJECT-SLUG--",parent.project_id).replace("--TASK-ID--",parent.task_id).replace("--SUBTASK-ID--",assignment.id),reopen_url=task_reopen_url.replace("--PROJECT-SLUG--",parent.project_id).replace("--TASK-ID--",parent.task_id).replace("--SUBTASK-ID--",assignment.id)}var elements=[{element:"checkbox",content:'<img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/checkbox-unchecked.png","complete")+'" title="'+App.lang("Click to Complete")+'" data-is-completed="0" data-complete-url="'+complete_url+'" data-reopen-url="'+reopen_url+'">'}];if(is_task){elements.push({element:"object_type",content:{extra_class:"object_type_task",content:App.lang("Task #:task_id",{task_id:assignment.task_id})}})}else{elements.push({element:"object_type",content:{extra_class:"object_type_subtask",content:App.lang("Subtask")}})}if(is_task&&assignment.assignee_id!=user_id){elements.push({element:"someone_else_is_responsible",content:{title:App.lang("You are assigned to this task")+". "+App.lang(":name is responsible",{name:assignment.assignee}),content:App.clean(assignment.assignee)}})}if(is_task){elements.push({element:"assignment_name",content:'<a href="'+App.clean(assignment.permalink)+'" class="quick_view_item">'+App.clean(assignment.name)+"</a>"})}else{elements.push({element:"assignment_name",content:'<a href="'+App.clean(assignment.permalink)+'" class="quick_view_item">'+App.clean(assignment.body)+"</a> "+App.lang("in")+' <span class="object_type object_type_task">'+App.lang("Task #:task_id",{task_id:parent.task_id})+'</span> <a href="'+App.clean(parent.permalink)+'" class="quick_view_item">'+App.clean(parent.name)+"</a>"})}var result="";App.each(elements,function(k,v){var element_name=v.element,value=v.content;if(value===null){return}var classes=["my_tasks_name_element",element_name];if(typeof(value)=="object"&&value){if(typeof(value.extra_class)&&value.extra_class){classes.push(value.extra_class)}var title=typeof(value.title)&&value.title?' title="'+value.title+'"':"";var content=typeof(value.content)&&value.content?value.content:""}else{var title="",content=value}result+='<span class="'+classes.join(" ")+'"'+title+">"+content+"</span> "});return result};var render_options=function(assignment,parent,wrapper_id,tracking_url){var result="";if(typeof(assignment.due_on)=="object"&&assignment.due_on){result+='<time datetime="'+assignment.due_on["mysql"]+'" title="'+App.clean(assignment.due_on["formatted_gmt"])+'">'+App.clean(assignment.due_on["formatted_gmt"])+"</time>"}if(typeof(tracking_url)=="string"&&tracking_url){if(assignment.type=="Task"){result+='<span class="object_tracking" id="'+wrapper_id+"_object_time_for_"+assignment.id+'" data-estimated-time="'+(assignment.estimated_time?assignment.estimated_time:0)+'" data-object-time="'+(assignment.tracked_time?assignment.tracked_time:0)+'" data-object-expenses="0" data-show-label="0"><a href="'+tracking_url.replace("--PROJECT-SLUG--",assignment.project_id).replace("--TASK-ID--",assignment.task_id)+'"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/object-time-inactive.png","tracking")+'"></a></span>'}else{result+='<span class="object_tracking" id="'+wrapper_id+"_object_time_for_"+parent.id+"_and_"+assignment.id+'" data-estimated-time="'+(parent.estimated_time?parent.estimated_time:0)+'" data-object-time="'+(parent.tracked_time?parent.tracked_time:0)+'" data-object-expenses="0" data-show-label="0"><a href="'+tracking_url.replace("--PROJECT-SLUG--",parent.project_id).replace("--TASK-ID--",parent.task_id)+'"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/object-time-inactive.png","tracking")+'"></a></span>'}}return result};var should_we_render=function(assignment,user_id){return assignment.assignee_id==user_id||(jQuery.isArray(assignment.other_assignees)&&assignment.other_assignees.indexOf(user_id)>-1)};var show_per_group=function(){var show_per_group=parseInt($(this).data("autoShowPerGroup"));return isNaN(show_per_group)||show_per_group<1?15:show_per_group};var collapse_long_groups=function(){var wrapper=$(this);var show=show_per_group.apply(wrapper[0]);wrapper.find("table.assignment_group").each(function(){var group=$(this);var tbody=group.find("tbody");var total_assignments=tbody.find("tr.assignment").length;if(total_assignments>show){tbody.find("tr.assignment:lt("+show+")").removeClass("more_assignments").show();var more_assignments=tbody.find("tr.assignment:gt("+(show-1)+")").addClass("more_assignments");if(!group.data("showingMore")){more_assignments.hide()}var show_more_assignments=tbody.find("tr.show_more_assignments");if(show_more_assignments.length<1){tbody.append('<tr class="show_more_assignments"><td class="label"></td><td colspan="2"><a href="#">'+App.lang("Showing first :num assignments. Click here to show all :total",{num:show,total:total_assignments})+"</a></td></tr>")}else{if(!group.data("showingMore")){show_more_assignments.find("a").text(App.lang("Showing first :num assignments. Click here to show all :total",{num:show,total:total_assignments}))}}}})};var plugin_name="myTasks";$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);