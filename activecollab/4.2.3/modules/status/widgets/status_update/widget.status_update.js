(function($){var plugin_name="statusUpdate";var settings={add_message_url:null,msg_max_length:255};var public_methods={init:function(options){return this.each(function(){this.su_variables={};this.su_variables.settings=$.extend({},settings,options||{});initialize_initial_status_updates.apply(this);initialize_status_update_form.apply(this);initialize_reply_forms.apply(this);init_delete_links.apply(this);init_events.apply(this)})}};var initialize_initial_status_updates=function(){var wrapper=$(this);var wrapper_dom=this;var status_update_table=wrapper.find("#status_updates_table");var status_update_table_wrapper=status_update_table.parents(".table_wrapper:first");if(this.su_variables.settings.status_updates){$.each(this.su_variables.settings.status_updates,function(index,status_update){status_update_table.append(render_status_update.apply(wrapper_dom,[status_update]))})}};var init_events=function(){var wrapper_dom=this;var wrapper=$(this);var event_scope=wrapper.parents(".context_popup:first").length?"context_popup":"single";App.Wireframe.Events.bind("status_update_created."+event_scope,function(event,status_update){var status_update_table=wrapper.find("#status_updates_table");var status_update_table_wrapper=status_update_table.parents(".table_wrapper:first");if(!status_update.parent_id){var row=render_status_update.apply(wrapper_dom,[status_update]);var status_update_id=row.attr("status_update_id");var textarea=wrapper.find("#add_status_message textarea").focus();status_update_table.find("tr[status_update_id="+status_update_id+"]").remove();status_update_table.prepend(row);row.css({opacity:0}).animate({opacity:1},{duration:1000});status_update_table_wrapper.show().scrollTo(0);textarea.val("").focus()}else{var row=render_status_update_reply.apply(wrapper_dom,[status_update]);var parent_id=row.attr("parent_id");var update_row=status_update_table.find('tr.status_update[status_update_id="'+parent_id+'"]');var textarea_row=update_row.find("tr.status_update_reply_textarea:first");var anchor=update_row.find("a.add_reply");var updates_table=update_row.parents("table").find("tbody:first");textarea_row.before(row).hide();anchor.show();if(update_row.prev("tr").length){update_row.detach().prependTo(updates_table);update_row.css({opacity:0}).animate({opacity:1},{duration:1000})}}});App.Wireframe.Events.bind("status_update_deleted."+event_scope,function(event,status_update){wrapper.find('tr.status_update[status_update_id="'+status_update.id+'"], tr.status_update_reply[status_update_id="'+status_update.id+'"]').remove()})};var initialize_status_update_form=function(){var wrapper=$(this);var textarea=wrapper.find("#add_status_message textarea").focus();initialize_input_control.apply(wrapper[0],[textarea,false,function(response){if(response){App.Wireframe.Events.trigger("status_update_created",[response])}else{textarea.focus();App.Wireframe.Flash.error(App.lang("We are sorry, but system failed to save your status message. Please try again later."))}},function(){textarea.focus()}])};var initialize_reply_forms=function(row){var wrapper=$(this);wrapper.delegate("a.add_reply","click",function(){var anchor=$(this).hide();var update_row=anchor.parents("tr.status_update:first");var updates_table=update_row.parents("table").find("tbody:first");var textarea_row=anchor.parents("tr:first").find(".status_update_reply_textarea:first").show();var textarea=textarea_row.find("textarea:first");initialize_input_control.apply(wrapper[0],[textarea,anchor.attr("status_message_id"),function(response){if(response){App.Wireframe.Events.trigger("status_update_created",[response])}else{App.Wireframe.Flash.error(App.lang("We are sorry, but system failed to save your status message. Please try again later."))}},function(){textarea_row.blur().hide();anchor.show()}]);textarea.focus();return false})};var initialize_input_control=function(field,related_status,on_response,on_cancel){var wrapper=$(this);var wrapper_dom=this;if(field.is("initialized")){return false}field.addClass("initialized");field.maxlength();field.keyup(function(){check_length.apply(wrapper[0],[field])});field.keydown(function(event){var field_value=$.trim(field.val());if(event.keyCode==13){if(field.is(".in_processing")){return false}}else{if(event.keyCode==27){if(field_value&&!confirm("Are you sure that you want to abandon all changes")){return false}if(on_cancel&&typeof(on_cancel)=="function"){on_cancel.apply(wrapper[0],[])}if((field.parents("#add_status_message:first").length&&field.val())||!field.parents("#add_status_message:first").length){field.val("");event.stopPropagation();event.stopImmediatePropagation();return false}return true}else{return true}}if(!field_value){return false}field.addClass("in_processing");var data={submitted:"submitted",status_update:{message:field_value}};if(related_status){data.status_update["parent_id"]=related_status}field.blur().attr("disabled",true);var indicator=$('<img src="'+App.Wireframe.Utils.indicatorUrl()+'" class="in_progress_indicator" />').insertAfter(field);$.ajax({url:wrapper_dom.su_variables.settings.add_message_url,type:"POST",data:data,success:function(response){field.removeClass("in_processing").val("").attr("disabled",false).focus();field.parent().find(".status_counter").text("");indicator.remove();if(on_response&&typeof(on_response)=="function"){on_response.apply(wrapper[0],[response])}},error:function(response){field.removeClass("in_processing").attr("disabled",false).focus();indicator.remove();if(on_response&&typeof(on_response)=="function"){on_response.apply(wrapper[0],[])}}})})};var init_delete_links=function(){$(this).delegate("span.delete_status_reply a, span.delete_status a","click",function(){var anchor=$(this);var message="";if(anchor.parents(".delete_status:first").length){message=App.lang("Are you sure that you want to delete this message?")}else{message=App.lang("Are you sure that you want to delete this reply?")}if(!confirm(message)){return false}$.ajax({url:anchor.attr("href"),type:"POST",data:{submitted:"submitted"},success:function(response){App.Wireframe.Events.trigger("status_update_deleted",[response])},error:function(){App.Wireframe.Flash.error(App.lang("We are sorry, but the system failed to delete the selected status update"))}});return false})};var render_status_update=function(status_update){var wrapper_dom=this;var result='<tr class="status_update" status_update_id="'+status_update.id+'"><td class="avatar"><img src="'+status_update.created_by["avatar"]["large"]+'" alt="" /></td><td class="message"><div class="message_and_replies"><div class="message_wrapper"><span class="delete_status is_first">'+(status_update.permissions["can_delete"]?'<a href="'+status_update.urls["delete"]+'"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/delete.png","environment")+'" /></a>':"")+'&nbsp;</span><div class="author"><a href="'+status_update.created_by["urls"]["view"]+'" class="author">'+App.excerpt(status_update.created_by["short_display_name"],10)+'</a></div><span class="date">'+status_update.created_on["formatted_date"]+'</span><div class="message">'+status_update.message_clickable+'</div></div><div class="status_update_replies"><table class="status_update_replies" cellspacing="0"><tr class="status_update_reply_textarea" style="display:none;"><td class="reply_author"><a href="'+App.clean(wrapper_dom.su_variables.settings.logged_user.urls.view)+'">'+App.clean(wrapper_dom.su_variables.settings.logged_user.short_display_name)+'</a></td><td class="reply_message"><div class="reply_field_wrapper"><textarea placeholder="'+App.lang("Type your reply and hit Enter to post it")+'" maxlength="255"></textarea><div class="details status_counter"></div></div></td></tr></table><a href="#" class="add_reply" status_message_id="'+status_update.id+'">'+App.lang("Click here to add reply")+"</a></div></div></td></tr>";var result=$(result);if(status_update.replies){var target_row=result.find("tr.status_update_reply_textarea:first");$.each(status_update.replies,function(index,status_update_reply){target_row.before(render_status_update_reply.apply(wrapper_dom,[status_update_reply]))})}return result};var render_status_update_reply=function(status_update){var wrapper=$(this);var result='<tr class="status_update_reply" id="status_update_reply_'+status_update.id+'" parent_id="'+status_update.parent_id+'" status_update_id="'+status_update.id+'"><td class="reply_author"><a href="'+status_update.created_by["urls"]["view"]+'">'+App.excerpt(status_update.created_by["short_display_name"],10)+'</a></td><td class="reply_message"><div class="reply_message_wrapper"><span class="date">'+status_update.created_on["formatted_date"]+'</span><span class="reply_message_itself">'+status_update.message_clickable+'</span><span class="delete_status_reply">'+(status_update.permissions["can_delete"]?'<a href="'+status_update.urls["delete"]+'"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/delete.png","environment")+'" /></a>':"")+"</span></div></td></tr>";return $(result)};var check_length=function(field){var left=this.su_variables.settings.msg_max_length-field.val().length;var status_counter=field.parent().find(".status_counter");if(left<0){left=0;field.val(field.val().substring(0,this.su_variables.settings.msg_max_length));status_counter.animate({color:"red"},"fast");status_counter.animate({color:"#333"},"fast")}status_counter.text(left)};$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on jQuery.statusUpdate")}}}})(jQuery);