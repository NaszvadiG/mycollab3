/* Minified: main.js, functions.js, inspector.renderers.Project.js, inspector.widgets.MilestoneProgressbar.js, jquery.quickAdd.js, mainMenu.handlers.profile_menu.js, mainmenu.handlers.projects_menu.js */
App.Wireframe["Utils"]["dataFilters"]["prepareSelectUsers"]=function(submit_as,criterion,filter,data,get_name,get_value){if(data.users){var name=get_name(criterion);var selected_user_ids=get_value(filter,criterion);var select=$('<div class="assignments_filter_'+criterion+'"></div>');var select_html='<div class="assignments_filter_'+criterion+'">';App.each(data.users,function(company_name,users){select_html+='<div class="tracking_report_select_users_company"><div class="company_name">'+App.clean(company_name)+'</div><div class="company_users">';App.each(users,function(user_id,user_name){var id="assignments_filter_"+criterion+"_"+user_id;var checked=jQuery.isArray(selected_user_ids)&&selected_user_ids.indexOf(parseInt(user_id))>=0?" checked":"";select_html+='<div class="company_user"><input type="checkbox" name="'+submit_as+"["+name+'][]" value="'+user_id+'" id="'+id+'" '+checked+'> <label for="'+id+'">'+App.clean(user_name)+"</label></div>"});select_html+="</div></div>"});$(this).append(select_html+"</div>")}else{$(this).text(App.lang("There are no users to select from"))}};App.Wireframe["Utils"]["dataFilters"]["prepareSelectCompany"]=function(submit_as,criterion,filter,data,get_name,get_value){if(data.companies){var selected_company_id=get_value(filter,criterion);var select_html='<select name="'+submit_as+"["+get_name(criterion)+']">';App.each(data.companies,function(company_id,company_name){select_html+='<option value="'+company_id+'" '+(company_id==selected_company_id?"selected":"")+">"+App.clean(company_name)+"</option>"});$(this).append(select_html+"</select>")}else{$(this).text(App.lang("There are no companies to select from"))}};App.Wireframe["Utils"]["dataFilters"]["prepareSelectProjects"]=function(submit_as,criterion,filter,data){if(data.projects){var selected_project_ids=typeof(filter)=="object"&&filter&&filter.project_ids?filter.project_ids:null;var select='<div class="time_report_'+criterion+'">';var active_projects_html="";var active_project_ids=[];if(typeof(data.active_projects)!="undefined"){App.each(data.active_projects,function(project_id,project_name){active_project_ids.push(project_id);var id="time_report_"+criterion+"_"+project_id;var checked=jQuery.isArray(selected_project_ids)&&selected_project_ids.indexOf(parseInt(project_id))>=0?"checked":"";active_projects_html+='<div class="project"><input type="checkbox" name="'+submit_as+'[project_ids][]" value="'+project_id+'" id="'+id+'" '+checked+'> <label for="'+id+'">'+App.clean(project_name)+"</label></div>"})}var other_projects_html="";App.each(data.projects,function(project_id,project_name){if(active_project_ids.length==0||active_project_ids.indexOf(project_id)==-1){var id="time_report_"+criterion+"_"+project_id;var checked=jQuery.isArray(selected_project_ids)&&selected_project_ids.indexOf(parseInt(project_id))>=0?"checked":"";other_projects_html+='<div class="project"><input type="checkbox" name="'+submit_as+'[project_ids][]" value="'+project_id+'" id="'+id+'" '+checked+'> <label for="'+id+'">'+App.clean(project_name)+"</label></div>"}});if(active_projects_html&&other_projects_html){$(this).append('<div class="time_report_'+criterion+'">'+active_projects_html+'<div class="italic" style="border-top: 1px dotted #ccc; margin-top: 2px; padding-top: 2px;">'+other_projects_html+"</div></div>")}else{if(active_projects_html){$(this).append('<div class="time_report_'+criterion+'">'+active_projects_html+"</div>")}else{if(other_projects_html){$(this).append('<div class="time_report_'+criterion+'">'+other_projects_html+"</div>")}else{$(this).append('<div class="time_report_'+criterion+'">'+App.lang("There are no projects to select from")+"</div>")}}}}else{$(this).text(App.lang("There are no projects to select from"))}};App.Wireframe["Utils"]["dataFilters"]["prepareSelectProjectCategory"]=function(submit_as,criterion,filter,data){if(data.project_categories){var selected_category_id=typeof(filter)=="object"&&filter&&filter.project_category_id?filter.project_category_id:null;var select_html='<select name="'+submit_as+'[project_category_id]">';App.each(data.project_categories,function(project_category_id,project_category_name){select_html+='<option value="'+project_category_id+'" '+(project_category_id==selected_category_id?"selected":"")+">"+App.clean(project_category_name)+"</option>"});$(this).append(select_html+"</select>")}else{$(this).append(App.lang("There are no project categories to select from"))}};App.Wireframe["Utils"]["dataFilters"]["prepareSelectMilestones"]=function(submit_as,criterion,filter,data,get_name,get_value){var options=[];if(typeof(data.milestones)!="undefined"){App.each(data.milestones,function(k,v){options.push(v)})}var picker_wrapper=$('<div class="autocomplete_wrapper"></div>').appendTo(this);var picker=$('<input type="text" name="'+submit_as+"["+get_name(criterion)+']">').appendTo(picker_wrapper).attr("value",get_value(filter,criterion)).focus();picker.multicomplete({source:options,appendTo:picker_wrapper,position:{my:"left bottom",at:"left bottom",of:picker}});picker_wrapper.width(picker.width())};App.Wireframe.PageTitle.recalculateHeight=function(){var wireframe_content=$("#wireframe_content");var wireframe_title=$("#wireframe_page_title");if(wireframe_content.parents(".list_mode").length){var object_list_details=wireframe_content.find(".objects_list_details");object_list_details.css("top",wireframe_title.outerHeight()+"px");wireframe_content.css("paddingTop",wireframe_title.height()+"px");wireframe_content.css("top","0px")}else{wireframe_content.css("top",wireframe_title.outerHeight()+"px");wireframe_content.css("paddingTop","0px")}};App.Wireframe.PageTitle.recalculateWidth=function(){var wireframe_title_wrapper=$("#wireframe_page_title");var wireframe_title=wireframe_title_wrapper.find("#page_title");var wireframe_title_options=wireframe_title_wrapper.find("ul#page_title_actions");if(wireframe_title_options.length){wireframe_title.css("width",wireframe_title_wrapper.width()-wireframe_title_options.outerWidth())}};App.Wireframe.PageTitle._old_set=App.Wireframe.PageTitle.set;App.Wireframe.PageTitle.set=function(value){App.Wireframe.PageTitle._old_set(value);App.Wireframe.PageTitle.recalculateHeight()};App.Wireframe.PageTitle._old_addAction=App.Wireframe.PageTitle.addAction;App.Wireframe.PageTitle.addAction=function(name,action,class_name){App.Wireframe.PageTitle._old_addAction(name,action,class_name);App.Wireframe.PageTitle.recalculateWidth();App.Wireframe.PageTitle.recalculateHeight()};App.Wireframe.PageTitle._old_addDropDown=App.Wireframe.PageTitle.addDropDown;App.Wireframe.PageTitle.addDropDown=function(name,title,content){App.Wireframe.PageTitle._old_addDropDown(name,title,content);App.Wireframe.PageTitle.recalculateWidth();App.Wireframe.PageTitle.recalculateHeight()};App.Wireframe.Events.bind("window_resize",function(){App.Wireframe.PageTitle.recalculateWidth();App.Wireframe.PageTitle.recalculateHeight()});App.Wireframe.PageTitle._old_snapshot=App.Wireframe.PageTitle.snapshot;App.Wireframe.PageTitle.snapshot=function(snapshot){var result=App.Wireframe.PageTitle._old_snapshot(snapshot);if(snapshot!==undefined){App.Wireframe.PageTitle.recalculateWidth()}return result};
App.objects_list_keep_companies_map_up_to_date=function(objects_list,field_id,scope,detailed){if(!detailed){App.Wireframe.Events.bind("company_created"+(scope?"."+scope:""),function(event,company){objects_list.objectsList("grouping_map_add_item",field_id,company.id,company.name)});App.Wireframe.Events.bind("company_updated"+(scope?"."+scope:""),function(event,company){objects_list.objectsList("grouping_map_update_item",field_id,company.id,company.name)})}else{App.Wireframe.Events.bind("company_created"+(scope?"."+scope:""),function(event,company){objects_list.objectsList("grouping_map_add_item",field_id,company.id,{name:company.name,permalink:company.permalink,is_archived:company.state==2?1:0,icon:company.avatar?company.avatar.small:""})});App.Wireframe.Events.bind("company_updated"+(scope?"."+scope:""),function(event,company){objects_list.objectsList("grouping_map_update_item",field_id,company.id,{name:company.name,permalink:company.permalink,is_archived:company.state==2?1:0,icon:company.avatar?company.avatar.small:""})})}App.Wireframe.Events.bind("company_deleted"+(scope?"."+scope:""),function(event,company){if(company.users!==null&&company.users.length){$.each(company.users,function(index,user){objects_list.objectsList("delete_item",user.id)})}objects_list.objectsList("grouping_map_delete_item",field_id,company.id)})};App.objects_list_keep_milestones_map_up_to_date=function(objects_list,field_id,project_id){App.Wireframe.Events.bind("milestone_created.content",function(event,milestone){if(milestone.project_id==project_id){objects_list.objectsList("grouping_map_add_item",field_id,milestone.id,milestone.name)}});App.Wireframe.Events.bind("milestone_updated.content",function(event,milestone){if(milestone.project_id==project_id){objects_list.objectsList("grouping_map_update_item",field_id,milestone.id,milestone.name)}});App.Wireframe.Events.bind("milestone_deleted.content",function(event,milestone){if(milestone.project_id=project_id){objects_list.objectsList("grouping_map_delete_item",field_id,milestone.id)}})};
App.Inspector.Renderers.Project=function(wrapper_dom,client_interface){var wrapper=$(wrapper_dom);var project_overview_structure='<div class="project_overview_box"><div class="project_overview_box_title"><h2><table cellspacing="0"><tbody><tr><td class="project_icon"><div class="project_overview_icon"></div></td><td class="project_name object_name_content"></td><td class="links"><div class="project_links"><ul></ul></div></td></tr></tbody></table></h2></div><div class="project_overview_box_content"><div class="project_overview_box_content_inner"><div class="bars_wrapper"></div><div class="project_description object_body_content"></div><div class="project_meta"><dl></dl></div></div></div></div>';wrapper.append(project_overview_structure);wrapper_dom.insp_data.properties=wrapper.find("div.project_overview_box_content div.project_meta");wrapper_dom.insp_data.widgets=wrapper.find("div.project_overview_box_title div.project_overview_icon");wrapper_dom.insp_data.indicators=wrapper.find("div.project_links ul");wrapper_dom.insp_data.bars_wrapper=wrapper.find("div.bars_wrapper")};
App.Inspector.Widgets.MilestoneProgressbar=function(object,client_interface){var wrapper=$(this);var check_string=object.open_tasks+"."+object.completed_tasks;if(wrapper.attr("check_string")==check_string){return true}wrapper.attr("check_string",check_string);wrapper.empty();var progress=object.percents_done;var pie_chart=$('<div class="milestone_progressbar"></div>').appendTo(wrapper);if(object.percents_done>=100){var image_file=App.Wireframe.Utils.imageUrl("layout/milestones/milestone-progressbar-32.png","system")}else{if(!object.percents_done){var image_file=App.Wireframe.Utils.imageUrl("layout/milestones/milestone-progressbar-0.png","system")}else{var image_file=App.Wireframe.Utils.imageUrl("layout/milestones/milestone-progressbar-"+Math.floor(32*progress/100)+".png","system")}}pie_chart.append('<img src="'+image_file+'" />');pie_chart.append('<div class="progress_label">'+progress+"%</div>");wrapper.append(App.lang(":completed of :total tasks completed",{completed:object.completed_tasks,total:object.total_tasks}))};
(function($){var public_methods={init:function(options){return this.each(function(){var list_item=$(this);var anchor=list_item.find("a:first");var settings=jQuery.extend({data_url:anchor.attr("href"),title:App.lang("Quick Add")},options,global_options);list_item.data("settings",settings);if(settings.data){list_item.data("data",settings.data);display_popup.apply(list_item[0])}else{load_data.apply(list_item[0])}listen_events.apply(list_item[0])})}};var listen_events=function(){var anchor=this;var events=$(this).data("settings").events;var formated_events=[];$.each(events,function(index,event){formated_events.push(event+".statusbar")});App.Wireframe.Events.bind(formated_events.join(" "),function(event,object){load_data.apply(anchor)})};var display_popup=function(){var list_item=$(this);var list_item_dom=this;var settings=list_item.data("settings");list_item.unbind();list_item.contextPopup({id:"quick_add_popup",title:settings.title,autoClose:true,data:function(){return render_dialog.apply(list_item[0])},success:function(){settings.main_item=null;App.Wireframe.Events.bind("keydown.context_popup",function(event){var key_code=event.which;if(key_code=="39"){arrow_right.apply(list_item_dom);return false}else{if(key_code=="37"){arrow_left.apply(list_item_dom);return false}else{if(key_code=="38"){arrow_up.apply(list_item_dom);return false}else{if(key_code=="40"){arrow_down.apply(list_item_dom);return false}else{if(key_code=="13"||key_code=="32"){enter_key.apply(list_item_dom);return false}else{if(key_code>=65&&key_code<=122){char_press.apply(list_item_dom,[String.fromCharCode(key_code)]);return false}}}}}}})}})};var arrow_right=function(){var trigger=$(this);var settings=trigger.data("settings");var popup=settings.popup;if(!popup.is(".subitems")){var current_item=popup.find("div.quick_add_item a.current");var next_item=current_item.parents("div.quick_add_item:first").next("div.quick_add_item:first").find("a");if(!next_item.length){var next_group=current_item.parents("div.quick_add_item_group").next("div.quick_add_item_group");if(next_group.length){next_item=next_group.find("div.quick_add_item:first a")}}if(next_item.length){current_item.removeClass("current");next_item.addClass("current");settings.main_item=next_item.attr("item_id")}}else{}};var arrow_left=function(){var trigger=$(this);var settings=trigger.data("settings");var popup=settings.popup;if(!popup.is(".subitems")){var current_item=popup.find("div.quick_add_item a.current");var previous_item=current_item.parents("div.quick_add_item:first").prev("div.quick_add_item:first").find("a");if(!previous_item.length){var previous_group=current_item.parents("div.quick_add_item_group").prev("div.quick_add_item_group");if(previous_group.length){previous_item=previous_group.find("div.quick_add_item:last a")}}if(previous_item.length){current_item.removeClass("current");previous_item.addClass("current");settings.main_item=previous_item.attr("item_id")}}else{popup.find("a.quick_add_back:first").click()}};var arrow_up=function(){var trigger=$(this);var settings=trigger.data("settings");var popup=settings.popup;if(!popup.is(".subitems")){var item_width=popup.find("div.quick_add_item:first").width();var items_per_row=Math.floor(popup.width()/item_width);var current_item=popup.find("div.quick_add_item a.current");var current_index=current_item.parents("div.quick_add_item:first").prevAll("div.quick_add_item").length;var current_group=current_item.parents("div.quick_add_item_group");var current_group_items=current_group.find("div.quick_add_item");var up_item=null;var up_index=current_index-items_per_row;if(up_index>=0){var up_item=current_group_items.eq(up_index).find("a")}if(!up_item||!up_item.length){var previous_group=current_group.prev("div.quick_add_item_group");if(previous_group.length){var previous_group_items=previous_group.find("div.quick_add_item");var current_in_row=current_index%items_per_row;var max_rows=Math.ceil(previous_group_items.length/items_per_row);var previous_index=((max_rows-1)*items_per_row)+current_in_row;up_item=previous_group_items.eq(previous_index).find("a");if(!up_item.length){up_item=previous_group_items.eq(previous_group_items.length-1).find("a")}}}if(up_item&&up_item.length){current_item.removeClass("current");up_item.addClass("current");settings.main_item=up_item.attr("item_id")}}else{var current_subitem=popup.find("li.quick_add_subitem.current");var previous_subitem=current_subitem.prev("li.quick_add_subitem");if(previous_subitem.length){current_subitem.removeClass("current");previous_subitem.addClass("current")}}};var arrow_down=function(){var trigger=$(this);var settings=trigger.data("settings");var popup=settings.popup;if(!popup.is(".subitems")){var item_width=popup.find("div.quick_add_item:first").width();var items_per_row=Math.floor(popup.width()/item_width);var current_item=popup.find("div.quick_add_item a.current");var current_index=current_item.parents("div.quick_add_item:first").prevAll("div.quick_add_item").length;var current_group=current_item.parents("div.quick_add_item_group");var current_group_items=current_group.find("div.quick_add_item");var current_row=Math.ceil((current_index+1)/items_per_row);var max_rows=Math.ceil(current_group_items.length/items_per_row);var down_item=current_group_items.eq(current_index+items_per_row).find("a");if(!down_item.length){if(current_row<max_rows){down_item=current_group_items.eq(current_group_items.length-1).find("a")}}if(!down_item.length){var next_group=current_group.next("div.quick_add_item_group");if(next_group.length){down_item=next_group.find("div.quick_add_item:eq("+(current_index%items_per_row)+") a");if(!down_item.length){down_item=next_group.find("div.quick_add_item:last a")}}}if(down_item.length){current_item.removeClass("current");down_item.addClass("current");settings.main_item=down_item.attr("item_id")}}else{var current_subitem=popup.find("li.quick_add_subitem.current");var next_subitem=current_subitem.next("li.quick_add_subitem");if(next_subitem.length){current_subitem.removeClass("current");next_subitem.addClass("current")}}};var enter_key=function(){var trigger=$(this);var popup=trigger.data("settings").popup;if(!popup.is(".subitems")){popup.find("div.quick_add_item a.current").click()}else{popup.find("li.quick_add_subitem.current a").click()}};var char_press=function(character){var trigger_dom=this;var trigger=$(this);var popup=trigger.data("settings").popup;if(!this.search_query){this.search_query=""}this.search_query=this.search_query+character.toLowerCase();if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(function(){trigger_dom.search_query=""},500);if(!popup.is(".subitems")){var query_item=popup.find('div.quick_add_item[query_index*="'+trigger_dom.search_query+'"]:first a');if(query_item.length){var current_item=popup.find("div.quick_add_item a.current");current_item.removeClass("current");query_item.addClass("current")}}else{var query_item=popup.find('li.quick_add_subitem[query_index*="'+trigger_dom.search_query+'"]:first');if(query_item.length){var current_item=popup.find("li.quick_add_subitem.current");current_item.removeClass("current");query_item.addClass("current")}}};var render_dialog=function(){var list_item=$(this);var data=list_item.data("data");var settings=list_item.data("settings");var wrapper=$('<div class="quick_add_wrapper"></div>');var items_list=$('<div class="quick_add_items"></div>').appendTo(wrapper);var items;var subitems;var map;var has_subitems;items=data.items;map=data.map;var rendered_items={};for(var item_id in items){if(rendered_items[items[item_id]["group"]]===undefined){rendered_items[items[item_id]["group"]]=""}has_subitems=map[item_id]?true:false;rendered_items[items[item_id]["group"]]+='<div class="quick_add_item" query_index="'+App.clean(items[item_id]["title"].toLowerCase())+'"><a href="'+(!has_subitems?items[item_id]["url"]:"#")+'" item_id="'+item_id+'" title="'+App.clean(items[item_id]["title"])+'"><img src="'+items[item_id]["icon"]+'"><span class="label">'+App.clean(items[item_id]["text"])+"</span></a></div>"}var rendered="";var counter=0;for(var item_id in rendered_items){rendered+='<div class="quick_add_item_group '+item_id+" "+(counter%2?"odd":"even")+'">'+rendered_items[item_id]+"</div>";counter++}items_list.append(rendered);items_list.delegate("a","click",function(event){var anchor=$(this);var current_item_id=anchor.attr("item_id");if(anchor.attr("href")=="#"){render_subitems.apply(list_item[0],[wrapper,current_item_id,items[current_item_id]])}else{var handler_settings={success_event:items[current_item_id]["event"]?items[current_item_id]["event"]:null,success_message:App.lang(":item has been created successfully",{item:items[current_item_id]["text"]}),stop_propagation:true};if(items[current_item_id]["handler_settings"]&&typeof(items[current_item_id]["handler_settings"])=="object"){handler_settings=$.extend(handler_settings,items[current_item_id]["handler_settings"])}if(items[current_item_id]["handler_type"]){anchor[items[current_item_id]["handler_type"]](handler_settings);anchor.click()}else{App.Delegates.flyoutFormClick.apply(anchor[0],[event,handler_settings])}list_item.contextPopup("close")}return false});settings.popup=wrapper;settings.popup.removeClass("subitems");$("input:focus, textarea:focus, select:focus").blur();if(!settings.main_item){settings.main_item=items_list.find(".quick_add_item:first a").attr("item_id")}settings.popup.find('a[item_id="'+settings.main_item+'"]').addClass("current");return wrapper};var get_subitem_url=function(base_url,replacements){if(!typeof(replacements)=="array"&&replacements.length<1){return base_url}for(var replacement_key in replacements){base_url=base_url.replace(replacement_key,replacements[replacement_key])}return base_url};var render_subitems=function(wrapper,item_id,main_item){var list_item=$(this);var data=list_item.data("data");var settings=list_item.data("settings");var map_subitems=data.map[item_id];var subitems=data.subitems;var item=data.items[item_id];settings.popup.addClass("subitems");var subitems_header=$('<div class="quick_add_subitems_header"><img src="'+item.icon+'" />'+item.title+"</div>");var back_to_items=$('<a href="#" class="quick_add_back">'+App.lang("Back")+"</a>").prependTo(subitems_header);back_to_items.click(function(){wrapper.empty().after(render_dialog.apply(list_item[0]));wrapper.remove();list_item.contextPopup("reposition");return false});var subitem;var rendered_subitems='<ul class="quick_add_subitems context_popup_scrollable">';$.each(map_subitems,function(subitem_id){subitem=subitems[map_subitems[subitem_id]];rendered_subitems+='<li class="quick_add_subitem" query_index="'+App.clean(subitem.text.toLowerCase())+'"><a href="'+get_subitem_url(item.url,subitem.url_replacements)+'" title="'+(item.dialog_title?App.clean(item.dialog_title.replace(":name",subitem.text)):App.clean(item.title))+'"><img src="'+subitem.icon+'" />'+App.clean(subitem.text)+"</a></li>"});rendered_subitems+="</ul>";var quick_add_subitems=$(rendered_subitems);quick_add_subitems.find("li:first").addClass("current");wrapper.empty().append(subitems_header).append(quick_add_subitems);quick_add_subitems.delegate("a","click",function(event){var anchor=$(this);var handler_settings={success_event:item.event?item.event:null,success_message:App.lang(":item has been created successfully",{item:item.text}),stop_propagation:true};if(main_item.handler_settings&&typeof(main_item.handler_settings)=="object"){handler_settings=$.extend(handler_settings,main_item.handler_settings)}if(main_item.handler_type){anchor[main_item.handler_type](handler_settings);anchor.click()}else{App.Delegates.flyoutFormClick.apply(anchor[0],[event,handler_settings])}list_item.contextPopup("close");return false});list_item.contextPopup("reposition")};var load_data=function(){var list_item=$(this);var url=list_item.data("settings").data_url;$.ajax({url:url,type:"POST",cache:true,success:function(response){list_item.data("data",response);display_popup.apply(list_item[0])}})};var plugin_name="quickAdd";var global_options={events:["company_created","company_updated","company_deleted","project_created","project_updated","project_deleted","project_people_created","project_people_updated","projects_settings_updated","projects_mass_updated","role_created","role_updated","role_deleted","project_role_created","project_role_updated","project_role_deleted","user_added_to_project"]};$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);
App.Wireframe.MainMenu.handlers.register("profile_menu","profile",function(popup_dom){popup_dom.body.addClass("profile_menu_popup");var user=popup_dom.settings["additional"]["user"];var user_dom={};user_dom.name=popup_dom.header_title;user_dom.group=$('<div class="menu_navigation_group profile_menu_popup_user_details"></div>').appendTo(popup_dom.body);user_dom.profile=$('<div class="profile_menu_popup_profile_link menu_navigation_row grouped_popup_buttons"></div>').appendTo(user_dom.group);user_dom.btn_profile_link=$('<a href="'+user.urls["view"]+'" class="menu_navigation_item grouped_popup_button" title="'+App.lang(":username profile",{username:user.display_name})+'">'+App.lang(":username profile",{username:user.display_name})+"</a>").appendTo(user_dom.profile);user_dom.avatar=$('<a href="#" title="'+App.lang("Update Avatar")+'"></a>').appendTo($('<div class="profile_menu_popup_avatar_wrapper"></div>').appendTo(user_dom.group));user_dom.avatar_image=$('<img src="" />').appendTo(user_dom.avatar);user_dom.options=$('<div class="profile_menu_popup_options menu_navigation_row grouped_popup_buttons"></div>').appendTo(user_dom.group);user_dom.btn_profile=$('<a href="'+popup_dom.settings["additional"]["update_profile_url"]+'" class="menu_navigation_item grouped_popup_button" title="'+App.lang("Update Profile")+'">'+App.lang("Update Profile")+"</a>").appendTo(user_dom.options);user_dom.btn_settings=$('<a href="'+popup_dom.settings["additional"]["change_settings_url"]+'" class="menu_navigation_item grouped_popup_button" title="'+App.lang("Change Settings")+'">'+App.lang("Settings")+"</a>").appendTo(user_dom.options);user_dom.btn_password=$('<a href="'+popup_dom.settings["additional"]["change_password_url"]+'" class="menu_navigation_item grouped_popup_button" title="'+App.lang("Change Password")+'">'+App.lang("Change Password")+"</a>").appendTo(user_dom.options);user_dom.btn_profile.flyoutForm({success_event:"user_updated",success_message:App.lang("User profile has been updated")});user_dom.btn_settings.flyoutForm({success_event:"user_updated",success_message:App.lang("Settings have been updated")});user_dom.btn_password.flyoutForm({success_event:"user_updated",success_message:App.lang("Password has been changed"),width:"narrow"});user_dom.avatar.flyout();var update_profile_details=function(){user_dom.name.text(user.display_name);user_dom.avatar_image.attr("src",user.avatar["photo"]);user_dom.avatar.attr("href",user.urls["update_avatar"])};update_profile_details();App.Wireframe.Events.bind("user_update.main_menu_popup",function(event,updated_user){var user=popup_dom.settings["additional"]["user"];if(user.id==updated_user.id){popup_dom.settings["additional"]["user"]=updated_user;update_profile_details()}});var favorites=popup_dom.settings["additional"]["favorites"];var favorites_loaded=popup_dom.settings["loaded"];var favorites_dom={};favorites_dom.group=$('<div class="menu_navigation_group profile_menu_popup_user_favorites"></div>').appendTo(popup_dom.body);favorites_dom.title=$("<h3><span>"+App.lang("Favorites")+"</span></h3>").appendTo(favorites_dom.group);if(!favorites_loaded){favorites_dom.group.append('<p class="empty_page">'+App.lang("Loading Favorites")+"...</p>")}else{if(favorites&&favorites.length){favorites_dom.list=$('<ul class="profile_menu_popup_user_favorites_list"></ul>').appendTo(favorites_dom.group);App.each(favorites,function(index,favorite){var list_item=$('<li class="menu_navigation_row menu_navigation_item"><a href="#" class="profile_menu_popup_user_favorites_toggler do_not_close" off_url="'+favorite.urls["remove_from_favorites"]+'" on_url="'+favorite.urls["add_to_favorites"]+'"><img src="'+App.Wireframe.Utils.imageUrl("heart-on.png","favorites")+'" /></a><a href="'+favorite.urls["view"]+'" class="menu_navigation_target" title="'+App.clean(favorite.name)+'">'+App.excerpt(App.clean(favorite.name),35)+'</a><span class="object_type object_type_'+favorite["class"].toLowerCase()+'">'+favorite.verbose_type+"</span></li>");list_item.find(".profile_menu_popup_user_favorites_toggler:first").get(0).is_favorite=1;favorites_dom.list.append(list_item)});var indicator_url=App.Wireframe.Utils.indicatorUrl("small");var on_state=App.Wireframe.Utils.imageUrl("heart-on.png","favorites");var off_state=App.Wireframe.Utils.imageUrl("heart-off.png","favorites");favorites_dom.list.on("click","a.profile_menu_popup_user_favorites_toggler",function(event){var anchor_dom=this;var anchor=$(this);var image=anchor.find("img").attr("src",indicator_url);var action_url=anchor_dom.is_favorite?anchor.attr("off_url"):anchor.attr("on_url");$.ajax({url:action_url,success:function(response){image.attr("src",response.is_favorite?on_state:off_state);anchor_dom.is_favorite=response.is_favorite},error:function(response){}});return false})}else{favorites_dom.group.append('<p class="empty_page">'+App.lang("No Favorite Objects")+"...</p>")}}var session_dom={};session_dom.group=$('<div class="menu_navigation_group profile_menu_popup_user_session"></div>').appendTo(popup_dom.body);session_dom.title=$("<h3><span>"+App.lang("Session")+"</span></h3>").appendTo(session_dom.group);session_dom.options=$('<div class="profile_menu_popup_session menu_navigation_row grouped_popup_buttons"></div>').appendTo(session_dom.group);session_dom.btn_logout=$('<a href="'+popup_dom.settings["additional"]["logout_url"]+'" class="menu_navigation_item grouped_popup_button logout_button" title="'+App.lang("Logout")+'"><img src="'+App.Wireframe.Utils.imageUrl("layout/menu/logout.png","environment")+'" />'+App.lang("Logout")+"</a>").appendTo(session_dom.options);session_dom.btn_logout.click(function(){var anchor=$(this);if(App.Wireframe.BackendLayout.logout(anchor.attr("href"))){App.Wireframe.MainMenu.closePopup()}return false})},function(settings){var logged_user=settings.additional["user"];App.Wireframe.Events.bind("user_updated",function(event,user){if(logged_user.id==user.id){settings.additional["user"]=user}})});
App.Wireframe.MainMenu.handlers.register("projects_menu","projects",function(popup_dom){var projects_loaded=popup_dom.settings["loaded"];var projects=popup_dom.settings["additional"]["projects"];var projects_group=popup_dom.settings["additional"]["project_groups"];var active_projects_dom={};active_projects_dom.group=$('<div class="menu_navigation_group projects_menu_popup_active_projects"></div>').appendTo(popup_dom.body);if(!projects_loaded){active_projects_dom.group.append('<p class="empty_page">'+App.lang("Loading Projects")+"...</p>")}else{var current_grouping=null;var current_grouping_map=null;var cookie_content=$.trim($.cookie("ac_objects_lists"));if(cookie_content){cookie_content=$.parseJSON(cookie_content);if(cookie_content.projects&&cookie_content.projects["grouping"]){current_grouping=cookie_content.projects["grouping"];current_grouping_map=projects_group[current_grouping]}}if(current_grouping_map&&typeof(current_grouping_map)!="object"){eval("current_grouping_map = "+current_grouping_map)}var item_container={};var uncategorized_name=false;if(current_grouping&&current_grouping_map&&!$.isEmptyObject(current_grouping_map)){App.each(current_grouping_map,function(group_id,group_name){if(group_id){item_container[group_id]=$('<ul class="menu_navigation_group main_menu_projects_list"></ul>').appendTo(active_projects_dom.group).append('<li class="main_menu_projects_list_group_name">'+App.clean(group_name)+"</li>")}else{uncategorized_name=group_name}});if(uncategorized_name){item_container[0]=$('<ul class="menu_navigation_group main_menu_projects_list"></ul>').appendTo(active_projects_dom.group).append('<li class="main_menu_projects_list_group_name">'+App.clean(uncategorized_name)+"</li>")}}else{item_container[0]=$('<ul class="menu_navigation_group main_menu_projects_list"></ul>').appendTo(active_projects_dom.group)}var group_id,group;App.each(projects,function(index,project){group_id=parseInt(project[current_grouping]);group=item_container[group_id]?item_container[group_id]:item_container[0];group.append('<li class="menu_navigation_row" _search_index="'+App.clean(project.name.toLowerCase())+'"><a href="'+project.urls["view"]+'" class="menu_navigation_item open_submenu" submenu_handler="projects_submenu" project_id="'+project.id+'"><img src="'+project.avatar["small"]+'" />'+App.clean(project.name)+"</a></li>")});var hide_empty_groups=function(){if(current_grouping&&current_grouping_map&&!$.isEmptyObject(current_grouping_map)){$.each(item_container,function(item_container_id,item_container_single){if(item_container_single.find("li.menu_navigation_row:visible").length<1){item_container_single.hide()}})}};hide_empty_groups();var field_wrapper=$("<li></li>").appendTo(popup_dom.header_actions);var passthrough_keys=[38,40,13];var filter_field=$('<input type="text" id="menu_popup_projects_filter" placeholder="'+App.lang("Filter projects")+'" />').appendTo(field_wrapper).on("keydown",function(event){if($.inArray(event.which,passthrough_keys)!=-1){return true}if(event.which==27&&!filter_field.val()){return true}if(event.which==39&&App.Wireframe.Utils.Caret.isOnEnd($(this))){return true}if(event.which==37&&App.Wireframe.Utils.Caret.isOnEnd($(this))&&App.Wireframe.MainMenu.isSubmenuOpen()){return true}event.stopPropagation();return true}).bind("keyup",function(event){if(event.which==27&&filter_field.val()){filter_field.val("")}var search_query=$.trim(filter_field.val().toLowerCase().replace(/\"/g,""));var search_expression="li.menu_navigation_row";$.each(search_query.split(" "),function(index,search_fragment){if(search_fragment){search_expression+='[_search_index*="'+search_fragment+'"]'}});active_projects_dom.group.find("li.menu_navigation_row").hide();active_projects_dom.group.find(search_expression).show();active_projects_dom.group.find("li.menu_navigation_row:hidden a.current").removeClass("current");active_projects_dom.group.find("ul.main_menu_projects_list").show();if(!active_projects_dom.group.find("li.menu_navigation_row:visible a.current").length){App.Wireframe.MainMenu.closeSubmenu();popup_dom.methods.set_current(active_projects_dom.group.find("li.menu_navigation_row:visible:first a"))}hide_empty_groups()});setTimeout(function(){filter_field.focus()},100)}return true},function(popup_data,popup_id){App.Wireframe.Events.bind("category_deleted.main_menu",function(event,category){if(category["class"].toLowerCase()=="projectcategory"){setTimeout(function(){App.Wireframe.MainMenu.refresh("projects")},200)}})});App.Wireframe.MainMenu.handlers.register("projects_submenu","projects",function(parent,popup_dom,submenu_dom){try{var project_id=parent.attr("project_id");var map=popup_dom.settings["additional"]["projects_tabs_map"];var project_tabs=map[project_id];submenu_dom.header.hide();submenu_dom.header_title.text(parent.text());var list=$('<ul class="menu_navigation_group main_menu_projects_tab_list"></ul>').appendTo(submenu_dom.body);var item;App.each(project_tabs,function(index,tab){if(tab.text=="-"||tab.text==""||tab.text==" "){if(item&&item.length){item.addClass("before_separator")}item=$('<li class="separator"></li>').appendTo(list)}else{item=$('<li class="menu_navigation_row"><a href="'+tab.url+'" class="menu_navigation_item"><img src="'+tab.icon+'" />'+(index=="overview"?App.lang("Overview"):tab.text)+"</a></li>").appendTo(list)}})}catch(exception){App.Wireframe.MainMenu.closePopup()}},function(){var quick_jump_events=["project_created.main_menu","project_updated.main_menu","project_deleted.main_menu","project_people_created.main_menu","project_people_updated.main_menu","projects_settings_updated.main_menu","projects_mass_updated.main_menu","role_created.main_menu","role_updated.main_menu","role_deleted.main_menu","project_role_created.main_menu","project_role_updated.main_menu","project_role_deleted.main_menu","user_added_to_project.main_menu"];App.Wireframe.Events.bind(quick_jump_events.join(" "),function(){App.Wireframe.MainMenu.refresh("projects")})});
