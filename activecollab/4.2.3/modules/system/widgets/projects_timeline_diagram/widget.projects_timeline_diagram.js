(function($){var public_methods={init:function(options){return this.each(function(){var wrapper_dom=this;var wrapper=$(this);this.tl_data={settings:jQuery.extend({},settings,options),items:{}};render_layout.apply(this);batch_add_items.apply(this,[this.tl_data.settings.data]);handle_interaction.apply(this)})},add_item:function(project){return this.each(function(){add_item.apply(this)})}};var refresh_timeline=function(){var wrapper=$(this);var wrapper_dom=this;if(wrapper_dom.tl_data.scrollbar_width==undefined){wrapper_dom.tl_data.scrollbar_width=this.tl_data.bars_canvas_wrapper.innerWidth()-this.tl_data.bars_canvas.innerWidth()}var canvas_width=this.tl_data.bars_canvas_wrapper.width();var canvas_height=this.tl_data.bars_canvas_wrapper.height();this.tl_data.bars_canvas.css("width",(canvas_width+wrapper_dom.tl_data.scrollbar_width)+"px");this.tl_data.bars_canvas.css("height",(canvas_height+wrapper_dom.tl_data.scrollbar_width)+"px");var bars=wrapper.find("div.widget_timeline_bar");if(this.tl_data.min_date){var current_scroll=this.tl_data.bars_canvas.scrollLeft();this.tl_data.previous_min_date=this.tl_data.min_date.clone();this.tl_data.previous_max_date=this.tl_data.max_date.clone()}var calculated_min_date=new Date().set({hour:1,minute:0,second:0});var calculated_max_date=new Date().set({hour:1,minute:0,second:0});bars.each(function(){var bar=$(this);if(bar.data("start_date")<calculated_min_date){calculated_min_date=bar.data("start_date").clone()}if(bar.data("end_date")>calculated_max_date){calculated_max_date=bar.data("end_date").clone()}});calculated_min_date.moveToFirstDayOfMonth().addMonths(-1*this.tl_data.settings.min_months_before);calculated_max_date.moveToFirstDayOfMonth().addMonths(this.tl_data.settings.min_months_after).moveToLastDayOfMonth();var redraw_grid=false;if(!this.tl_data.min_date){this.tl_data.min_date=calculated_min_date.clone();this.tl_data.max_date=calculated_max_date.clone();redraw_grid=true}else{if(calculated_min_date<this.tl_data.min_date){this.tl_data.min_date=calculated_min_date.clone();redraw_grid=true}if(calculated_max_date>this.tl_data.max_date){this.tl_data.max_date=calculated_max_date.clone();redraw_grid=true}}bars.each(function(){var bar=$(this);bar.css("left",(((count_days_between(bar.data("start_date"),wrapper_dom.tl_data.min_date))*wrapper_dom.tl_data.settings.day_width))+"px")});var today=new Date();this.tl_data.today.css("left",(((count_days_between(today.setHours(0,1,1,1),wrapper_dom.tl_data.min_date))*wrapper_dom.tl_data.settings.day_width))+"px").css("width",wrapper_dom.tl_data.settings.day_width);if(redraw_grid){this.tl_data.calendar_wrapper.css("background-position",(-1*this.tl_data.settings.day_width*this.tl_data.min_date.getDay())+"px bottom");this.tl_data.bars_wrapper.css("background-position",(-1*this.tl_data.settings.day_width*this.tl_data.min_date.getDay())+"px bottom");var diagram_width=(count_days_between(wrapper_dom.tl_data.max_date,wrapper_dom.tl_data.min_date)+1)*this.tl_data.settings.day_width;this.tl_data.bars_wrapper.css("width",diagram_width+"px");this.tl_data.calendar_wrapper.css("width",diagram_width+"px");this.tl_data.diagram_width=diagram_width;this.tl_data.calendar_wrapper.empty();var loop_date=new Date(this.tl_data.min_date.getTime());var month_offset=0;var month_width=0;while(loop_date<this.tl_data.max_date){month_width=Date.getDaysInMonth(loop_date.getFullYear(),loop_date.getMonth())*this.tl_data.settings.day_width;var month=$('<div class="widget_timeline_calendar_month"></div>').css({width:month_width+"px",left:month_offset+1+"px"});var month_inner=$('<div class="widget_timeline_calendar_month_inner"></div>').css({"background-image":'url("'+this.tl_data.settings.images.month_days+'")'}).html(this.tl_data.settings.month_names[loop_date.getMonth()]+" "+loop_date.getFullYear()).appendTo(month);month.appendTo(this.tl_data.calendar_wrapper);month_offset+=month_width;loop_date.addMonths(1)}this.tl_data.bars_wrapper_days_off.empty();var loop_date=new Date(this.tl_data.min_date.getTime());var days_counted=0;var day_off=null;while(loop_date<this.tl_data.max_date){if(is_day_off.apply(this,[loop_date])){day_off=$('<div class="widget_timeline_day_off"></div>').css({left:days_counted*this.tl_data.settings.day_width+1,width:this.tl_data.settings.day_width-1}).appendTo(this.tl_data.bars_wrapper_days_off)}days_counted++;loop_date.addDays(1)}if(this.tl_data.previous_min_date){scroll_canvas_horizontally.apply(this,[current_scroll+count_days_between(this.tl_data.previous_min_date,this.tl_data.min_date)*this.tl_data.settings.day_width])}else{scroll_canvas_horizontally.apply(this,[(count_days_between(new Date(),this.tl_data.min_date)*this.tl_data.settings.day_width)-(this.tl_data.bars_canvas.width()/2)]);this.tl_data.bars_canvas.scrollTop(0)}}draw_horizontal_scrollbar_graph.apply(this);init_scrollbars.apply(this)};var scroll_canvas_horizontally=function(position,animation_length,offset){var wrapper_dom=this;if(!animation_length){wrapper_dom.tl_data.calendar_canvas.scrollLeft(position);wrapper_dom.tl_data.bars_canvas.scrollLeft(position)}else{this.tl_data.calendar_canvas.scrollTo(position,animation_length,{axis:"x",offset:offset});this.tl_data.bars_canvas.scrollTo(position,animation_length,{axis:"x",offset:offset})}};var draw_horizontal_scrollbar_graph=function(){var wrapper_dom=this;var wrapper=$(this);this.tl_data.horizontal_scrollbar_canvas.empty();var bars=wrapper.find("div.widget_timeline_bar");var scrollbar_width=this.tl_data.horizontal_scrollbar.width();var canvas_width=this.tl_data.bars_wrapper.width();bars.each(function(){var bar=$(this);$('<div class="widget_timeline_horizontal_scrollbar_bar '+(bar.is(".completed")?"completed":"scheduled")+'" style="width: '+Math.round((bar.width()/canvas_width)*scrollbar_width)+"px; margin-left: "+Math.round((bar.position().left/canvas_width)*scrollbar_width)+'px"></div>').appendTo(wrapper_dom.tl_data.horizontal_scrollbar_canvas)});var max_scrollbar_height=this.tl_data.settings.max_scrollbar_height-this.tl_data.horizontal_scrollbar_canvas.position().top*2;var scrollbar_bars=this.tl_data.horizontal_scrollbar_canvas.find(".widget_timeline_horizontal_scrollbar_bar");var compression_factor=Math.ceil((scrollbar_bars.length*(scrollbar_bars.eq(0).height()+1))/max_scrollbar_height);if(compression_factor>1){var counter=0;scrollbar_bars.each(function(){if(counter%compression_factor!=0){$(this).css("margin-top","-2px")}counter++})}var calculated_scrollbar_height=this.tl_data.horizontal_scrollbar_canvas.height()+this.tl_data.horizontal_scrollbar_canvas.position().top*2;calculated_scrollbar_height=calculated_scrollbar_height<this.tl_data.settings.min_scrollbar_height?this.tl_data.settings.min_scrollbar_height:calculated_scrollbar_height;this.tl_data.horizontal_scrollbar.height(calculated_scrollbar_height);this.tl_data.bars_container.css("bottom",parseInt(this.tl_data.horizontal_scrollbar.css("bottom"))*2+calculated_scrollbar_height);this.tl_data.bars_canvas.css("width",(this.tl_data.bars_canvas_wrapper.width()+this.tl_data.scrollbar_width)+"px");this.tl_data.bars_canvas.css("height",(this.tl_data.bars_canvas_wrapper.height()+this.tl_data.scrollbar_width)+"px")};var init_scrollbars=function(){var wrapper_dom=this;var horizontal_handle_width=this.tl_data.bars_canvas_wrapper.width()/this.tl_data.diagram_width*this.tl_data.horizontal_scrollbar.width();horizontal_handle_width=horizontal_handle_width<25?25:horizontal_handle_width;this.tl_data.horizontal_scrollbar_handle.css("width",horizontal_handle_width+"px");var max_scroll_left=this.tl_data.diagram_width-this.tl_data.bars_canvas_wrapper.width();var max_horizontal_handle_value=this.tl_data.horizontal_scrollbar.width()-this.tl_data.horizontal_scrollbar_handle.width()-parseInt(this.tl_data.horizontal_scrollbar_handle.css("border-left-width"))-parseInt(this.tl_data.horizontal_scrollbar_handle.css("border-right-width"));if(this.tl_data.horizontal_scrollbar_handle.is(".ui-draggable")){this.tl_data.horizontal_scrollbar_handle.draggable("destroy");this.tl_data.horizontal_scrollbar.unbind("mousedown")}this.tl_data.horizontal_scrollbar_handle.draggable({axis:"x",containment:"parent",drag:function(event,ui){var new_x_scroll=(ui.position.left/max_horizontal_handle_value)*max_scroll_left;scroll_canvas_horizontally.apply(wrapper_dom,[new_x_scroll])},start:function(){wrapper_dom.tl_data.dragging_scrollbars=true},stop:function(){wrapper_dom.tl_data.dragging_scrollbars=false}});this.tl_data.horizontal_scrollbar.bind("mousedown",function(event){if(!$(event.target).is(".widget_timeline_horizontal_scrollbar_handle")){var target_x=$(event.target).offset().left;var client_x=event.clientX;var new_left_offset=(client_x-target_x)-horizontal_handle_width/2;if(new_left_offset<0){new_left_offset=0}else{if(new_left_offset>max_horizontal_handle_value){new_left_offset=max_horizontal_handle_value}}wrapper_dom.tl_data.horizontal_scrollbar_handle.css("left",new_left_offset);var new_x_scroll=(new_left_offset/max_horizontal_handle_value)*max_scroll_left;scroll_canvas_horizontally.apply(wrapper_dom,[new_x_scroll])}});var vertical_handle_height=this.tl_data.bars_canvas_wrapper.height()/this.tl_data.bars_wrapper.height()*this.tl_data.vertical_scrollbar.height();vertical_handle_height=vertical_handle_height<25?25:vertical_handle_height;this.tl_data.vertical_scrollbar_handle.css("height",(vertical_handle_height)+"px");var max_scroll_top=this.tl_data.bars_wrapper.height()-this.tl_data.bars_canvas_wrapper.height();var max_vertical_handle_value=this.tl_data.vertical_scrollbar.height()-this.tl_data.vertical_scrollbar_handle.height()-parseInt(this.tl_data.vertical_scrollbar_handle.css("border-top-width"))-parseInt(this.tl_data.vertical_scrollbar_handle.css("border-bottom-width"));if(!max_scroll_top){this.tl_data.vertical_scrollbar.hide()}else{this.tl_data.vertical_scrollbar.show();if(this.tl_data.vertical_scrollbar_handle.is(".ui-draggable")){this.tl_data.vertical_scrollbar_handle.draggable("destroy");this.tl_data.vertical_scrollbar.unbind("mousedown")}this.tl_data.vertical_scrollbar_handle.draggable({axis:"y",containment:"parent",drag:function(event,ui){var new_y_scroll=(ui.position.top/max_vertical_handle_value)*max_scroll_top;wrapper_dom.tl_data.bars_canvas.scrollTop(new_y_scroll);wrapper_dom.tl_data.bars_names.scrollTop(new_y_scroll)},start:function(){wrapper_dom.tl_data.dragging_scrollbars=true},stop:function(){wrapper_dom.tl_data.dragging_scrollbars=false}})}this.tl_data.vertical_scrollbar.bind("mousedown",function(event){if($(event.target).is(".widget_timeline_vertical_scrollbar")){var new_top_offset=event.layerY-vertical_handle_height/2;if(new_top_offset<0){new_top_offset=0}else{if(new_top_offset>max_vertical_handle_value){new_top_offset=max_vertical_handle_value}}wrapper_dom.tl_data.vertical_scrollbar_handle.css("top",new_top_offset);var new_y_scroll=(new_top_offset/max_vertical_handle_value)*max_scroll_top;wrapper_dom.tl_data.bars_canvas.scrollTop(new_y_scroll);wrapper_dom.tl_data.bars_names.scrollLeft(new_y_scroll)}});refresh_scrollbars_position.apply(this)};var refresh_scrollbars_position=function(){var current_x_scroll=this.tl_data.bars_canvas.scrollLeft();var max_x_scroll=this.tl_data.diagram_width-this.tl_data.bars_canvas.width();var max_horizontal_scrollbar_handle_offset=this.tl_data.horizontal_scrollbar.width()-this.tl_data.horizontal_scrollbar_handle.width()-parseInt(this.tl_data.horizontal_scrollbar_handle.css("border-left-width"))-parseInt(this.tl_data.horizontal_scrollbar_handle.css("border-right-width"));this.tl_data.horizontal_scrollbar_handle.css("left",(current_x_scroll/max_x_scroll*max_horizontal_scrollbar_handle_offset)+"px");var current_y_scroll=this.tl_data.bars_canvas.scrollTop();var max_y_scroll=this.tl_data.bars_wrapper.height()-this.tl_data.bars_canvas.height();var max_vertical_scrollbar_handle_offset=this.tl_data.vertical_scrollbar.height()-this.tl_data.vertical_scrollbar_handle.height()-parseInt(this.tl_data.vertical_scrollbar_handle.css("border-top-width"))-parseInt(this.tl_data.vertical_scrollbar_handle.css("border-bottom-width"));this.tl_data.vertical_scrollbar_handle.css("top",(current_y_scroll/max_y_scroll*max_vertical_scrollbar_handle_offset)+"px")};var render_layout=function(){var wrapper=$(this).disableSelection();wrapper.addClass("widget_timeline_diagram");this.tl_data.calendar_canvas=$('<div class="widget_timeline_calendar_canvas"></div>').appendTo(wrapper);this.tl_data.calendar_wrapper=$('<div class="widget_timeline_calendar_wrapper"></div>').appendTo(this.tl_data.calendar_canvas).css("background-image",'url("'+this.tl_data.settings.images.week_days+'")');this.tl_data.bars_container=$('<div class="widget_timeline_bars_container"></div>').appendTo(wrapper);this.tl_data.bars_names=$('<div class="widget_timeline_bar_names"></div>').appendTo(this.tl_data.bars_container);this.tl_data.bars_names_scheduled=$('<ul class="scheduled"></ul>').appendTo(this.tl_data.bars_names);this.tl_data.bars_names_tba=$('<ul class="tba"></ul>').appendTo(this.tl_data.bars_names);this.tl_data.bars_names_completed=$('<ul class="scheduled"></ul>').appendTo(this.tl_data.bars_names);this.tl_data.bars_canvas_wrapper=$('<div class="widget_timeline_bar_canvas_wrapper"></div>').appendTo(this.tl_data.bars_container).disableSelection();this.tl_data.bars_canvas=$('<div class="widget_timeline_bar_canvas"></div>').appendTo(this.tl_data.bars_canvas_wrapper).disableSelection();this.tl_data.bars_wrapper=$('<div class="widget_timeline_bars_wrapper"></div>').appendTo(this.tl_data.bars_canvas).css("background-image",'url("'+this.tl_data.settings.images.days+'")').disableSelection();this.tl_data.bars_wrapper_days_off=$('<div class="widget_timeline_days_off"></div>').appendTo(this.tl_data.bars_wrapper);this.tl_data.bars_wrapper_scheduled=$('<div class="scheduled"></div>').appendTo(this.tl_data.bars_wrapper);this.tl_data.bars_wrapper_tba=$('<div class="tba"></div>').appendTo(this.tl_data.bars_wrapper);this.tl_data.bars_wrapper_completed=$('<div class="completed"></div>').appendTo(this.tl_data.bars_wrapper);this.tl_data.today=$('<div class="widget_timeline_today"></div>').prependTo(this.tl_data.bars_wrapper);this.tl_data.horizontal_scrollbar=$('<div class="widget_timeline_horizontal_scrollbar"></div>').appendTo(wrapper).disableSelection();this.tl_data.horizontal_scrollbar_canvas=$('<div class="widget_timeline_horizontal_scrollbar_canvas"></div>').appendTo(this.tl_data.horizontal_scrollbar);this.tl_data.horizontal_scrollbar_handle=$('<div class="widget_timeline_horizontal_scrollbar_handle"></div>').appendTo(this.tl_data.horizontal_scrollbar);this.tl_data.vertical_scrollbar=$('<div class="widget_timeline_vertical_scrollbar"></div>').appendTo(wrapper).disableSelection();this.tl_data.vertical_scrollbar_handle=$('<div class="widget_timeline_vertical_scrollbar_handle"></div>').appendTo(this.tl_data.vertical_scrollbar)};var add_item=function(item,bulk){var destination_bar=null;var destination_name=null;if(item.completed_on){destination_bar=this.tl_data.bars_wrapper_completed;destination_name=this.tl_data.bars_names_completed}else{if(item.start_on&&item.due_on){destination_bar=this.tl_data.bars_wrapper_scheduled;destination_name=this.tl_data.bars_names_scheduled}else{destination_bar=this.tl_data.bars_wrapper_tba;destination_name=this.tl_data.bars_names_tba}}destination_name.append(render_bar_name.apply(this,[item]));destination_bar.append(render_bar.apply(this,[item]));store_item.apply(this,[item]);if(!bulk){refresh_timeline.apply(this)}};var batch_add_items=function(items){var wrapper_dom=this;if(items&&items.length){$.each(items,function(){add_item.apply(wrapper_dom,[this,true])})}refresh_timeline.apply(this)};var get_class_name=function(item){if(item.completed_on){return"completed"}else{if(item.start_on&&item.due_on){return"schedule"}else{return"tba"}}};var render_bar_name=function(item){var rendered='<li project_id="'+item.id+'" class="'+get_class_name(item)+'">';if(item.permissions.can_edit){rendered+='<a href="#" class="complete_toggler" is_completed="'+(item.completed_on?1:0)+'">';if(item.completed_on){rendered+='<img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/checkbox-checked.png","complete")+'" />'}else{rendered+='<img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/checkbox-unchecked.png","complete")+'" />'}rendered+="</a>"}else{if(item.completed_on){rendered+='<img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/checkbox-checked.png","complete")+'" /> '}}rendered+="<span>"+App.excerpt(App.clean(item.name),32)+"</span>";rendered+='<span class="actions">';rendered+='<a href="'+item.urls.milestones+'" class="milestones"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/preview.png","environment")+'" /></a>';if(item.permissions.can_edit){rendered+='<a href="'+item.urls.edit+'" class="edit_project"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/edit.png","environment")+'" /></a>'}if(item.permissions.can_trash){rendered+='<a href="'+item.urls.trash+'" class="delete_project"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/move-to-trash.png","system")+'" /></a>'}rendered+='<a href="'+item.permalink+'" class="permalink"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/proceed.png","environment")+'" /></a>';rendered+="</span>";if(item.permissions.can_edit){rendered+='<span class="widget_timeline_item_popup_save"><span class="widget_timeline_item_popup_save_inner"><a href="#" class="widget_timeline_item_popup_action_save">'+App.lang("Save")+"</a> "+App.lang("or")+' <a href="#" class="widget_timeline_item_popup_action_cancel">'+App.lang("cancel")+"</a></span></span>"}rendered+="</li>";rendered=$(rendered);rendered.css("height",this.tl_data.settings.bar_height+"px").css("line-height",this.tl_data.settings.bar_height+"px");return rendered};var render_bar=function(item){var rendered=$('<div class="widget_timeline_bar_wrapper '+get_class_name(item)+'" project_id="'+item.id+'"></div>').css("height",this.tl_data.settings.bar_height+"px");if(item.start_on&&item.due_on&&item.start_on.timestamp&&item.due_on.timestamp){var start_on_date=new Date(item.start_on.timestamp*1000);var due_on_date=new Date(item.due_on.timestamp*1000);var start_on_date_gmt=new Date(start_on_date.getUTCFullYear(),start_on_date.getUTCMonth(),start_on_date.getUTCDate(),start_on_date.getUTCHours(),start_on_date.getUTCMinutes(),start_on_date.getUTCSeconds());var due_on_date_gmt=new Date(due_on_date.getUTCFullYear(),due_on_date.getUTCMonth(),due_on_date.getUTCDate(),due_on_date.getUTCHours(),due_on_date.getUTCMinutes(),due_on_date.getUTCSeconds());var days_between=count_days_between(due_on_date_gmt,start_on_date_gmt);var bar=$('<div class="widget_timeline_bar" project_id="'+item.id+'"></div>').appendTo(rendered).css({width:this.tl_data.settings.day_width*(days_between+1),height:this.tl_data.settings.bar_height-6});var percents_done=item.percents_done?item.percents_done:0;var percentage_bar=$('<div class="widget_timeline_bar_percents"></div>').appendTo(bar).css("width",percents_done+"%");var percentage_label=$('<div class="widget_timeline_bar_percents_label"></div>').appendTo(bar).html(percents_done+"%").css("line-height",(this.tl_data.settings.bar_height-6)+"px");bar.data({percentage_bar:percentage_bar,percentage_label:percentage_label,popup_save:null,start_date:start_on_date_gmt,end_date:due_on_date_gmt,saved_start_date:start_on_date_gmt.clone(),saved_end_date:due_on_date_gmt.clone()});if(item.completed_on){bar.addClass("completed")}handle_bar_interaction.apply(this,[bar,item])}else{}return rendered};var handle_bar_interaction=function(bar,item){var wrapper=$(this);var wrapper_dom=this;if(!item.completed_on&&item.permissions.can_edit){bar.draggable({axis:"x",scroll:true,grid:[wrapper_dom.tl_data.settings.day_width,wrapper_dom.tl_data.settings.day_width],scrollSensitivity:wrapper_dom.tl_data.settings.day_width*4,scrollSpeed:wrapper_dom.tl_data.settings.day_width*2,addClasses:false,start:function(event,ui){bar.addClass("rescheduling").removeClass("not_rescheduling")},stop:function(event,ui){bar.removeClass("rescheduling").addClass("not_rescheduling");process_bar_interaction.apply(wrapper_dom,[bar,item]);if(typeof wrapper_dom.tl_data.settings.reschedule=="function"){wrapper_dom.tl_data.settings.reschedule(item,bar.data("start_date"),bar.data("end_date"))}}});bar.dblclick(function(){var new_anchor=$('<a href="'+item.urls.milestones+'" title="'+App.lang("All Milestones of :object_name",{object_name:App.clean(item.name)})+'">'+App.lang("All Milestones of :object_name",{object_name:App.clean(item.name)})+"</a>").flyoutForm({success_event:"project_updated"});new_anchor.click().remove();return false})}};var start_tracking_drag_coordinate=function(bar){var wrapper_dom=this;var last_known_x=0;var real_last_known_x=0;this.tl_data.bars_canvas.bind("mousemove",function(event){last_known_x=event.pageX-wrapper_dom.tl_data.bars_canvas.offset().left;real_last_known_x=event.layerX});if(this.tl_data.watcher){clearInterval(this.tl_data.watcher);this.tl_data.watcher=undefined}var scroll_step=wrapper_dom.tl_data.settings.day_width*3;this.tl_data.watcher=setInterval(function(){if(last_known_x<(wrapper_dom.tl_data.settings.day_width*3)){scroll_canvas_horizontally.apply(wrapper_dom,[wrapper_dom.tl_data.bars_canvas.scrollLeft()-scroll_step])}},50)};var stop_tracking_drag_coordinate=function(){this.tl_data.bars_canvas.unbind("mousemove");clearInterval(this.tl_data.watcher);this.tl_data.watcher=undefined};var process_bar_interaction=function(bar,item){var left=bar.position().left;var right=left+bar.width();var new_start_date=this.tl_data.min_date.clone().addDays(Math.round(left/this.tl_data.settings.day_width));var new_end_date=this.tl_data.min_date.clone().addDays(Math.round(right/this.tl_data.settings.day_width)-1);var dates_corrected=false;if(this.tl_data.settings.skip_days_off){var counter=0;while((is_weekend.apply(this,[new_start_date])||is_day_off.apply(this,[new_start_date]))&&counter<365){new_start_date.addDays(1);new_end_date.addDays(1);dates_corrected=true;counter++}}bar.data("start_date",new_start_date);bar.data("end_date",new_end_date);if(dates_corrected){reposition_bar.apply(this,[bar])}check_for_changes.apply(this,[bar,item]);refresh_timeline.apply(this)};var check_for_changes=function(bar,item){var label=this.tl_data.bars_names.find('li[project_id="'+item.id+'"]');if(Date.compare(bar.data("start_date"),bar.data("saved_start_date"))==0&&Date.compare(bar.data("end_date"),bar.data("saved_end_date"))==0){bar.removeClass("modified");label.removeClass("modified")}else{bar.addClass("modified");label.addClass("modified")}};var reset_bar=function(bar,item){bar.data("start_date",bar.data("saved_start_date"));bar.data("end_date",bar.data("saved_end_date"));reposition_bar.apply(this,[bar,item]);check_for_changes.apply(this,[bar,item]);draw_horizontal_scrollbar_graph.apply(this)};var reposition_bar=function(bar){bar.css("left",(count_days_between(bar.data("start_date"),this.tl_data.min_date)*this.tl_data.settings.day_width)+"px");bar.css("width",((count_days_between(bar.data("end_date"),bar.data("start_date"))+1)*this.tl_data.settings.day_width)+"px")};var handle_interaction=function(){var wrapper=$(this);var wrapper_dom=this;App.Wireframe.Events.bind("window_resize.content",function(){if(!wrapper.is(".rescheduling")){refresh_timeline.apply(wrapper_dom)}});wrapper.bind("mousewheel",function(event,delta,delta_x,delta_y){delta_y=Math.ceil(delta_y);wrapper_dom.tl_data.bars_canvas.scrollTop(wrapper_dom.tl_data.bars_names.scrollTop()-delta_y);delta_x=Math.ceil(delta_x);scroll_canvas_horizontally.apply(wrapper_dom,[wrapper_dom.tl_data.bars_canvas.scrollLeft()+delta_x])});this.tl_data.bars_canvas.scroll(function(){if(!wrapper_dom.tl_data.dragging_scrollbars){refresh_scrollbars_position.apply(wrapper_dom)}wrapper_dom.tl_data.bars_names.scrollTop(wrapper_dom.tl_data.bars_canvas.scrollTop());wrapper_dom.tl_data.calendar_canvas.scrollLeft(wrapper_dom.tl_data.bars_canvas.scrollLeft())});App.Wireframe.Content.bind("project_created.content",function(event,response){add_item.apply(wrapper_dom,[response,false])});App.Wireframe.Content.bind("project_updated.content",function(event,response){update_item.apply(wrapper_dom,[response,false])});App.Wireframe.Content.bind("project_deleted.content",function(event,response){delete_item.apply(wrapper_dom,[response.project_id,false])});App.Wireframe.Content.bind("milestone_updated.content milestone_deleted.content",function(event,response){var project=response.project;update_item.apply(wrapper_dom,[project,false])});wrapper.delegate("a.complete_toggler","click",function(){var anchor=$(this);var project_id=anchor.parents("li:first").attr("project_id");var item=get_item.apply(wrapper_dom,[project_id]);var bar_wrapper=wrapper.find('.widget_timeline_bar_wrapper[project_id="'+project_id+'"]');var bar_name=anchor.parents("li:first");var image=anchor.find("img:first");var original_image=image.attr("src");image.attr("src",App.Wireframe.Utils.indicatorUrl("small"));bar_wrapper.block();bar_name.block();var action;var action_url;if(anchor.attr("is_completed")==1){action_url=item.urls.open;action="reopen"}else{action_url=item.urls.complete;action="complete"}$.ajax({url:action_url,type:"POST",data:{submitted:"submitted"},success:function(response){if(action=="reopen"){App.Wireframe.Flash.success(App.lang("Project ':project_name' successfully opened",{project_name:App.clean(response.name)}))}else{App.Wireframe.Flash.success(App.lang("Project ':project_name' successfully completed",{project_name:App.clean(response.name)}))}update_item.apply(wrapper_dom,[response,false])},error:function(response){bar_wrapper.unblock();bar_name.unblock();image.attr("src",original_image)}});return false});wrapper.delegate("a.edit_project","click",function(){var anchor=$(this);var project_id=anchor.parents("li:first").attr("project_id");var item=get_item.apply(wrapper_dom,[project_id]);var new_anchor=$('<a href="'+item.urls.edit+'" title="'+App.lang("Edit :object_name",{object_name:App.clean(item.name)})+'">'+App.lang("Edit :object_name",{object_name:App.clean(item.name)})+"</a>").flyoutForm({success_event:"project_updated"});new_anchor.click().remove();return false});wrapper.delegate("a.milestones","click",function(){var anchor=$(this);var project_id=anchor.parents("li:first").attr("project_id");var item=get_item.apply(wrapper_dom,[project_id]);var new_anchor=$('<a href="'+item.urls.milestones+'" title="'+App.lang("All Milestones of :object_name",{object_name:App.clean(item.name)})+'">'+App.lang("All Milestones of :object_name",{object_name:App.clean(item.name)})+"</a>").flyoutForm({success_event:"project_updated"});new_anchor.click().remove();return false});wrapper.delegate("a.delete_project","click",function(){var anchor=$(this);var project_id=anchor.parents("li:first").attr("project_id");var item=get_item.apply(wrapper_dom,[project_id]);if(!confirm(App.lang('Are you sure you want to move ":project_name" project to trash?',{project_name:App.clean(item.name)}))){return false}var bar_wrapper=wrapper.find('.widget_timeline_bar_wrapper[project_id="'+project_id+'"]');var bar_name=anchor.parents("li:first");var image=anchor.find("img:first");var original_image=image.attr("src");image.attr("src",App.Wireframe.Utils.indicatorUrl("small"));bar_wrapper.block();bar_name.block();$.ajax({url:item.urls.trash,type:"POST",data:{submitted:"submitted"},success:function(response){delete_item.apply(wrapper_dom,[project_id,false]);App.Wireframe.Flash.success(App.lang("Project ':project_name' successfully moved to trash",{project_name:App.clean(item.name)}))},error:function(response){bar_wrapper.unblock();bar_name.unblock();image.attr("src",original_image)}});return false});wrapper.delegate("div.widget_timeline_bar_names li","click",function(event,lol){if($(event.target).parents("a.permalink:first").length){return true}var bar=find_bar.apply(wrapper_dom,[$(this).attr("project_id")]);focus_bar.apply(wrapper_dom,[bar]);return false});wrapper.delegate("a.widget_timeline_item_popup_action_save","click",function(){var project_id=$(this).parents("li:first").attr("project_id");var bar=find_bar.apply(wrapper_dom,[project_id]);var item=get_item.apply(wrapper_dom,[project_id]);if(confirm(App.lang("Rescheduling project will result milestones reschedule based on work days.\r\nIn that case, difference between start and end project will be changed."))){$.ajax({url:item.urls.reschedule,type:"POST",data:{submitted:"submitted",project_id:project_id,new_start_on:bar.data("start_date").toString("yyyy-MM-dd")},success:function(response){App.Wireframe.Events.trigger("project_updated",[response])}})}return false});wrapper.delegate("a.widget_timeline_item_popup_action_cancel","click",function(){var project_id=$(this).parents("li:first").attr("project_id");var bar=find_bar.apply(wrapper_dom,[project_id]);var item=get_item.apply(wrapper_dom,[project_id]);reset_bar.apply(wrapper_dom,[bar,item]);focus_bar.apply(wrapper_dom,[bar]);return false});wrapper.delegate("a.widget_timeline_tbd_reschedule","click",function(){var project_id=$(this).parents("div.widget_timeline_bar_wrapper").attr("project_id");var item=get_item.apply(wrapper_dom,[project_id]);var reschedule_url=App.extendUrl(item.urls.reschedule,{describe_affected:1});var new_anchor=$('<a href="'+reschedule_url+'" title="'+App.lang("Reschedule :object_name",{object_name:App.clean(item.name)})+'">'+App.lang("Reschedule :object_name",{object_name:App.clean(item.name)})+"</a>").flyoutForm({success_event:"project_updated",width_class:"narrow"}).click().remove();return false})};var update_item=function(item,bulk){var wrapper_dom=this;var old_item=get_item.apply(this,[item.id]);if(!old_item){return add_item.apply(this,[item,bulk])}if(get_class_name(item)!=get_class_name(old_item)){delete_item.apply(this,[item.id,true]);add_item.apply(this,[item,bulk])}else{var wrapper=$(this);var bar=find_bar_wrapper.apply(this,[item.id]);var bar_name=find_bar_name.apply(this,[item.id]);render_bar_name.apply(this,[item]).insertAfter(bar_name);render_bar.apply(this,[item]).insertAfter(bar);bar.remove();bar_name.remove();store_item.apply(this,[item]);if(!bulk){refresh_timeline.apply(this)}}if(item.affected_projects&&item.affected_projects.length){$.each(item.affected_projects,function(){update_item.apply(wrapper_dom,[this,true])});refresh_timeline.apply(this)}};var delete_item=function(project_id,bulk){var wrapper=$(this);find_bar_wrapper.apply(this,[project_id]).remove();find_bar_name.apply(this,[project_id]).remove();delete this.tl_data.items[project_id];if(!bulk){refresh_timeline.apply(this)}};var focus_bar=function(bar){if(bar&&bar.width()){scroll_canvas_horizontally.apply(this,[bar,250,this.tl_data.settings.day_width*2*(-1)])}return false};var find_bar_wrapper=function(id){return $(this).find('.widget_timeline_bar_wrapper[project_id="'+id+'"]')};var find_bar=function(id){return $(this).find('.widget_timeline_bar_wrapper[project_id="'+id+'"] .widget_timeline_bar')};var find_bar_name=function(id){return $(this).find('.widget_timeline_bar_names li[project_id="'+id+'"]')};var store_item=function(item){this.tl_data.items[item.id]=item};var get_item=function(item_id){return this.tl_data.items[item_id]};var count_days_between=function(date1,date2){return Math.round(Math.abs((date1-date2)/(1000*60*60*24)))};var is_day_off=function(date){var current_day_off=this.tl_data.settings.days_off[date.getDate()+"/"+(date.getMonth()+1)];if(current_day_off){if(parseInt(current_day_off.repeat)>0){return true}if(parseInt(current_day_off.year)==date.getFullYear()){return true}}return false};var is_weekend=function(date){return $.inArray(date.getDay(),this.tl_data.settings.work_days)==-1};var plugin_name="projectsTimelineDiagram";var settings={bar_height:29,day_width:20,max_scrollbar_height:30,min_scrollbar_height:14,min_months_after:3,min_months_before:3,week_days_short:{0:"S",1:"M",2:"T",3:"W",4:"T",5:"F",6:"S"},week_days:{0:App.lang("Sunday"),1:App.lang("Monday"),2:App.lang("Tuesday"),3:App.lang("Wednesday"),4:App.lang("Thursday"),5:App.lang("Friday"),6:App.lang("Saturday")},month_names:{0:App.lang("January"),1:App.lang("February"),2:App.lang("March"),3:App.lang("April"),4:App.lang("May"),5:App.lang("June"),6:App.lang("July"),7:App.lang("August"),8:App.lang("September"),9:App.lang("October"),10:App.lang("November"),11:App.lang("December")},work_days:[1,2,3,4,5],days_off:[],skip_days_off:true};$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);