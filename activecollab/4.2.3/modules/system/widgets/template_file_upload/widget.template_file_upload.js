(function($){var public_methods={init:function(options){return this.each(function(){var wrapper=$(this);var wrapper_dom=this;this.fuf_variables={};this.fuf_variables.real_table=wrapper.find("#files_table").hide();this.fuf_variables.empty_page=$('<div class="no_uploaded_files">'+App.lang("Click button to choose files which will be uploaded. Maximum file size you can upload is :max_size",{max_size:App.formatFileSize(options.size_limit)})+"</div>").insertBefore(this.fuf_variables.real_table);this.fuf_variables.add_file_wrapper=$('<div class="add_button_wrapper" id="'+wrapper.attr("id")+'_add_button_wrapper"></div>').insertAfter(this.fuf_variables.real_table);this.fuf_variables.add_file_button=$('<a class="link_button" href="#" id="'+wrapper.attr("id")+'_add_button"><span class="inner"><span class="icon button_add">'+App.lang("Choose Files")+"</span></span></a>").appendTo(this.fuf_variables.add_file_wrapper);this.fuf_variables.edit_icon_url=options.edit_button_url;this.fuf_variables.delete_icon_url=options.delete_button_url;this.fuf_variables.default_file_icon=options.default_file_icon;if(typeof options.files!="undefined"&&$.isArray(options.files)){$.each(options.files,function(index,file){if(file){wrapper_dom.fuf_variables.real_table.append(render_file.apply(wrapper_dom,[file]))}})}if(this.fuf_variables.real_table.children().length>0){this.fuf_variables.real_table.show();this.fuf_variables.empty_page.hide()}this.fuf_variables.uploader=new plupload.Uploader({url:App.extendUrl(options.upload_url,{advanced_upload:1}),runtimes:options.uploader_runtimes,container:this.fuf_variables.add_file_wrapper.attr("id"),browse_button:this.fuf_variables.add_file_button.attr("id"),max_file_size:options.size_limit,file_data_name:options.upload_name,flash_swf_url:options.flash_uploader_url,silverlight_xap_url:options.silverlight_uploader_url,multipart:true,multipart_params:{submitted:"submitted"}});this.fuf_variables.uploader.bind("FilesAdded",function(uploader,files){files_added.apply(wrapper_dom,[files])});this.fuf_variables.uploader.bind("UploadProgress",function(uploader,file){update_file_progress.apply(wrapper_dom,[file])});this.fuf_variables.uploader.bind("FileUploaded",function(uploader,file,response){eval("var response = "+response.response);if(response&&response.type=="Error"){response.file=file;upload_error.apply(wrapper_dom,[response])}else{finalize_file_upload.apply(wrapper_dom,[file,response])}});this.fuf_variables.uploader.bind("Error",function(uploader,error){upload_error.apply(wrapper_dom,[error])});this.fuf_variables.uploader.init();wrapper.on("click","div.controls a.delete",function(){remove_file.apply(wrapper_dom,[$(this)]);return false})})}};var files_added=function(files){var wrapper_dom=this;wrapper_dom.fuf_variables.empty_page.hide();wrapper_dom.fuf_variables.real_table.show();$.each(files,function(file_id,file){file.icon=wrapper_dom.fuf_variables.default_file_icon;file.urls={"delete":"javascript:void(0);"};file.file_size="";wrapper_dom.fuf_variables.real_table.append(render_file.apply(wrapper_dom,[file]).append(render_upload_progress()))});if(this.fuf_variables.uploader.state==plupload.STOPPED){setTimeout(function(){wrapper_dom.fuf_variables.uploader.start()},20)}};var render_upload_progress=function(){var render="";render+='<div class="file_progress">';render+='<div class="overlay"></div>';render+='<div class="progressbar">';render+='<div class="progressbar_inner" style="width: 0%"></div>';render+="</div>";render+="</div>";return $(render)};var render_file=function(file){var wrapper_dom=this;var render="";render+='<li class="file" row_id="'+file.id+'">';render+='<div class="icon">';render+='<img src="'+file.icon+'" />';render+="</div>";render+='<div class="info">';render+='<div class="top">'+file.name+"</div>";render+='<div class="bottom">';render+='<span class="file_size">'+file.file_size+"</span>";render+="</div>";render+="</div>";render+='<div class="controls">';render+='<a href="'+file.urls["delete"]+'" class="delete"><img src="'+wrapper_dom.fuf_variables.delete_icon_url+'" /></a>';render+="</div>";render+="</li>";return $(render)};var get_file_placeholder=function(file_id){return this.fuf_variables.real_table.find("li[row_id="+file_id+"]")};var update_file_progress=function(file){get_file_placeholder.apply(this,[file.id]).find("div.progressbar div:first").css("width",file.percent+"%")};var upload_error=function(error){var file=error.file;var row=get_file_placeholder.apply(this,[file.id]);row.remove();if(error.message){App.Wireframe.Flash.error(error.message)}else{App.Wireframe.Flash.error("Upload Failed")}this.fuf_variables.uploader.refresh()};var finalize_file_upload=function(file,response){var row=get_file_placeholder.apply(this,[file.id]);if(!row.length){return false}row.find(".icon img").attr("src",response.icon);row.find(".file_size").text(response.file_size);row.find("a.delete").attr("href",response.urls["delete"]);row.find("div.file_progress").hide()};var remove_file=function(delete_link){var wrapper=$(this);var wrapper_dom=this;var file=delete_link.parents("li:first");var file_id=file.attr("row_id");$.ajax({url:delete_link.attr("href"),type:"POST",data:{submitted:"submitted"}});this.fuf_variables.uploader.removeFile(file_id);file.remove();if(!this.fuf_variables.real_table.children().length){this.fuf_variables.empty_page.show();this.fuf_variables.real_table.hide()}};var plugin_name="templateFileUpload";var settings={};$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on jQuery."+plugin_name)}}}})(jQuery);