(function($){var public_methods={init:function(options){return this.each(function(){var wrapper=$(this);var wrapper_dom=this;var users=options.users;delete options.users;this.ov_data={settings:jQuery.extend({},options),items:{}};this.ov_data.settings.users={};$.each(users,function(){wrapper_dom.ov_data.settings.users[this.id]=this});delete users;render_initial_items.apply(this);render_header.apply(this);render_mass_edit.apply(this);render_focus_field.apply(this);handle_interaction.apply(this);handle_events.apply(this)})}};var render_header=function(){var wrapper=$(this);var wrapper_dom=this;var wrapper_background=wrapper.css("background-color");this.ov_data.header=$('<div class="project_outline_header"></div>').prependTo(wrapper);this.ov_data.higlighter=form_controls.object_responsible.apply(this,["higlight",null,App.lang("Everyone's")]).find("select:first").attr("id","higlight").prependTo(this.ov_data.header);this.ov_data.higlighter.after('&nbsp;&nbsp;<label for="higlight">'+App.lang("assignments are highlighted")+"</label>").change(function(){var value=$(this).val();wrapper.removeClass("higlight_mode");wrapper.find("style#higlight").remove();if(value>0){wrapper.append('<style type="text/css" id="higlight">span.row.assignee_id_'+value+" { background-color: "+wrapper_background+" }</style>").addClass("higlight_mode")}});this.ov_data.expand_milestones_wrapper=$('<div class="expand_milestones_wrapper"></div>').appendTo(this.ov_data.header);this.ov_data.expand_milestones=$('<a href="#">'+App.lang("Expand All Milestones")+"</a>").appendTo(this.ov_data.expand_milestones_wrapper).click(function(){var project_node=wrapper.find("a.project");if(project_node.is(".collapsed")){expand_item.apply(wrapper_dom,[project_node,function(){expand_all_milestones.apply(wrapper_dom)}])}else{if(wrapper.find("a.milestone.collapsed").length){expand_all_milestones.apply(wrapper_dom)}else{collapse_all_milestones.apply(wrapper_dom)}}return false})};var render_mass_edit=function(){var wrapper=$(this);var wrapper_dom=this;this.ov_data.mass_edit_wrapper=$('<div class="mass_edit_wrapper"></div>').appendTo(wrapper);this.ov_data.mass_edit=$('<div class="mass_edit_section"></div>').appendTo(this.ov_data.mass_edit_wrapper);this.ov_data.navigation_hint=$('<div class="navigation_hint">'+App.lang('While in browse mode, you can use <a href="#">keyboard shortcuts</a>.')+"</div>").appendTo(this.ov_data.mass_edit_wrapper);this.ov_data.navigation_hint.find("a:first").flyout({title:App.lang("Outline Keyboard Shortcuts"),href:wrapper_dom.ov_data.settings.shortcuts_url,close:function(){wrapper_dom.ov_data.focus_field.focus()}});this.ov_data.mass_edit_hint=$('<div class="mass_edit_hint">'+App.lang("You can drag items to reorder them or you can perform actions on multiple items.")+"</div>").appendTo(this.ov_data.mass_edit_wrapper);this.ov_data.mass_edit_action=$('<select id="mass_edit_action"></select>').appendTo(this.ov_data.mass_edit).before('<label for="mass_edit_action">'+App.lang("With selected:")+"</label>");this.ov_data.mass_edit_action.append('<option value="change_category">'+App.lang("Change Category")+"</option>").append('<option value="change_label">'+App.lang("Change Label")+"</option>").append('<option value="change_assignee">'+App.lang("Change Responsible Person")+"</option>");this.ov_data.mass_edit_action.find("option").attr("disabled",true);this.ov_data.mass_edit_action.prepend('<option value="">-- '+App.lang("Do nothing")+" --</option>").val(0);wrapper.delegate('span.checkbox_wrapper input[type="checkbox"]',"click",function(event){var row=$(this).parents("span.row:first");if(row.is(".selected")){row.removeClass("selected")}else{row.addClass("selected")}update_mass_options.apply(wrapper_dom);event.stopPropagation()});this.ov_data.mass_edit_action.change(function(){var value=$(this).val();render_mass_edit_form.apply(wrapper_dom,[value])});this.ov_data.mass_edit_button=$('<button class="mass_edit_button">'+App.lang("Enter Mass Edit Mode")+"</button>").insertBefore(this.ov_data.mass_edit).click(function(){if(!wrapper.is(".mass_edit_mode")){wrapper.addClass("mass_edit_mode");wrapper_dom.ov_data.focus_field.blur().attr("disabled",true);wrapper_dom.ov_data.mass_edit.show();wrapper_dom.ov_data.mass_edit_button.html(App.lang("Exit Mass Edit Mode"));wrapper_dom.ov_data.navigation_hint.hide();wrapper_dom.ov_data.mass_edit_hint.show();close_form.apply(wrapper_dom);wrapper.find("ul:first ul.subobjects").each(function(){initialize_dragging.apply(wrapper_dom,[$(this)])});wrapper.find("span.row.milestone.can_accept_subobjects, span.row.task.can_accept_subobjects, span.row.todolist.can_accept_subobjects").each(function(){initialize_droppable.apply(wrapper_dom,[$(this)])})}else{wrapper.removeClass("mass_edit_mode");wrapper_dom.ov_data.focus_field.attr("disabled",false).focus();wrapper_dom.ov_data.mass_edit.hide();wrapper_dom.ov_data.mass_edit_button.html(App.lang("Enter Mass Edit Mode"));wrapper_dom.ov_data.navigation_hint.show();wrapper_dom.ov_data.mass_edit_hint.hide()}})};var render_mass_edit_form=function(type){var wrapper=$(this);var wrapper_dom=this;this.ov_data.mass_edit_wrapper.find("form.mass_edit_form").remove();if(!type){return false}var mass_edit_form=$('<form method="POST" class="mass_edit_form" action="'+this.ov_data.settings.mass_edit_urls[type]+'" action_type="'+type+'"></form>').insertAfter(this.ov_data.mass_edit_action);switch(type){case"change_assignee":mass_edit_form.append(form_controls.object_responsible.apply(this,["data",null]));break;case"change_label":mass_edit_form.append(form_controls.object_label.apply(this,["data","task",null]));break;case"change_category":mass_edit_form.append(form_controls.object_category.apply(this,["data","task"]));break}mass_edit_form.append('<button type="submit" class="default">'+App.lang("Submit")+"</button>");mass_edit_form.submit(function(){wrapper_dom.ov_data.mass_edit.block();var data={submitted:"submitted",selected_items:{milestone:new Array(),task:new Array(),todolist:new Array(),subtask:new Array()}};wrapper.find("span.row.selected").each(function(){var row=$(this);data.selected_items[row.attr("object_type")].push(row.attr("real_object_id"))});switch(mass_edit_form.attr("action_type")){case"change_assignee":data.assignee_id=mass_edit_form.find("select:first").val();break;case"change_label":data.label_id=mass_edit_form.find("select:first").val();break;case"change_category":data.category_id=mass_edit_form.find("select:first").val();break}$.ajax({url:mass_edit_form.attr("action"),data:data,type:"POST",success:function(response){if(!response||!response.length){App.Wireframe.Flash.error("Update failed, no objects were modified")}wrapper_dom.ov_data.mass_edit.unblock();wrapper_dom.ov_data.mass_edit_wrapper.find("form.mass_edit_form").remove();wrapper_dom.ov_data.mass_edit_action.val(0);$.each(response,function(){update_object.apply(wrapper_dom,[this])});if(response.length>1){App.Wireframe.Flash.success("Update successful, :number objects were modified",{number:response.length})}else{App.Wireframe.Flash.success("Object has been updated")}},error:function(response){App.Wireframe.Flash.error("Update failed, no objects were modified")}});return false})};var update_mass_options=function(){var wrapper=$(this);var selector=wrapper.find("select#mass_edit_action");var category_option_active=true;var milestones_selected=$('span.row.selected[object_type="milestone"]').length;var tasks_selected=$('span.row.selected[object_type="task"]').length;var todos_selected=$('span.row.selected[object_type="todolist"]').length;var subtasks_selected=$('span.row.selected[object_type="subtask"]').length;var category_option=selector.find('option[value="change_category"]');if(!milestones_selected&&!subtasks_selected&&!todos_selected&&tasks_selected){category_option.attr("disabled",false)}else{if(selector.val()==category_option.val()){selector.val(0);this.ov_data.mass_edit_wrapper.find("form.mass_edit_form").remove()}category_option.attr("disabled",true)}var assignee_option=selector.find('option[value="change_assignee"]');if(!todos_selected&&(milestones_selected||tasks_selected||subtasks_selected)){assignee_option.attr("disabled",false)}else{if(selector.val()==assignee_option.val()){selector.val(0);this.ov_data.mass_edit_wrapper.find("form.mass_edit_form").remove()}else{assignee_option.attr("disabled",true)}}var label_option=selector.find('option[value="change_label"]');if(!milestones_selected&&!todos_selected&&(tasks_selected||subtasks_selected)){label_option.attr("disabled",false)}else{if(selector.val()==label_option.val()){selector.val(0);this.ov_data.mass_edit_wrapper.find("form.mass_edit_form").remove()}label_option.attr("disabled",true)}};var initialize_dragging=function(element){var wrapper_dom=this;var connect_with=null;var element_class=element.attr("class").split(" ");if(element_class.length){for(var index in element_class){if(element_class[index]!="subobjects"){if(element_class[index].indexOf("subobjects")>-1){connect_with=element_class[index];break}}}}if(connect_with=="task_subobjects"||connect_with=="todolist_subobjects"){connect_with=".task_subobjects, .todolist_subobjects"}else{if(connect_with){connect_with="."+connect_with}}var element_row=element.prev("span.row");element.sortable({forcePlaceholderSize:true,forceHelperSize:true,items:"> li.outline_level.can_be_reordered",handle:"span.pills_wrapper:first",axis:"y",connectWith:connect_with,update:function(event,ui){if(element.is(".removed_item")){element.removeClass("removed_item");return true}save_order.apply(wrapper_dom,[element])},out:function(){element.addClass("removed_item")},over:function(){element.removeClass("removed_item")},receive:function(event,ui){var received_row=ui.item.find("span.row:first");var received_item=get_item.apply(wrapper_dom,[received_row.attr("real_object_id"),received_row.attr("object_type")]);if(element_row.is(".milestone")){received_item.milestone_id=element_row.attr("real_object_id")}else{received_item.parent_id=element_row.attr("real_object_id");received_item.parent_type=get_class_name(element_row.attr("object_type"))}store_item.apply(wrapper_dom,[received_item])}});element.find("li.outline_level.can_be_moved:not(.can_be_reordered)").each(function(){$(this).draggable({handle:"span.pills_wrapper:first",axis:"y",zIndex:"10000",revert:true})})};var save_order=function(element){var wrapper_dom=this;var children=element.children("li");if(!children.length){return true}var data={submitted:"submitted",milestone:[],task:[],todolist:[],subtask:[]};children.each(function(){var row=$(this).find("span.row:first");data[row.attr("object_type")].push(row.attr("real_object_id"))});var row=element.prev("span.row");var url=this.ov_data.settings.reorder_url.replace("--OBJECT-ID--",row.attr("object_id")).replace("--OBJECT-TYPE--",row.attr("object_type"));$.ajax({url:url,type:"POST",data:data,success:function(response){if(response&&response.length){$.each(response,function(){store_item.apply(wrapper_dom,[this])})}}})};var initialize_droppable=function(element){if(!element.is(".can_accept_subobjects")){return false}var wrapper_dom=this;var accept="";if(element.is(".milestone")){accept="li.task_container, li.todolist_container"}else{if(element.is(".task, .todolist")){accept="li.subtask_container"}}var parent_list_element=element.parents("li.outline_level:first");var parent_anchor=parent_list_element.find("a.object_name:first");element.droppable({accept:accept,tolerance:"pointer",over:function(){element.addClass("drop_target")},out:function(){element.removeClass("drop_target")},drop:function(event,ui){element.removeClass("drop_target");var container_list=parent_list_element.children("ul.subobjects:first");var container_list_children=container_list.children("li.outline_level");if(parent_anchor.is(".expanded")){if(!container_list.length){container_list=$('<ul class="subobjects '+parent_anchor.attr("object_class")+'_subobjects"></ul>').appendTo(parent_list_element)}var new_row=ui.draggable.clone();new_row.attr("style","").removeClass("ui-sortable-helper").removeClass("ui-draggable-dragging").appendTo(container_list);ui.draggable.remove();setTimeout(function(){initialize_dragging.apply(wrapper_dom,[container_list]);initialize_droppable.apply(wrapper_dom,[new_row.find("span.row:first")]);save_order.apply(wrapper_dom,[container_list])},100);return true}else{if(parent_anchor.is(".collapsed")){var temporary_list=parent_list_element.children("ul.temporary:first");if(!temporary_list.length){temporary_list=$('<ul class="temporary"></ul>').appendTo(parent_list_element)}ui.draggable.clone().attr("style","").removeClass("ui-sortable-helper").removeClass("ui-draggable-dragging").appendTo(temporary_list);ui.draggable.remove();if(!parent_anchor.is(".expanding")){expand_item.apply(wrapper_dom,[parent_anchor,function(rendered_subitems){var temporary_children=temporary_list.children("li.outline_level");if(temporary_children.length){temporary_children.each(function(){var temporary_child=$(this);temporary_child.appendTo(rendered_subitems);initialize_droppable.apply(wrapper_dom,[temporary_child.find("span.row:first")])});temporary_list.remove();initialize_dragging.apply(wrapper_dom,[rendered_subitems]);save_order.apply(wrapper_dom,[rendered_subitems])}}])}return true}}}})};var form_controls={get_unique_id:function(control_id){return this.ov_data.form_id+"_"+control_id},render_wrapper:function(label){var control_wrapper=$('<div class="control_holder"></div>');if(label){control_wrapper.append('<label class="main_label">'+label+"</label>")}return control_wrapper},object_body:function(field_name_prefix,value,parent){var wrapper_dom=this;var control_wrapper=form_controls.render_wrapper(false);if(parent&&parent.length){control_wrapper.appendTo(parent)}var id=form_controls.get_unique_id.apply(this,["body_field"]);var field=$('<div id="'+id+'"></div>').appendTo(control_wrapper).visualEditor({name:field_name_prefix+"[body]",value:value?value:"",embeded_name:field_name_prefix+"[embeded_objects]",auto_size:false,vertical_resize:true});return control_wrapper},milestone_schedule:function(field_name_prefix,start_on,due_on){var control_wrapper=form_controls.render_wrapper(App.lang("Start and Due Date"));var tbd_option=$('<input type="radio" class="inline tbd_option" name="'+field_name_prefix+'[to_be_determined]" value="1" id="'+form_controls.get_unique_id.apply(this,["milestone_tbd"])+'" />').appendTo($('<div class="select_milestone_dates_option"></div>').appendTo(control_wrapper));$('<label class="inline" for="'+tbd_option.attr("id")+'"> '+App.lang("To Be Determined")+"</label>").insertAfter(tbd_option);var schedule_option=$('<input type="radio" class="inline schedule_option" name="'+field_name_prefix+'[to_be_determined]" value="0" id="'+form_controls.get_unique_id.apply(this,["milestone_set_now"])+'" />').appendTo($('<div class="select_milestone_dates_option"></div>').appendTo(control_wrapper));$('<label class="inline" for="'+schedule_option.attr("id")+'"> '+App.lang("Set Now")+"</label>").insertAfter(schedule_option);var date_range=$('<div class="select_milestone_date_range"><table><tbody><tr><td></td><td>&mdash;</td><td></td></tr></tbody></table></div>').appendTo(schedule_option.parent());var start_on_picker=$('<input type="text" class="input_text input_date" name="'+field_name_prefix+'[start_on]" />').appendTo($('<span class="select_date"></span>').appendTo(date_range.find("tbody tr:first td:first")));var due_on_picker=$('<input type="text" class="input_text input_date" name="'+field_name_prefix+'[due_on]" />').appendTo($('<span class="select_date"></span>').appendTo(date_range.find("tbody tr:first td:last")));if(start_on||due_on){schedule_option.attr("checked",true);date_range.css("visibility","visible")}else{tbd_option.attr("checked",true);date_range.css("visibility","hidden")}tbd_option.click(function(){date_range.css("visibility","hidden")});schedule_option.click(function(){date_range.css("visibility","visible")});var start_date=new Date(2000,1,1);var end_date=new Date(2050,1,1);var date_picker_options={minDate:start_date,maxDate:end_date,yearRange:start_date.getFullYear()+":"+end_date.getFullYear(),firstDay:App.Config.get("first_week_day"),dateFormat:"yy/mm/dd",hideIfNoPrevNext:true,showAnim:"blind",duration:0,changeYear:true,showOn:"both",buttonImage:App.Wireframe.Utils.imageUrl("/icons/16x16/calendar.png","system"),buttonImageOnly:true,buttonText:App.lang("Select Date"),beforeShowDay:App.noWeekendsAndDaysOff};var start_on_options=date_picker_options;var due_on_options=date_picker_options;if(start_on){start_on_object=new Date(start_on.timestamp*1000);start_on_options.defaultDate=start_on_object;start_on_picker.val(start_on_object.toString("yyyy/M/dd"))}if(due_on){due_on_object=new Date(due_on.timestamp*1000);due_on_options.defaultDate=due_on_object;due_on_picker.val(due_on_object.toString("yyyy/M/dd"))}start_on_picker.datepicker(start_on_options);due_on_picker.datepicker(due_on_options);return control_wrapper},object_priority:function(field_name_prefix,value){var control_wrapper=form_controls.render_wrapper(App.lang("Priority"));var control=$('<select name="'+field_name_prefix+'[priority]"></select>').appendTo(control_wrapper);control.append('<option value="2">'+App.lang("Highest")+"</option>").append('<option value="1">'+App.lang("High")+"</option>").append('<option value="0">'+App.lang("Normal")+"</option>").append('<option value="-1">'+App.lang("Low")+"</option>").append('<option value="-2">'+App.lang("Lowest")+"</option>");value=value?value:0;control.val(value);return control_wrapper},object_visibility:function(field_name_prefix,value){value=typeof value!=="undefined"?value:this.ov_data.settings.default_visibility;var control_wrapper=form_controls.render_wrapper(App.lang("Visibility"));var control=$('<select name="'+field_name_prefix+'[visibility]"></select>').appendTo(control_wrapper);control.append('<option value="1">'+App.lang("Normal")+"</option>").append('<option value="0">'+App.lang("Private")+"</option>");control.val(value);return control_wrapper},object_due_on:function(field_name_prefix,value){var control_wrapper=form_controls.render_wrapper(App.lang("Due On"));var control_span=$('<span class="select_date"></span>').appendTo(control_wrapper);var control=$('<input class="input_text input_date" autocomplete="off" name="'+field_name_prefix+'[due_on]">').appendTo(control_span);var start_date=new Date(2000,1,1);var end_date=new Date(2050,1,1);var date_picker_options={minDate:start_date,maxDate:end_date,yearRange:start_date.getFullYear()+":"+end_date.getFullYear(),firstDay:App.Config.get("first_week_day"),dateFormat:"yy/mm/dd",hideIfNoPrevNext:true,showAnim:"blind",duration:0,changeYear:true,showOn:"both",buttonImage:App.Wireframe.Utils.imageUrl("/icons/16x16/calendar.png","system"),buttonImageOnly:true,buttonText:App.lang("Select Date")};if(value){var value_date=new Date(value.timestamp*1000);date_picker_options.defaultDate=value_date;control.val(value_date.toString("yyyy/MM/dd"))}control.datepicker(date_picker_options);return control_wrapper},object_category:function(field_name_prefix,object_type,value){var categories;if(!(categories=this.ov_data.settings.categories[object_type])){return""}var control_wrapper=form_controls.render_wrapper(App.lang("Category"));var control=$('<select name="'+field_name_prefix+'[category_id]"></select>').appendTo(control_wrapper);control.append('<option value="0">'+App.lang("None")+"</option>");App.each(categories,function(category_id,category_name){control.append('<option value="'+category_id+'">'+App.clean(category_name)+"</option>")});value=value?value:0;control.val(value);return control_wrapper},object_milestone:function(field_name_prefix,value){var control=$('<input type="hidden" name="'+field_name_prefix+'[milestone_id]" value="'+(value?value:"")+'" />');return control},object_label:function(field_name_prefix,object_type,value){var label_type=false;switch(object_type){case"project":label_type="ProjectLabel";break;default:label_type="AssignmentLabel";break}if(!value){value=this.ov_data.settings.default_labels[label_type]}if(this.ov_data.settings.labels instanceof App.Map&&this.ov_data.settings.labels.isset(label_type)){var labels=this.ov_data.settings.labels.get(label_type)}if(typeof(labels)=="undefined"||!jQuery.isArray(labels)||labels.length<1){return""}var control_wrapper=form_controls.render_wrapper(App.lang("Label"));var control=$('<select name="'+field_name_prefix+'[label_id]"></select>').appendTo(control_wrapper);control.append('<option value="0">'+App.lang("No label")+"</option>");App.each(labels,function(label_id,label){control.append('<option value="'+label_id+'">'+App.clean(label.name)+"</option>")});value=value?value:0;control.val(value);return control_wrapper},object_responsible:function(field_name_prefix,value,empty_option_label){var control_wrapper=form_controls.render_wrapper(App.lang("Assignee"));var users=this.ov_data.settings.users_map;var companies=this.ov_data.settings.companies_map;if(!empty_option_label){empty_option_label=App.lang("Nobody")}var control=$('<select name="'+field_name_prefix+'[assignee_id]"></select>').appendTo(control_wrapper);control.append('<option value="0">'+empty_option_label+"</option>");$.each(companies,function(company_id){if(users[company_id]){var group=$('<optgroup label="'+App.clean(this)+'"></optgroup>');$.each(users[company_id],function(user_id){group.append('<option value="'+user_id+'">'+App.clean(this)+"</option>")});group.appendTo(control)}});value=value?value:0;control.val(value);return control_wrapper},object_estimate:function(field_name_prefix,estimate_value,job_type_value){var control_wrapper=form_controls.render_wrapper(App.lang("Estimate"));var estimate_picker=$("<span></span>").appendTo(control_wrapper).selectEstimate({name:field_name_prefix+"[estimate_value]",value:estimate_value,optional:true,"short":true});if(this.ov_data.settings.job_types_map){var job_type_picker=$('<select name="'+field_name_prefix+'[estimate_job_type_id]" class="select_job_type short"></select>').insertAfter(estimate_picker);App.each(this.ov_data.settings.job_types_map,function(job_id,job_name){job_type_picker.append('<option value="'+job_id+'">'+App.clean(job_name)+"</option>")})}job_type_picker.val(job_type_value).before(" "+App.lang("of")+" ");return control_wrapper},form_submit:function(button_label){return'<button accesskey="s" type="submit" class="default">'+button_label+"</button> "+App.lang("or")+' <a class="cancel" href="#">'+App.lang("Close")+"</a>"},object_assignees:function(field_name_prefix,value){var companies_map=this.ov_data.settings.companies_map;var users_map=this.ov_data.settings.users_map;var data={};$.each(users_map,function(company_id){data[companies_map[company_id]]=this});var control_wrapper=form_controls.render_wrapper(App.lang("Assignees"));var control=$("<div></div>").selectAssignees({data:data,name:field_name_prefix+"[other_assignees]",responsible_name:field_name_prefix+"[assignee_id]",choose_responsible:true,choose_subscribers:value?false:true,assignees:(value?value.other_assignees?value.other_assignees:null:null),responsible_user_id:(value?value.assignee?value.assignee:null:null)});control.appendTo(control_wrapper);return control_wrapper}};var get_add_url=function(type,parent_id,parent_type){if(type=="milestone"){return this.ov_data.settings.add_urls[type]}else{if(type=="task"||type=="todolist"){return this.ov_data.settings.add_urls[type].replace("--PARENT-ID--",parent_id)}else{if(type=="subtask"){return this.ov_data.settings.add_urls[parent_type+"_"+type].replace("--PARENT-ID--",parent_id)}}}};var get_form_title=function(type,mode){if(!mode||mode=="add"){switch(type){case"milestone":return App.lang("Add new milestone");break;case"task":return App.lang("Add new task");break;case"todolist":return App.lang("Add new todo list");break;case"subtask":return App.lang("Add new subtask");break}}else{switch(type){case"milestone":return App.lang("Edit milestone");break;case"task":return App.lang("Edit task");break;case"todolist":return App.lang("Edit todo list");break;case"subtask":return App.lang("Edit subtask");break}}};var get_item_breadcrumbs=function(parent){var return_string="";parent.parents("li.outline_level").each(function(){var node_level=$(this).find("a.object_name:first").clone();node_level.find("strong").remove();return_string=node_level.html().replace("&nbsp;","")+(return_string?" <strong>&gt;</strong> "+return_string:"")});return return_string};var assemble_form=function(mode,parent,type,data){if(this.ov_data.form&&!confirm(App.lang("You already have one form open. Discard changes in that one, and open a new one?"))){return false}if(this.ov_data.form){close_form.apply(this)}var wrapper_dom=this;var wrapper=$(this);var parent_row=parent.parents("span.row:first");var field_name_prefix=type;field_name_prefix=(field_name_prefix=="todolist"?"todo_list":field_name_prefix);if(!data){data={}}this.ov_data.form=$('<form class="add_edit_form '+type+'_subobject_form" action="" method="POST"></form>');this.ov_data.form_inner=$('<div class="form_inner"></div>').appendTo(this.ov_data.form);this.ov_data.form_id="outline_form_"+new Date().getTime();var form_title=$('<div class="form_title"></div>').appendTo(this.ov_data.form_inner);if(mode=="add"){this.ov_data.form.attr("action",get_add_url.apply(this,[type,parent_row.attr("object_id"),parent_row.attr("object_type")])).appendTo(parent.parents("li:first"));form_title.html(get_form_title.apply(this,[type,"add"])+'<span class="breadcrumbs">'+get_item_breadcrumbs.apply(this,[parent])+"</span>")}else{this.ov_data.form.attr("action",data.urls.edit).insertAfter(parent_row);form_title.html(get_form_title.apply(this,[type,"edit"]));parent_row.block()}var sidebar_fields=$('<div class="sidebar_fields"></div>').appendTo(this.ov_data.form_inner);var main_fields=$('<div class="main_fields"></div>').appendTo(this.ov_data.form_inner);var inline_fields=$('<div class="inline_fields"></div>').appendTo(this.ov_data.form_inner);var buttons=$('<div class="button_holder"></div>').appendTo(this.ov_data.form_inner);var assignee_id=data.assignee_id?data.assignee_id:(data.assignee?data.assignee.id:null);var other_assignees=new Array();if(data.other_assignees){$.each(data.other_assignees,function(){other_assignees.push(this.id)})}if(type=="milestone"){$('<input type="text" class="text_field title" name="'+field_name_prefix+'[name]" />').appendTo($('<div class="control_holder"></div>').appendTo(main_fields)).val(data.name?data.name:"");form_controls.object_body.apply(this,[field_name_prefix,data.body,main_fields]);sidebar_fields.append(form_controls.object_assignees.apply(this,[field_name_prefix,{assignee:assignee_id,other_assignees:other_assignees}]));inline_fields.append(form_controls.object_priority.apply(this,[field_name_prefix,data.priority]));if(mode=="add"){inline_fields.append(form_controls.milestone_schedule.apply(this,[field_name_prefix,data.start_on,data.due_on]))}buttons.append(form_controls.form_submit.apply(this,[(mode=="add"?App.lang("Add Milestone"):App.lang("Save Changes"))]))}else{if(type=="task"){$('<input type="text" class="text_field title" name="'+field_name_prefix+'[name]" />').appendTo($('<div class="control_holder"></div>').appendTo(main_fields)).val(data.name?data.name:"");form_controls.object_body.apply(this,[field_name_prefix,data.body,main_fields]);sidebar_fields.append(form_controls.object_assignees.apply(this,[field_name_prefix,{assignee:assignee_id,other_assignees:other_assignees}]));inline_fields.append(form_controls.object_category.apply(this,[field_name_prefix,type,(data.category?data.category.id:data.category_id)]));inline_fields.append(form_controls.object_milestone.apply(this,[field_name_prefix,(mode=="add"?parent_row.attr("object_id"):data.milestone_id)]));inline_fields.append(form_controls.object_priority.apply(this,[field_name_prefix,data.priority]));inline_fields.append(form_controls.object_visibility.apply(this,[field_name_prefix,data.visibility]));inline_fields.append(form_controls.object_label.apply(this,[field_name_prefix,type,data.label?data.label.id:data.label_id]));if(this.ov_data.settings.permissions.can_use_tracking){if(mode=="edit"&&typeof(data.estimate)=="object"&&data.estimate){var estimate_value=data.estimate["value"];var estimate_job_type_id=data.estimate["job_type_id"]}else{var estimate_value=0;var estimate_job_type_id=0}inline_fields.append(form_controls.object_estimate.apply(this,[field_name_prefix,estimate_value,estimate_job_type_id]))}inline_fields.append(form_controls.object_due_on.apply(this,[field_name_prefix,data.due_on]));buttons.append(form_controls.form_submit.apply(this,[(mode=="add"?App.lang("Add Task"):App.lang("Save Changes"))]))}else{if(type=="todolist"){$('<input type="text" class="text_field title" name="'+field_name_prefix+'[name]" />').appendTo($('<div class="control_holder"></div>').appendTo(main_fields)).val(data.name?data.name:"");form_controls.object_body.apply(this,[field_name_prefix,data.body,main_fields]);inline_fields.append(form_controls.object_category.apply(this,[field_name_prefix,type,(data.category?data.category.id:data.category_id)]));inline_fields.append(form_controls.object_milestone.apply(this,[field_name_prefix,(mode=="add"?parent_row.attr("object_id"):data.milestone_id)]));inline_fields.append(form_controls.object_visibility.apply(this,[field_name_prefix,data.visibility]));buttons.append(form_controls.form_submit.apply(this,[(mode=="add"?App.lang("Add Todo List"):App.lang("Save Changes"))]))}else{$('<input type="text" class="text_field title" name="'+field_name_prefix+'[body]" />').appendTo($('<div class="control_holder"></div>').appendTo(main_fields)).val(data.name?data.name:"");inline_fields.append(form_controls.object_responsible.apply(this,[field_name_prefix,assignee_id]));inline_fields.append(form_controls.object_priority.apply(this,[field_name_prefix,data.priority]));inline_fields.append(form_controls.object_label.apply(this,[field_name_prefix,type,(data.label?data.label.id:data.label_id)]));inline_fields.append(form_controls.object_due_on.apply(this,[field_name_prefix,data.due_on]));buttons.append(form_controls.form_submit.apply(this,[(mode=="add"?App.lang("Add Subtask"):App.lang("Save Changes"))]))}}}this.ov_data.form.append('<input type="hidden" name="submitted" value="submitted" />');this.ov_data.main_list.scrollTo(this.ov_data.form,{offset:{top:-30}});main_fields.find('input[type="text"]:first').focus().keyup(function(event){if(event.keyCode==27){close_form.apply(wrapper_dom)}});buttons.find("a.cancel").click(function(){close_form.apply(wrapper_dom);return false});if(mode=="add"){this.ov_data.form.submit(function(){var validation_result=validate_form.apply(wrapper_dom,[type]);if(validation_result!==true){App.Wireframe.Flash.error(validation_result);return false}var list=parent_row.next("ul.subobjects");if(!list.length){list=$('<ul class="subobjects '+parent_row.attr("object_type")+'_subobjects"></ul>').insertAfter(parent_row)}var working_row=$('<li class="working_row"><span class="inner"><img src="'+App.Wireframe.Utils.indicatorUrl("small")+'" />'+App.lang("Working")+"</span></li>");if(type=="milestone"){working_row.insertBefore(wrapper.find("span.row.milestone.faux_milestone").parents("li:first"))}else{working_row.appendTo(list)}$.ajax({type:"POST",data:wrapper_dom.ov_data.form.serialize(),url:wrapper_dom.ov_data.form.attr("action"),success:function(response){var new_item=render_item.apply(wrapper_dom,[response]).insertAfter(working_row);wrapper.find("span.row.current").removeClass("current");new_item.find("span.row").addClass("current");working_row.remove();store_item.apply(wrapper_dom,[response])},error:function(response){App.Wireframe.Flash.error("Failed to add object")}});reset_form.apply(wrapper_dom);return false})}else{this.ov_data.form.submit(function(){var validation_result=validate_form.apply(wrapper_dom,[type]);if(validation_result!==true){App.Wireframe.Flash.error(validation_result);return false}wrapper_dom.ov_data.form.block();$.ajax({type:"POST",data:wrapper_dom.ov_data.form.serialize(),url:wrapper_dom.ov_data.form.attr("action"),success:function(response){var row=render_item.apply(wrapper_dom,[response]).find("span.row:first").insertAfter(parent_row);var anchor=row.find("a.object_name:first");mark_item_selected.apply(wrapper_dom,[anchor]);if(parent_row.find("a.object_name:first").is(".expanded")){anchor.addClass("expanded").removeClass("collapsed")}store_item.apply(wrapper_dom,[response]);parent_row.remove();close_form.apply(wrapper_dom)},error:function(response){wrapper_dom.ov_data.form.unblock();App.Wireframe.Flash.error("Failed to update object")}});return false})}};var validate_form=function(type){var messages=[];var title_val=this.ov_data.form.find("input.text_field.title").val();if(!(title_val)){messages.push(App.lang("Title is required"))}if(type=="milestone"){if(this.ov_data.form.find("input.schedule_option").is(":checked")){var first_input=this.ov_data.form.find(".select_milestone_date_range input.input_date:first");var last_input=this.ov_data.form.find(".select_milestone_date_range input.input_date:last");if(first_input.val()||last_input.val()){if(!first_input.val()){messages.push(App.lang("Milestone start date is required"))}else{if(!last_input.val()){messages.push(App.lang("Milestone due date is required"))}else{var js_start_date=new Date(first_input.val()).getTime();var js_end_date=new Date(last_input.val()).getTime();if(js_start_date===NaN){messages.push(App.lang("Milestone start date is in invalid format"))}if(js_end_date===NaN){messages.push(App.lang("Milestone due date is in invalid format"))}if(js_start_date!==NaN&&js_end_date!==NaN&&(js_end_date<js_start_date)){messages.push(App.lang("Milestone due date can't come before milestone start date"))}}}}}}if(messages.length){return messages.join("<br />")}return true};var reset_form=function(){this.ov_data.form.find("input.text_field.title").attr("value","").focus();this.ov_data.form.find("textarea").val("");this.ov_data.form.find("textarea.visual_editor_textarea").each(function(){$(this).visualEditor("setContent","")});return true};var close_form=function(){if(!this.ov_data.form){return false}this.ov_data.main_list.scrollTo(get_current_item.apply(this),{offset:{top:-20}});this.ov_data.form.prev("span.row").unblock();this.ov_data.form.remove();this.ov_data.form=null;this.ov_data.focus_field.focus()};var handle_interaction=function(){var wrapper=$(this);var wrapper_dom=this;wrapper.delegate("a.object_name","click",function(event){var anchor=$(this);var target=$(event.target);if(!target.is(".quick_view_preview_indicator, .quick_view_preview_indicator_inner, .quick_view_preview_indicator_inner_eye")){expander_click.apply(this,[wrapper_dom]);return false}else{quick_view_object.apply(this,[anchor]);return false}});wrapper.delegate("a.checkbox","click",function(event){complete_object.apply(wrapper_dom,[$(this)]);return false});wrapper.delegate("a.add_milestone","click",function(event){add_milestone.apply(wrapper_dom,[$(this).parents("span.row:first").find("a.object_name")]);return false});wrapper.delegate("a.add_task","click",function(event){add_task.apply(wrapper_dom,[$(this).parents("span.row:first").find("a.object_name")]);return false});wrapper.delegate("a.add_todolist","click",function(event){add_todolist.apply(wrapper_dom,[$(this).parents("span.row:first").find("a.object_name")]);return false});wrapper.delegate("a.add_subtask","click",function(event){add_subtask.apply(wrapper_dom,[$(this).parents("span.row:first").find("a.object_name")]);return false});wrapper.delegate("a.edit","click",function(event){edit_object.apply(wrapper_dom,[$(this).parents("span.row:first").find("a.object_name")]);return false});wrapper.delegate("a.delete","click",function(event){delete_object.apply(wrapper_dom,[$(this).parents("span.row:first").find("a.object_name")]);return false});wrapper.delegate("span.row","click",function(event){var target=$(event.target);if(!target.is(".quick_view_preview_indicator")){var anchor=$(this).find("a.object_name:first");expand_item.apply(wrapper_dom,[anchor]);mark_item_selected.apply(wrapper_dom,[anchor])}})};var complete_object=function(checkbox){var wrapper_dom=this;if(checkbox.is(".completing")||checkbox.is(".disabled")){return false}var row=checkbox.parents("span.row:first");if(!confirm(App.lang("Are you sure you want to complete this :object_name",{object_name:get_type_display_name(row.attr("object_type"))}))){return false}var image=checkbox.find("img:first");var initial_image=image.attr("src");checkbox.addClass("completing");image.attr("src",App.Wireframe.Utils.indicatorUrl("small"));$.ajax({url:checkbox.attr("href"),type:"post",data:{submitted:"submitted"},success:function(response){select_previous_item.apply(wrapper_dom);checkbox.parents("li.outline_level:first").remove();App.Wireframe.Flash.success(App.lang("Successfully completed :object_name",{object_name:get_type_display_name(row.attr("object_type"))}))},error:function(){image.attr("src",initial_image);checkbox.removeClass("completing");App.Wireframe.Flash.error(App.lang("Failed to complete :object_name",{object_name:get_type_display_name(row.attr("object_type"))}))}})};var quick_view_object=function(object){if(object.is(".quick_view_item")){App.widgets.QuickView.preview(object.clone().addClass("quick_view_item"),true)}};var expander_click=function(wrapper_dom){var anchor=$(this);if(anchor.is(".expanded")){collapse_item.apply(wrapper_dom,[anchor])}else{expand_item.apply(wrapper_dom,[anchor])}mark_item_selected.apply(wrapper_dom,[anchor])};var add_default_object_type=function(parent){if((parent===undefined)&&!(parent=get_current_item.apply(this))){return false}var row=parent.parents("span.row:first");var type=row.attr("object_type");switch(type){case"project":return add_milestone.apply(this,[parent]);break;case"milestone":return add_task.apply(this,[parent]);break;case"task":return add_subtask.apply(this,[parent]);break;case"todolist":return add_subtask.apply(this,[parent]);break}return false};var add_milestone=function(parent){if((parent===undefined)&&!(parent=get_current_item.apply(this))){return false}if(!this.ov_data.settings.permissions.can_add_milestones){App.Wireframe.Flash.error(App.lang("You don't have permission to add milestones to this project"));return false}if(parent.is(".collapsed")){expand_item.apply(this,[parent])}assemble_form.apply(this,["add",parent,"milestone"])};var add_task=function(parent){if((parent===undefined)&&!(parent=get_current_item.apply(this))){return false}if(!this.ov_data.settings.permissions.can_add_tasks){App.Wireframe.Flash.error(App.lang("You don't have permission to add tasks to this project"));return false}if(parent.is(".collapsed")){expand_item.apply(this,[parent])}assemble_form.apply(this,["add",parent,"task"])};var add_todolist=function(parent){if((parent===undefined)&&!(parent=get_current_item.apply(this))){return false}if(!this.ov_data.settings.permissions.can_add_todolists){App.Wireframe.Flash.error(App.lang("You don't have permission to add todo lists to this project"));return false}if(parent.is(".collapsed")){expand_item.apply(this,[parent])}assemble_form.apply(this,["add",parent,"todolist"])};var add_subtask=function(parent){if((parent===undefined)&&!(parent=get_current_item.apply(this))){return false}var row=parent.parents("span.row:first");var object_type=row.attr("object_type");var object_id=row.attr("real_object_id");var item_data=get_item.apply(this,[object_id,object_type]);if(!item_data.permissions.can_edit){App.Wireframe.Flash.error(App.lang("You don't have permission to add subtask to this :object_name",{object_name:get_type_display_name(object_type)}));return false}if(parent.is(".collapsed")){expand_item.apply(this,[parent])}assemble_form.apply(this,["add",parent,"subtask"])};var add_another=function(item){var row=item.parents("span.row:first");var parent=row.parents("li:first").parents("li:first").find("a.object_name:first");var type=row.attr("object_type");switch(type){case"milestone":return add_milestone.apply(this,[parent]);break;case"task":return add_task.apply(this,[parent]);break;case"todolist":return add_todolist.apply(this,[parent]);break;case"subtask":return add_subtask.apply(this,[parent]);break}return false};var update_object=function(item){var id=item.id;var type=get_type_name.apply(this,[item["class"]]);if(type=="task"){id=item.task_id}var current_object=$(this).find('span.row[object_type="'+type+'"][object_id="'+id+'"]');if(current_object.length){var rendered_object=render_item.apply(this,[item]).find("span.row");if(current_object.is(".selected")){rendered_object.addClass("selected")}if(current_object.find("a.object_name").is(".expanded")){var render_link=rendered_object.find("a.object_name");render_link.removeClass("collapsed").addClass("expanded")}rendered_object.find('span.checkbox_wrapper input[type="checkbox"]').attr("checked",current_object.find('span.checkbox_wrapper input[type="checkbox"]').attr("checked"));rendered_object.insertAfter(current_object);current_object.remove()}store_item.apply(this,[item])};var edit_object=function(item){var row=item.parents("span.row:first");var object_type=row.attr("object_type");var object_id=row.attr("real_object_id");var item_data=get_item.apply(this,[object_id,object_type]);if(!item_data||object_type=="project"){return false}if(!item_data.permissions.can_edit){App.Wireframe.Flash.error(App.lang("You don't have permission to edit this :object_name",{object_name:get_type_display_name(object_type)}));return false}assemble_form.apply(this,["edit",item,row.attr("object_type"),item_data])};var delete_object=function(item){var row=item.parents("span.row:first");var object_type=row.attr("object_type");var object_id=row.attr("real_object_id");var item_data=get_item.apply(this,[object_id,object_type]);if(object_type.toLowerCase()=="project"){return false}if(!item_data.permissions.can_trash){App.Wireframe.Flash.error(App.lang("You don't have permission to move this :object_name to trash",{object_name:get_type_display_name(object_type)}));return false}if(!confirm(App.lang("Are you sure you want to move this :object_type to trash",{object_type:get_type_display_name(object_type)}))){return false}$.ajax({type:"POST",data:{submitted:"submitted"},url:row.find("a.delete:first").attr("href")});select_previous_item.apply(this);row.parent().remove();return false};var render_focus_field=function(){var wrapper=$(this);var wrapper_dom=this;this.ov_data.focus_field=$('<input type="text" id="project_outline_focus" />').appendTo(wrapper);this.ov_data.focus_field.focus(function(){wrapper.addClass("focused")}).blur(function(){wrapper.removeClass("focused")}).focus();select_first_item.apply(this);this.ov_data.focus_field.bind("keydown",function(event){if(event.altKey||event.ctrlKey||event.metaKey){return true}switch(event.keyCode){case 38:select_previous_item.apply(wrapper_dom);break;case 40:select_next_item.apply(wrapper_dom);break;case 37:collapse_current_item.apply(wrapper_dom);break;case 39:expand_current_item.apply(wrapper_dom);break;case 46:delete_object.apply(wrapper_dom,[get_current_item.apply(wrapper_dom)]);break;case 8:return false;break;case 13:event.shiftKey?add_another.apply(wrapper_dom,[get_current_item.apply(wrapper_dom)]):edit_object.apply(wrapper_dom,[get_current_item.apply(wrapper_dom)]);break;case 9:add_default_object_type.apply(wrapper_dom);break;case 32:if(event.shiftKey){complete_object.apply(wrapper_dom,[get_current_item.apply(wrapper_dom).prev("a.checkbox:first")])}else{quick_view_object.apply(wrapper_dom,[get_current_item.apply(wrapper_dom)])}break;default:if(event.keyCode>=112&&event.keyCode<=123){return true}break}return false})};var select_first_item=function(){mark_item_selected.apply(this,[$(this).find("span.row:first a.object_name:first")])};var get_current_item=function(){return $(this).find("span.row.current:first a.object_name:first")};var select_previous_item=function(){var wrapper=$(this);var wrapper_dom=this;var previous_element=null;var current_item=get_current_item.apply(this);if(!current_item.length){return select_first_item.apply(this)}previous_element=current_item.closest("li.outline_level").prev("li.outline_level").find("li.outline_level:last span.row:first a.object_name:first");if(previous_element.length){return mark_item_selected.apply(this,[previous_element])}previous_element=current_item.parents("li.outline_level:first").prev("li.outline_level").find("span.row a.object_name:first");if(previous_element.length){return mark_item_selected.apply(this,[previous_element])}var parents=current_item.parents("li.outline_level:first").parents("li.outline_level");parents.each(function(){previous_element=$(this).find("span.row:first a.object_name:first");if(previous_element.length){mark_item_selected.apply(wrapper_dom,[previous_element]);return false}})};var select_next_item=function(){var wrapper=$(this);var wrapper_dom=this;var next_element=null;var current_item=get_current_item.apply(this);if(!current_item.length){return select_first_item()}next_element=current_item.parents("span.row:first").next("ul.subobjects").find("li.outline_level:first span.row:first a.object_name:first");if(next_element.length){return mark_item_selected.apply(this,[next_element])}next_element=current_item.parents("li.outline_level:first").next("li.outline_level").find("span.row:first a.object_name:first");if(next_element.length){return mark_item_selected.apply(this,[next_element])}var parents=current_item.parents("li.outline_level:first").parents("li.outline_level");parents.each(function(){next_element=$(this).next("li.outline_level").find("span.row:first a.object_name:first");if(next_element.length){mark_item_selected.apply(wrapper_dom,[next_element]);return false}})};var expand_current_item=function(){var current_item=get_current_item.apply(this);if(!current_item.length){select_first_item.apply(this);expand_current_item.apply(this);return true}if(current_item.is(".expanded, .expanding")){return false}expand_item.apply(this,[current_item])};var expand_all_milestones=function(){var collapsed_milestones=$(this).find("a.object_name.collapsed.milestone").addClass("expanding").removeClass("collapsed").addClass("loading").addClass("queued_expand");if(!collapsed_milestones.length){return false}var wrapper_dom=this;var queue_index=-1;this.ov_data.expand_milestones_wrapper.find("a").addClass("progress");var expand_next_in_queue=function(){queue_index++;var next_in_queue=collapsed_milestones.eq(queue_index);if(next_in_queue&&next_in_queue.length){expand_item.apply(wrapper_dom,[next_in_queue,function(){expand_next_in_queue()}])}else{wrapper_dom.ov_data.expand_milestones_wrapper.find("a").removeClass("progress")}};expand_next_in_queue()};var collapse_all_milestones=function(){var wrapper_dom=this;var collapsed_milestones=$(this).find("a.object_name.expanded.milestone").each(function(){collapse_item.apply(wrapper_dom,[$(this)])})};var collapse_current_item=function(){var current_item=get_current_item.apply(this);if(!current_item.length){select_first_item.apply(this);collapse_current_item.apply(this);return true}if(!current_item.is(".collapsed")){collapse_item.apply(this,[current_item])}};var mark_item_selected=function(item){var wrapper=$(this);if(wrapper.is(".mass_edit_mode")){return false}wrapper.find("span.row.current").removeClass("current");item.parents("span.row:first").addClass("current");var initial_offset=6;var item_height=parseInt(item.height());var viewport_height=parseInt(this.ov_data.main_list.height());var current_scroll=this.ov_data.main_list.scrollTop();var item_offset_top=0;if(item.offset()){item_offset_top=item.offset().top}var relative_offset=item_offset_top-this.ov_data.main_list.offset().top+current_scroll;if(!((relative_offset>current_scroll)&&(relative_offset<current_scroll+viewport_height))){if(relative_offset>current_scroll+viewport_height){this.ov_data.main_list.scrollTop(relative_offset-viewport_height+item_height+initial_offset)}else{if(relative_offset<current_scroll){this.ov_data.main_list.scrollTop(relative_offset-item_height+initial_offset)}}}this.ov_data.focus_field.focus();return true};var collapse_item=function(item){if(item.is(".collapsed, .expanding")){return false}var wrapper_dom=this;item.removeClass("expanded").addClass("collapsed");item.parents("span.row").parent().children("ul").remove();if(item.is(".milestone")){milestone_toggled.apply(wrapper_dom,[item])}};var expand_item=function(item,callback_function){if(item.is(".expanded, .subtask, .expanding")&&!item.is(".queued_expand")){return false}var wrapper_dom=this;item.addClass("expanding").removeClass("collapsed").addClass("loading");$.ajax({url:App.extendUrl(item.attr("subobjects_url"),{skip_layout:1}),success:function(response){item.removeClass("loading").removeClass("expanding").addClass("expanded").removeClass("queued_expand");if(response&&response.length){var rendered_subitems=render_subitems.apply(wrapper_dom,[response,item])}else{var rendered_subitems=render_subitems.apply(wrapper_dom,[[],item])}if(callback_function&&typeof(callback_function)=="function"){callback_function.apply(wrapper_dom,[rendered_subitems])}if(item.is(".milestone")){milestone_toggled.apply(wrapper_dom,[item])}return true},error:function(response,responseText){item.removeClass("loading").addClass("collapsed").removeClass("expanding").removeClass("queued_expand")}})};var milestone_toggled=function(item){var wrapper=$(this);if(wrapper.find("a.milestone.collapsed, a.milestone.queued_expand").length){this.ov_data.expand_milestones_wrapper.find("a").text(App.lang("Expand all Milestones"))}else{this.ov_data.expand_milestones_wrapper.find("a").text(App.lang("Collapse all Milestones"))}};var render_label=function(item){var label_id=item.label?item.label.id:item.label_id;if(!(label_id&&label_id>0)){return""}var label_type="";switch(item["class"].toLowerCase()){case"project":label_type="ProjectLabel";break;default:label_type="AssignmentLabel";break}if(this.ov_data.settings.labels instanceof App.Map&&this.ov_data.settings.labels.isset(label_type)){var labels=this.ov_data.settings.labels.get(label_type);var labels_map=App.isMappable(labels)?new App.Map(labels):labels;if(labels_map instanceof App.Map&&labels_map.isset(label_id)){var label=labels_map.get(label_id);var label_style="";if(label.fg_color){label_style+="color : "+label.fg_color+";"}if(label.bg_color){label_style+="background-color : "+label.bg_color+";"}return'<span class="label" style="'+label_style+'">'+label.name+"</span>"}}return""};var render_priority=function(item){return App.Wireframe.Utils.renderPriority(item.priority,true)};var get_type_name=function(class_name){return class_name.toLowerCase()=="projectobjectsubtask"?"subtask":class_name.toLowerCase()};var get_class_name=function(type){switch(type){case"project":return"Project";break;case"milestone":return"Milestone";break;case"task":return"Task";break;case"todolist":return"TodoList";break;case"subtask":return"ProjectObjectSubtask";break}return false};var get_type_display_name=function(type,first_in_sentence){var type_display_name;switch(type){case"project":type_display_name=App.lang("Project");break;case"milestone":type_display_name=App.lang("Milestone");break;case"task":type_display_name=App.lang("Task");break;case"todolist":type_display_name=App.lang("Todo List");break;case"subtask":type_display_name=App.lang("Subtask");break;default:type_display_name=App.lang("Unknown")}if(first_in_sentence){return type_display_name}else{var locale=App.Config.get("locale")?App.Config.get("locale"):"en_US.UTF-8";var locale_part=locale.substring(0,locale.indexOf(".")).toLowerCase();var always_uppercase=["de","de_at","de_de","de_li","de_lu","de_ch"];if($.inArray(locale_part,always_uppercase)!=-1){return type_display_name}else{return type_display_name.toLowerCase()}}};var store_item=function(item){var unique_id=get_type_name(item["class"])+"_"+item.id;this.ov_data.items[unique_id]=item};var get_item=function(id,class_name){return this.ov_data.items[get_type_name(class_name)+"_"+id]};var can_accept_subobjects=function(item){var object_class=get_type_name(item["class"]);if(object_class!="project"&&object_class!="subtask"){if(object_class=="milestone"){return true}else{if((object_class=="task"||object_class=="todolist")&&item.permissions.can_edit){return true}}}return false};var can_be_reordered=function(item){var object_class=get_type_name(item["class"]);if(object_class!="project"&&object_class!="milestone"){if(object_class=="task"&&this.ov_data.settings.permissions.can_manage_tasks){return true}else{if(object_class=="todolist"&&this.ov_data.settings.permissions.can_manage_todolists){return true}else{if(object_class=="subtask"){if(typeof(item.parent)=="object"){var parent_type=item.parent["class"];var parent_id=item.parent["id"]}else{var parent_type=item.parent_class;var parent_id=item.parent_id}var parent=get_item.apply(this,[parent_id,parent_type]);if(parent&&parent.permissions.can_edit){return true}}}}}return false};var can_be_moved=function(item){var object_class=get_type_name(item["class"]);if(object_class!="project"&&object_class!="milestone"){if((object_class=="task"||object_class=="todolist"||object_class=="subtask")&&item.permissions.can_edit){return true}}return false};var render_item=function(item){store_item.apply(this,[item]);var object_class=get_type_name(item["class"]);var object_class_label=get_type_display_name(object_class);var dom_class=["row","list_row",object_class];var assignee_id=item.assignee_id?item.assignee_id:(item.assignee?item.assignee.id:null);if(assignee_id){dom_class.push("responsible_id_"+assignee_id);dom_class.push("assignee_id_"+assignee_id);if(item.other_assignees){$.each(item.other_assignees,function(){dom_class.push("assignee_id_"+this.id)})}}var item_can_accept_subobjects=can_accept_subobjects.apply(this,[item]);if(item_can_accept_subobjects){dom_class.push("can_accept_subobjects")}var item_can_be_reordered=can_be_reordered.apply(this,[item]);if(item_can_be_reordered){dom_class.push("can_be_reordered")}var item_can_be_moved=can_be_moved.apply(this,[item]);if(item_can_be_moved){dom_class.push("can_be_moved")}var rendered="";rendered='<li class="'+object_class+"_container outline_level"+(item_can_be_reordered?" can_be_reordered":"")+(item_can_be_moved?" can_be_moved":"")+'">';rendered+='<span class="'+dom_class.join(" ")+'" object_type="'+object_class+'" object_id="'+(object_class=="task"?item.task_id:item.id)+'" real_object_id="'+item.id+'">';rendered+='<span class="pills_wrapper">';if(item_can_be_reordered||item_can_be_moved){rendered+='<img class="drag_handle" src="'+App.Wireframe.Utils.imageUrl("layout/drag-handle.png","system")+'">'}rendered+=(object_class=="project"?"":render_priority.apply(this,[item]));rendered+=render_label.apply(this,[item]);rendered+="</span>";rendered+='<span class="object_general">';rendered+='<span class="checkbox_wrapper"><input type="checkbox" '+(!item.permissions.can_edit||object_class=="project"?' disabled="disabled" ':"")+" /></span>";rendered+='<span class="indicators">';rendered+='<span class="hidable">';if(object_class=="project"&&this.ov_data.settings.permissions.can_add_milestones){rendered+='<a href="#" class="add_milestone"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/plus.png","environment")+'" /><span>'+App.lang("Milestone")+"</span></a>"}else{if(object_class=="milestone"){if(this.ov_data.settings.permissions.can_add_tasks){rendered+='<a href="#" class="add_task"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/plus.png","environment")+'" /><span>'+App.lang("Task")+"</span></a>"}if(this.ov_data.settings.permissions.can_add_todolists){rendered+='<a href="#" class="add_todolist"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/plus.png","environment")+'" /><span>'+App.lang("Todo List")+"</span></a>"}}else{if((object_class=="task"||object_class=="todolist")&&item.permissions.can_edit){rendered+='<a href="#" class="add_subtask"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/plus.png","environment")+'" /><span>'+App.lang("Subtask")+"</span></a>"}}}if(object_class!="project"){if(item.permissions.can_edit){rendered+='<a href="'+item.urls.edit+'" class="edit"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/edit.png","environment")+'" /></a>'}if(item.permissions.can_trash){rendered+='<a href="'+item.urls.trash+'" class="delete"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/delete.png","environment")+'" /></a>'}}rendered+="</span>";if(object_class!="project"){if(this.ov_data.settings.permissions.can_use_tracking){if(object_class=="task"){var estimate=typeof(item.estimate)=="object"&&item.estimate?App.parseNumeric(item.estimate["value"]):0;if(isNaN(estimate)){estimate=0}rendered+='<span class="object_tracking" data-estimated-time="'+estimate+'" data-object-time="'+item.object_time+'" data-object-expenses="'+item.object_expenses+'" data-show-label="0" data-default-billable-status="'+(typeof(this.ov_data.settings.default_billable_status)!="undefined"&&this.ov_data.settings.default_billable_status?1:0)+'"><a href="'+App.clean(item.urls["tracking"])+'"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/object-time-inactive.png")+'"></a></span>'}else{rendered+='<span class="spacer"></span>'}}if(item.permissions.can_edit&&(object_class=="task"||object_class=="subtask"||object_class=="milestone")){rendered+='<span class="object_schedule"></span>'}else{rendered+='<span class="spacer"></span>'}if(object_class!="project"&&object_class!="todolist"){rendered+='<a href="#" class="object_subscription" is_on="'+(item.user_is_subscribed?1:0)+'"></a>'}else{rendered+='<span class="spacer"></span>'}}rendered+="</span>";rendered+='<a href="'+item.urls.complete+'" class="checkbox'+(!item.permissions.can_edit||object_class=="project"?" disabled":"")+'"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/checkbox-unchecked.png","complete")+'" /></a>';rendered+='<a subobjects_url="'+this.ov_data.settings.subobjects_url.replace("--OBJECT-ID--",item.id).replace("--OBJECT-TYPE--",object_class)+'" class="'+(object_class!="subtask"?"quick_view_item quick_view_item_invert":"")+" object_name collapsed "+object_class+' list" object_class="'+object_class+'" quick_view_url="'+item.urls.view+'" quick_view_title="'+App.clean(item.name)+'">';rendered+='<span class="object_type object_type_'+object_class+'">';if(item["class"]=="Task"){rendered+=App.lang(object_class_label)+" #"+item.task_id}else{rendered+=App.lang(object_class_label)}rendered+="</span>";if(assignee_id>0){var user=this.ov_data.settings.users[assignee_id];if(user&&typeof(user)=="object"){rendered+="<strong>"+App.clean(user.short_display_name)+"</strong>&nbsp;"}}rendered+=App.clean(item.name);rendered+="</a>";rendered+="</span>";rendered+="</span>";rendered+="</span>";rendered+="</li>";rendered=$(rendered);if(object_class!="project"&&object_class!="todolist"){rendered.find("a.object_subscription").asyncToggler({content_when_on:'<img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/object-subscription-active.png","subscriptions")+'" />',content_when_off:'<img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/object-subscription-inactive.png","subscriptions")+'" />',title_when_on:App.lang("Click to Unsubscribe"),title_when_off:App.lang("Click to Subscribe"),url_when_on:item.urls.unsubscribe,url_when_off:item.urls.subscribe})}if(this.ov_data.settings.permissions.can_use_tracking){if(object_class=="task"){rendered.find("span.object_tracking").objectTime()}}if(item.permissions.can_edit){if(object_class=="task"||object_class=="subtask"||object_class=="milestone"){rendered.find("span.object_schedule").objectSchedule({is_range:item.start_on&&item.due_on,reschedule_url:item.urls.reschedule,start_on:item.start_on&&item.due_on?item.start_on:null,due_on:item.due_on,can_reschedule:true,object_id:item.id,object_name:item.name,event_name:item.event_names.updated,listen_events:[item.event_names.updated],show_label:false})}}return rendered};var render_unknown_milestone=function(){var rendered="";rendered+='<li class="milestone_container outline_level">';rendered+='<span real_object_id="0" object_id="0" object_type="milestone" class="row list_row milestone can_accept_subobjects faux_milestone">';rendered+='<span class="pills_wrapper"></span>';rendered+='<span class="object_general">';rendered+='<span class="checkbox_wrapper"><input type="checkbox" disabled="disabled" /></span>';rendered+='<span class="indicators">';rendered+='<span class="hidable">';if(this.ov_data.settings.permissions.can_add_tasks){rendered+='<a href="#" class="add_task"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/plus.png","environment")+'" /><span>'+App.lang("Task")+"</span></a>"}if(this.ov_data.settings.permissions.can_add_todolists){rendered+='<a href="#" class="add_todolist"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/plus.png","environment")+'" /><span>'+App.lang("Todo List")+"</span></a>"}rendered+="</span>";rendered+="</span>";rendered+='<a href="#" class="checkbox disabled"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/checkbox-unchecked.png","complete")+'" /></a>';rendered+='<a object_class="milestone" class="object_name collapsed milestone list" subobjects_url="'+this.ov_data.settings.subobjects_url.replace("--OBJECT-ID--",0).replace("--OBJECT-TYPE--","milestone")+'"><span class="object_type object_type_milestone">'+App.lang("Milestone")+"</span>"+this.ov_data.settings.unclassified_label+"</a>";rendered+="</span>";rendered+="</span>";rendered+="</li>";return $(rendered)};var render_subitems=function(items,parent){var wrapper=$(this);var wrapper_dom=this;var rendered=$('<ul class="subobjects"></ul>');if(items){$.each(items,function(index){rendered.append(render_item.apply(wrapper_dom,[this]))})}if(parent&&parent.attr("object_class")=="project"){rendered.append(render_unknown_milestone.apply(wrapper_dom))}if(parent){rendered.addClass(parent.attr("object_class")+"_subobjects").addClass("subobjects");parent.parents("span.row:first").after(rendered);if(wrapper.is(".mass_edit_mode")){initialize_dragging.apply(wrapper_dom,[rendered]);rendered.find("span.row.milestone.can_accept_subobjects, span.row.task.can_accept_subobjects, span.row.todolist.can_accept_subobjects").each(function(){initialize_droppable.apply(wrapper_dom,[$(this)])})}}else{wrapper_dom.ov_data.main_list.append(rendered);$(this).append(wrapper.main_list)}return rendered};var render_initial_items=function(){var wrapper=$(this);this.ov_data.main_list=$('<div class="main_list"></div>').appendTo(wrapper);render_subitems.apply(this,[[this.ov_data.settings.initial_object],null]);var initial_object=wrapper.find("a.object_name:first");initial_object.addClass("expanded").removeClass("collapsed");render_subitems.apply(this,[this.ov_data.settings.initial_subobjects,initial_object])};var handle_events=function(){var wrapper=$(this);var wrapper_dom=this;var project_id=this.ov_data.settings.initial_object.id;App.Wireframe.Events.bind("milestone_created.content task_created.content todo_list_created.content",function(event,project_object){if(project_object.project_id!=project_id){return false}var object_class=project_object["class"].toLowerCase();store_item.apply(wrapper_dom,[project_object]);if(object_class=="milestone"){var project_row=wrapper.find("a.object_name.project");if(project_row.length&&project_row.is(".expanded")){var last_milestone=wrapper.find("a.object_name.milestone:last").parents("li.outline_level:first");render_item.apply(wrapper_dom,[project_object]).insertBefore(last_milestone)}}else{if(object_class=="task"||object_class=="todolist"){var parent_milestone;if(project_object.milestone_id){parent_milestone=wrapper.find('span.row.list_row.milestone[real_object_id="'+project_object.milestone_id+'"]:first').find("a.object_name:first")}if(!parent_milestone||!parent_milestone.length){parent_milestone=wrapper.find("a.object_name.milestone:last").find("a.object_name:first")}if(parent_milestone.length&&parent_milestone.is(".expanded")){render_item.apply(wrapper_dom,[project_object]).appendTo(parent_milestone.parents("span.row:first").next("ul.subobjects:first"))}}}});App.Wireframe.Events.bind("milestone_updated.content task_updated.content todo_list_updated.content",function(event,project_object){if(project_object.project_id!=project_id){return false}store_item.apply(wrapper_dom,[project_object])})};var plugin_name="projectOutline";$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);