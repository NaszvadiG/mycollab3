(function($){var public_methods={init:function(options){return this.each(function(){var wrapper=$(this);var wrapper_dom=this;this.tim_data={settings:jQuery.extend({},options)};initialize.apply(this);handle_interaction.apply(this);handle_events.apply(this);init_scrollbars.apply(this)})}};var initialize=function(){var wrapper=$(this);var wrapper_dom=this;wrapper.parents("#wireframe_content").addClass("no_overflow");this.tim_data.timesheet=wrapper.find("div.timesheet");this.tim_data.timerecords_table_wrapper=wrapper.find("div.timesheet_records_wrapper");this.tim_data.timerecords_table=this.tim_data.timerecords_table_wrapper.find("table:first");this.tim_data.users_table_wrapper=wrapper.find(".timesheet_users:first");this.tim_data.users_table=this.tim_data.users_table_wrapper.find("table:first");this.tim_data.dates_table_wrapper=wrapper.find(".timesheet_date_scale");this.tim_data.dates_table=this.tim_data.dates_table_wrapper.find("table:first");this.tim_data.horizontal_scrollbar=wrapper.find(".timesheet_horizontal_scrollbar");this.tim_data.horizontal_scrollbar_handle=this.tim_data.horizontal_scrollbar.find(".scrollbar_handle");this.tim_data.vertical_scrollbar=wrapper.find(".timesheet_vertical_scrollbar");this.tim_data.vertical_scrollbar_handle=this.tim_data.vertical_scrollbar.find(".scrollbar_handle");this.tim_data.day_details_url=this.tim_data.timesheet.attr("day_details_url")};var handle_interaction=function(){var wrapper=$(this);var wrapper_dom=this;this.tim_data.timerecords_table.delegate("td.day","click",function(event){var cell=$(this);var link=cell.find("span");var row=cell.parents("tr:first");var dialog=App.widgets.FlyoutDialog.show({title:App.lang("Time Log"),data:App.extendUrl(wrapper_dom.tim_data.day_details_url,{user_id:row.attr("user_id"),day:cell.attr("day")}),data_type:"url",width:1000,success:function(){var dialog_content=$(this);var dialog_table=dialog_content.find("table");var value_field=dialog_content.find("#time_day_log_add td.value input");var dialog_init_row=function(row){row.find("td.options a.trash").asyncLink({confirmation:App.lang("Are you sure that you want to move this time record to the Trash?"),indicator_url:App.Wireframe.Utils.indicatorUrl(),success:function(){row.remove();if(dialog_table.find("tr.timesheet_day_log_entry").length==0){dialog_table.find("#timesheet_day_log_empty").show()}dialog_update();App.Wireframe.Flash.success("Time record has been successfully moved to Trash")},error:function(){App.Wireframe.Flash.error("Failed to move selected time record to the Trash. Please try again later")}})};var dialog_update=function(){var counter=1;var total_time=0;dialog_table.find("tr.timesheet_day_log_entry").each(function(){var row=$(this);row.removeClass("odd").removeClass("even").addClass((counter%2?"odd":"even"));total_time+=parseFloat(row.find("td.value").text());counter++});total_time=total_time.toFixed(2);if(total_time){cell.removeClass("no_time");link.text(total_time)}else{cell.addClass("no_time");link.text("")}if(total_time==1){dialog_table.find("tfoot td.value").text(App.lang("Total: 1 hour"))}else{dialog_table.find("tfoot td.value").text(App.lang("Total: :num hours",{num:total_time}))}};if(value_field.length>0){value_field.focus()}dialog_content.find("#timesheet_day_log #time_day_log_add td.summary input").each(function(){var input=$(this);input.width(input.parent().width()-7)});dialog_table.find("tr.timesheet_day_log_entry").each(function(){dialog_init_row($(this))});dialog_update();dialog_content.find("#time_day_log_add_form").submit(function(){var form=$(this);var value=jQuery.trim(value_field.val());if(value==""||value==0||!value){value_field.focus()}else{var data={"time_record[value]":value,"time_record[job_type_id]":dialog_content.find("#time_day_log_add td.value select").val(),"time_record[user_id]":dialog_content.attr("user_id"),"time_record[record_date]":dialog_content.attr("day"),"time_record[summary]":dialog_content.find("#time_day_log_add td.summary input").val(),"time_record[billable_status]":dialog_content.find("#time_day_log_add td.status select").val(),submitted:"submitted"};form.find("input, select").attr("disabled","disabled");dialog_content.find("#time_day_log_add td.options").find("button").hide();dialog_content.find("#time_day_log_add td.options").append('<img src="'+App.Wireframe.Utils.indicatorUrl()+'" />');$.ajax({url:form.attr("action"),type:"post",data:data,success:function(response){form.find("input, select").removeAttr("disabled");dialog_content.find("#time_day_log_add td.options").find("img").remove();dialog_content.find("#time_day_log_add td.options").find("button").show();if($.isPlainObject(response)){var new_row=$('<tr class="timesheet_day_log_entry"><td class="created_on">'+App.lang("Today")+'</td><td class="value right">'+response.value+'</td><td class="summary">'+App.clean(response.summary)+'</td><td class="status">'+(response.billable_status?App.lang("Billable"):App.lang("Not Billable"))+'</td><td class="options"><a href="'+response.urls["trash"]+'" title="'+App.lang("Move to Trash")+'" class="trash"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/move-to-trash.png","system")+'" alt="" /></a></td></tr>');dialog_table.find("#time_day_log_add").after(new_row);dialog_table.find("#timesheet_day_log_empty").hide();new_row.find("td").highlightFade();form.find("input").val("");value_field.focus();dialog_update()}else{App.Wireframe.Flash.error(App.lang("Failed to log time. Please try again later"));value_field.focus()}},error:function(response){form.find("input, select").removeAttr("disabled");dialog_content.find("#time_day_log_add td.options").find("img").remove();dialog_content.find("#time_day_log_add td.options").find("button").show();App.Wireframe.Flash.error(App.lang("Failed to log time. Please try again later"));value_field.focus()}})}return false})}})})};var init_scrollbars=function(){var wrapper=$(this);var wrapper_dom=this;refresh_scrollbars.apply(this);scroll_canvas.apply(this,[this.tim_data.max_scroll_left]);update_scrollbar_position.apply(this);this.tim_data.horizontal_scrollbar_handle.draggable({axis:"x",containment:"parent",drag:function(event,ui){var new_x_scroll=(ui.position.left/wrapper_dom.tim_data.max_horizontal_handle_value)*wrapper_dom.tim_data.max_scroll_left;scroll_canvas.apply(wrapper_dom,[new_x_scroll,null])},start:function(){wrapper_dom.tim_data.draggging_scrollbars=true},stop:function(){wrapper_dom.tim_data.draggging_scrollbars=false}});this.tim_data.vertical_scrollbar_handle.draggable({axis:"y",containment:"parent",drag:function(event,ui){var new_y_scroll=(ui.position.top/wrapper_dom.tim_data.max_vertical_handle_value)*wrapper_dom.tim_data.max_scroll_top;scroll_canvas.apply(wrapper_dom,[null,new_y_scroll])},start:function(){wrapper_dom.tim_data.draggging_scrollbars=true},stop:function(){wrapper_dom.tim_data.draggging_scrollbars=false}});this.tim_data.horizontal_scrollbar.bind("mousedown",function(event){var clicked_target=$(event.target);if(!clicked_target.is(".scrollbar")){return true}var target_x=clicked_target.offset().left;var client_x=event.clientX;var new_left_offset=(client_x-target_x)-wrapper_dom.tim_data.horizontal_scrollbar_handle.width()/2;if(new_left_offset<0){new_left_offset=0}else{if(new_left_offset>wrapper_dom.tim_data.max_horizontal_handle_value){new_left_offset=wrapper_dom.tim_data.max_horizontal_handle_value}}var new_x_scroll=(new_left_offset/wrapper_dom.tim_data.max_horizontal_handle_value)*wrapper_dom.tim_data.max_scroll_left;scroll_canvas.apply(wrapper_dom,[new_x_scroll]);update_scrollbar_position.apply(wrapper_dom)});this.tim_data.vertical_scrollbar.bind("mousedown",function(event){var clicked_target=$(event.target);if(!clicked_target.is(".scrollbar")){return true}var target_y=clicked_target.offset().top;var client_y=event.clientY;var new_top_offset=(client_y-target_y)-wrapper_dom.tim_data.vertical_scrollbar_handle.height()/2;if(new_top_offset<0){new_top_offset=0}else{if(new_top_offset>wrapper_dom.tim_data.max_vertical_handle_value){new_top_offset=wrapper_dom.tim_data.max_vertical_handle_value}}var new_y_scroll=(new_top_offset/wrapper_dom.tim_data.max_vertical_handle_value)*wrapper_dom.tim_data.max_scroll_top;scroll_canvas.apply(wrapper_dom,[null,new_y_scroll]);update_scrollbar_position.apply(wrapper_dom)});var handle_mouse_wheel=function(event,delta,delta_x,delta_y){delta_y=Math.ceil(delta_y)*-1;delta_x=Math.ceil(delta_x);scroll_canvas.apply(wrapper_dom,[delta_x,delta_y,true]);update_scrollbar_position.apply(wrapper_dom)};wrapper.bind("mousewheel",handle_mouse_wheel)};var refresh_scrollbars=function(){var horizontal_scrollbar_ratio=this.tim_data.timerecords_table_wrapper.width()/this.tim_data.timerecords_table.width();if(horizontal_scrollbar_ratio>1){horizontal_scrollbar_ratio=1;this.tim_data.horizontal_scrollbar.hide()}else{this.tim_data.horizontal_scrollbar.show()}this.tim_data.horizontal_scrollbar_handle.width(horizontal_scrollbar_ratio*this.tim_data.horizontal_scrollbar.width());var vertical_scrollbar_ratio=this.tim_data.timerecords_table_wrapper.height()/this.tim_data.timerecords_table.height();if(vertical_scrollbar_ratio>1){vertical_scrollbar_ratio=1;this.tim_data.vertical_scrollbar.hide()}else{this.tim_data.vertical_scrollbar.show()}this.tim_data.vertical_scrollbar_handle.height(vertical_scrollbar_ratio*this.tim_data.vertical_scrollbar.height());this.tim_data.max_scroll_left=this.tim_data.timerecords_table.width()-this.tim_data.timerecords_table_wrapper.width();this.tim_data.max_horizontal_handle_value=this.tim_data.horizontal_scrollbar.width()-this.tim_data.horizontal_scrollbar_handle.width()-parseInt(this.tim_data.horizontal_scrollbar_handle.css("border-left-width"))-parseInt(this.tim_data.horizontal_scrollbar_handle.css("border-right-width"));this.tim_data.max_scroll_top=this.tim_data.timerecords_table.height()-this.tim_data.timerecords_table_wrapper.height();this.tim_data.max_vertical_handle_value=this.tim_data.vertical_scrollbar.height()-this.tim_data.vertical_scrollbar_handle.height()-parseInt(this.tim_data.vertical_scrollbar_handle.css("border-top-width"))-parseInt(this.tim_data.vertical_scrollbar_handle.css("border-top-width"));update_scrollbar_position.apply(this)};var update_scrollbar_position=function(){this.tim_data.horizontal_scrollbar_handle.css("left",((this.tim_data.timerecords_table_wrapper.scrollLeft()/this.tim_data.max_scroll_left)*this.tim_data.max_horizontal_handle_value));this.tim_data.vertical_scrollbar_handle.css("top",((this.tim_data.timerecords_table_wrapper.scrollTop()/this.tim_data.max_scroll_top)*this.tim_data.max_vertical_handle_value))};var scroll_canvas=function(position_x,position_y,relative){if(relative){if(position_x!=null&&position_x!=undefined){position_x=position_x+this.tim_data.timerecords_table_wrapper.scrollLeft()}if(position_y!=null&&position_y!=undefined){position_y=position_y+this.tim_data.timerecords_table_wrapper.scrollTop()}}if(position_x!=null&&position_x!=undefined){this.tim_data.timerecords_table_wrapper.scrollLeft(position_x);this.tim_data.dates_table_wrapper.scrollLeft(position_x)}if(position_y!=null&&position_y!=undefined){this.tim_data.timerecords_table_wrapper.scrollTop(position_y);this.tim_data.users_table_wrapper.scrollTop(position_y)}};var handle_events=function(){var wrapper_dom=this;App.Wireframe.Events.bind("window_resize.content",function(){refresh_scrollbars.apply(wrapper_dom)})};var plugin_name="timesheet";$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);