/* Minified: jquery.objectTimeExpensesFlyout.js */
jQuery.fn.objectTimeExpensesFlyout=function(on_change){return this.each(function(){$(this).click(function(){var link=$(this);var dialog=App.widgets.FlyoutDialog.show({title:App.lang("Time and Expenses"),data:link.attr("href"),data_type:"url",width:1000,success:function(){var wrapper=$(this);var select_billable_status=wrapper.find("tr.add_time_or_expense .status select");var tracking_type_toggler=wrapper.find("tr.add_time_or_expense .tracking_type_toggler");var tracking_type_timerecord=$("<img />").appendTo(tracking_type_toggler);var tracking_type_expense=$("<img />").appendTo(tracking_type_toggler);var tracking_type_input=$('<input type="hidden" />').appendTo(tracking_type_toggler);var tracking_timerecord_active_image=App.Wireframe.Utils.imageUrl("icons/16x16/time-record.png","tracking");var tracking_timerecord_inactive_image=App.Wireframe.Utils.imageUrl("icons/16x16/time-record-inactive.png","tracking");var tracking_expense_active_image=App.Wireframe.Utils.imageUrl("icons/16x16/expense.png","tracking");var tracking_expense_inactive_image=App.Wireframe.Utils.imageUrl("icons/16x16/expense-inactive.png","tracking");var tracking_timerecord_control=wrapper.find("tr.add_time_or_expense td.job_type .timerecord_control");var tracking_expense_control=wrapper.find("tr.add_time_or_expense td.job_type .expense_control");tracking_type_input.attr("value","time_record");tracking_type_timerecord.attr("src",tracking_timerecord_active_image);tracking_type_expense.attr("src",tracking_expense_inactive_image);tracking_timerecord_control.show();tracking_expense_control.hide();tracking_type_timerecord.click(function(){tracking_type_input.attr("value","time_record");tracking_type_timerecord.attr("src",tracking_timerecord_active_image);tracking_type_expense.attr("src",tracking_expense_inactive_image);tracking_timerecord_control.show();tracking_expense_control.hide()});tracking_type_expense.click(function(){tracking_type_input.attr("value","expense");tracking_type_timerecord.attr("src",tracking_timerecord_inactive_image);tracking_type_expense.attr("src",tracking_expense_active_image);tracking_timerecord_control.hide();tracking_expense_control.show()});var estimate_wrapper=wrapper.find("ul.object_tracking_totals li.object_tracking_totals_estimated_time span.value");var total_time_wrapper=wrapper.find("ul.object_tracking_totals li.object_tracking_totals_tracked_time span.value");var total_expenses_wrapper=wrapper.find("ul.object_tracking_totals li.object_tracking_totals_tracked_expenses span.value");var log_table=wrapper.find("table");var value_field=log_table.find("tr.add_time_or_expense td.value input").focus();var summary_field=log_table.find("tr.add_time_or_expense td.summary input");summary_field.width(summary_field.parent().width()-7);var dialog_update=function(trigger_change){var items=log_table.find("tbody tr.item");var total_time=0;var total_expenses=0;if(items.length>0){log_table.find("tbody tr.empty").hide();items.each(function(){var item=$(this);if(item.is("tr.time_record")){total_time+=App.parseNumeric(item.find("td.value").text())}else{total_expenses+=App.parseNumeric(item.find("td.value").text())}})}else{log_table.find("tbody tr.empty").show()}total_time_wrapper.text(App.hoursFormat(total_time,2,true,true));total_expenses_wrapper.text(App.numberFormat(total_expenses));if(total_time){var time_string=App.lang("Time: :totalh",{total:total_time})}else{var time_string=false}if(total_expenses){var expenses_string=App.lang("Expenses: :total",{total:total_expenses})}else{var expenses_string=false}if(time_string&&expenses_string){var formatted=time_string+". "+expenses_string}else{if(time_string){var formatted=time_string}else{if(expenses_string){var formatted=expenses_string}else{var formatted=App.lang("No time")}}}if(trigger_change&&$.isFunction(on_change)){on_change.apply(link[0],[total_time,total_expenses,formatted])}};var render_status=function(record){switch(record.billable_status){case 0:return App.lang("Not Billable");case 1:return App.lang("Billable");case 2:return App.lang("Pending Payment");case 3:return App.lang("Paid");default:return App.lang("Unknown Status")}};var create_working_row=function(){return $('<tr class="working_row"><td colspan="8"><img src="'+App.Wireframe.Utils.indicatorUrl("small")+'" alt="" /> '+App.lang("Working")+"</td></tr>")};var init_item_form_row=function(row,on_valid,on_success,on_error,on_cancel){var form=row.find("form");form.find("a.item_form_cancel").click(function(){on_cancel.apply(form[0]);return false});form.submit(function(){if(row.is("tr.time_record_form")){var data={"time_record[user_id]":form.find("div.time_record_user select").val(),"time_record[value]":jQuery.trim(form.find("div.time_record_value input").val()),"time_record[job_type_id]":form.find("div.time_record_job_type select").val(),"time_record[record_date]":jQuery.trim(form.find("div.time_record_date input").val()),"time_record[summary]":jQuery.trim(form.find("div.time_record_summary input").val()),"time_record[billable_status]":form.find("div.time_record_billable select").val(),submitted:"submitted"};if(data["time_record[value]"]==""){form.find("div.time_record_value input").focus();return false}if(data["time_record[record_date]"]==""){form.find("div.time_record_date input").focus();return false}}else{var data={"expense[user_id]":form.find("div.expense_user select").val(),"expense[value]":jQuery.trim(form.find("div.expense_value input").val()),"expense[category_id]":jQuery.trim(form.find("div.expense_category select").val()),"expense[record_date]":jQuery.trim(form.find("div.expense_date input").val()),"expense[summary]":jQuery.trim(form.find("div.expense_summary input").val()),"expense[billable_status]":form.find("div.expense_billable select").val(),submitted:"submitted"};if(data["expense[value]"]==""){form.find("div.expense_value input").focus();return false}if(data["expense[record_date]"]==""){form.find("div.expense_date input").focus();return false}}on_valid();$.ajax({url:form.attr("action"),type:"post",data:data,success:function(response){on_success(response)},error:function(response){on_error(response)}});return false})};var init_row=function(row){row.find("td.options a.trash").asyncLink({confirmation:App.lang("Are you sure that you want to move this time record to the Trash?"),indicator_url:App.Wireframe.Utils.indicatorUrl(),success:function(response){App.Wireframe.Events.trigger(response.event_names.deleted,response);var message=row.is("tr.time_record")?App.lang("Time record has been successfully moved to Trash"):App.lang("Expense has been successfully moved to Trash");row.remove();dialog_update(true);App.Wireframe.Flash.success(message)},error:function(){App.Wireframe.Flash.error("Failed to move selected time record to the Trash. Please try again later")}})};log_table.find("tbody tr.item").each(function(){init_row($(this))});wrapper.delegate("td.options a.edit","click",function(){var link=$(this);var row=link.parents("tr:first");var working_row=create_working_row();row.hide().after(working_row);$.ajax({url:App.extendUrl(link.attr("href"),{thin_form:1}),type:"get",success:function(response){var edit_row=$(response);working_row.after(edit_row).remove();init_item_form_row(edit_row,function(){edit_row.remove();working_row=create_working_row();row.after(working_row)},function(record){working_row.remove();App.Wireframe.Utils.userLink(record.user,true).appendTo(row.find("td.user").empty());if(record["class"]=="Expense"){row.find("td.job_type").empty().text(record.category["name"]);row.find("td.value").empty().text(App.moneyFormat(record.value,record.currency["code"]))}else{row.find("td.job_type").empty().text(record.job_type["name"]);row.find("td.value").empty().text(App.hoursFormat(record.value))}row.find("td.record_date").empty().text(record.record_date["formatted_date_gmt"]);var summary_text=record.summary?App.clean(record.summary):"";row.find("td.summary").empty().append(summary_text);row.find("td.status").empty().text(record.billable_status_verbose);row.show().find("td").highlightFade();App.Wireframe.Events.trigger(record.event_names.updated,record);dialog_update(true)},function(response){working_row.remove();row.show();App.Wireframe.Flash.error("Failed to submit changes. Please try again later")},function(){edit_row.remove();row.show()})},error:function(response){working_row.remove();row.show();App.Wireframe.Flash.error("Failed to load edit form. Please try again later")}});return false});wrapper.find("form").submit(function(){var form=$(this);var user_select=log_table.find("tr.add_time_or_expense td.user select");if(user_select.length){var user_id=user_select.val()}else{var user_id=log_table.find("tr.add_time_or_expense td.user input[type=hidden]").attr("value")}var record_date=jQuery.trim(log_table.find("tr.add_time_or_expense td.record_date input").val());var value=jQuery.trim(value_field.val());if(value.indexOf(":")==-1){if(value){value=App.parseNumeric(value)}if(isNaN(value)||value<=0){App.Wireframe.Flash.error("Please insert a valid record value");value_field.val("").focus()}}if(user_id&&record_date&&value){form.find("input, select").attr("disabled","disabled");log_table.find("tr.add_time_or_expense td.options").find("button").hide();log_table.find("tr.add_time_or_expense td.options").append('<img src="'+App.Wireframe.Utils.indicatorUrl()+'" />');if(log_table.find("tr.add_time_or_expense td.type input").val()=="expense"){var type="expense";var add_url=wrapper.attr("add_expense_url");var icon_url=wrapper.attr("expense_icon_url");var verbose_name=App.lang("Expense")}else{var type="time_record";var add_url=wrapper.attr("add_time_url");var icon_url=wrapper.attr("time_icon_url");var verbose_name=App.lang("Time Record")}var data={submitted:"submitted"};data[type+"[value]"]=value;data[type+"[user_id]"]=user_id;if(type=="expense"){data[type+"[category_id]"]=log_table.find("tr.add_time_or_expense td.job_type select.expense_control").val()}else{data[type+"[job_type_id]"]=log_table.find("tr.add_time_or_expense td.job_type select.timerecord_control").val()}data[type+"[record_date]"]=record_date;data[type+"[summary]"]=summary_field.val();data[type+"[billable_status]"]=log_table.find("tr.add_time_or_expense td.status select").val();$.ajax({url:add_url,type:"post",data:data,success:function(response){App.Wireframe.Events.trigger(response.event_names.created,response);form.find("input, select").removeAttr("disabled");log_table.find("tr.add_time_or_expense td.options").find("img").remove();log_table.find("tr.add_time_or_expense td.options").find("button").show();if($.isPlainObject(response)){var new_row=$('<tr class="item '+type+'"><td class="type"><img src="'+icon_url+'" title="'+verbose_name+'" /></td><td class="user"></td><td class="job_type"> '+(response["class"].toLowerCase()=="timerecord"?App.clean(response.job_type["name"]):App.clean(response.category["name"]))+'</td><td class="record_date">'+response.record_date["formatted_date_gmt"]+'</td><td class="value right">'+(type=="time_record"?App.hoursFormat(response.value):App.moneyFormat(response.value,response.currency["code"]))+'</td><td class="summary">'+App.clean(response.summary)+'</td><td class="status">'+render_status(response)+'</td><td class="options"><a href="'+response.urls["edit"]+'" title="'+App.lang("Edit")+'" class="edit"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/edit.png","environment")+'" alt="" /></a><a href="'+response.urls["trash"]+'" title="'+App.lang("Move to Trash")+'" class="trash"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/move-to-trash.png","system")+'" alt="" /></a></td></tr>');App.Wireframe.Utils.userLink(response.user,true).appendTo(new_row.find("td.user"));log_table.find("tr.add_time_or_expense").after(new_row);init_row(new_row);new_row.find("td").highlightFade();form.find("td.value input, td.summary input").val("");value_field.focus();dialog_update(true)}else{if(type=="expense"){App.Wireframe.Flash.error(App.lang("Failed to log expense. Please try again later"))}else{App.Wireframe.Flash.error(App.lang("Failed to log time. Please try again later"))}value_field.focus()}},error:function(response){form.find("input, select").removeAttr("disabled");log_table.find("tr.add_time_or_expense td.options").find("img").remove();log_table.find("tr.add_time_or_expense td.options").find("button").show();if(type=="expense"){App.Wireframe.Flash.error(App.lang("Failed to log expense. Please try again later"))}else{App.Wireframe.Flash.error(App.lang("Failed to log time. Please try again later"))}value_field.focus()}})}else{if(user_id){if(record_date){value_field.focus()}else{log_table.find("tr.add_time_or_expense td.record_date input").focus()}}else{log_table.find("tr.add_time_or_expense td.user select").focus()}}return false});dialog_update(false)}});return false})})};
