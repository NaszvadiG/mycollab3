App.widgets.AvatarDialog=function(){var wrapper;var avatar_table;var crop_avatar_anchor;var reset_avatar_anchor;var upload_new_avatar_anchor;var hidden_upload_form;var hidden_upload_form_field;var current_avatar;var default_avatar_url;var original_avatar_url;var avatar_actions;var crop_widget;var crop_widget_wrapper;var crop_widget_crop_controls;var original_image;var event_name;var success_callback=function(object){App.Wireframe.Events.trigger(event_name,[object])};return{init:function(wrapper_id,options){wrapper=$("#"+wrapper_id);avatar_table=wrapper.find(".fw_avatar_table:first");current_avatar=wrapper.find(".current_avatar:first");avatar_actions=wrapper.find(".fw_avatar_actions .action_list");upload_new_avatar_anchor=wrapper.find(".fw_avatar_action_upload_new_picture");crop_widget=wrapper.find(".fw_crop_widget");crop_widget_wrapper=crop_widget.find(".fw_crop_widget_wrapper");original_image=crop_widget_wrapper.find("img.original_image");default_avatar_url=options.default_avatar;original_avatar_url=options.original_avatar;event_name=options.event_name;reset_avatar_anchor=wrapper.find(".fw_avatar_action_reset_to_default_picture:first").click(function(){App.widgets.AvatarDialog.resetAvatar();return false});hidden_upload_form=wrapper.find("form.hidden_upload_form");hidden_upload_form_field=hidden_upload_form.find("input[type=file]:first");upload_new_avatar_anchor.click(function(){hidden_upload_form_field.click();return false});hidden_upload_form_field.change(function(){App.widgets.AvatarDialog.uploadAvatar();return false});crop_avatar_anchor=wrapper.find(".fw_avatar_action_crop_picture:first").click(function(){App.widgets.AvatarDialog.showCropControls();return false});if(options.is_default){crop_avatar_anchor.parents("li:first").hide();reset_avatar_anchor.parents("li:first").hide()}crop_widget.find(".fw_crop_buttons button:first").click(function(){var max_left_offset=crop_widget_wrapper.width()-crop_widget_crop_controls.outerWidth();var max_top_offset=crop_widget_wrapper.height()-crop_widget_crop_controls.outerHeight();var current_left=crop_widget_crop_controls.position().left;var current_top=crop_widget_crop_controls.position().top;var left_ratio=Math.floor((current_left/max_left_offset)*100);var top_ratio=Math.floor((current_top/max_top_offset)*100);crop_widget.block();$.ajax({url:App.extendUrl(crop_avatar_anchor.attr("href"),{skip_layout:1}),type:"post",data:{submitted:"submitted",left_offset:left_ratio,top_offset:top_ratio},success:function(response){var resulting_object=response;current_avatar.attr("src",response.avatar._largest_size);App.widgets.AvatarDialog.hideCropControls();crop_widget.unblock();success_callback(response)},error:function(response,response_message){crop_widget.unblock()}})});crop_widget.find(".fw_crop_buttons a:first").click(function(){App.widgets.AvatarDialog.hideCropControls();return false})},uploadAvatar:function(){wrapper.block();hidden_upload_form.ajaxSubmit({url:App.extendUrl(hidden_upload_form.attr("action"),{skip_layout:1,async:1}),data:{submitted:"submitted"},dataType:"json",success:function(response){if(response.error){App.Wireframe.Flash.error(response.message)}else{response.body=(""+response.body).unclean();response.body_formatted=(""+response.body_formatted).unclean();response.overview=(""+response.overview).unclean();response.overview_formatted=(""+response.overview_formatted).unclean();current_avatar.attr("src",response.avatar._largest_size);original_avatar_url=App.extendUrl(response.avatar._full_size,{time:new Date().getTime()});if(response["class"]=="Company"){App.Wireframe.Flash.success(App.lang("Company logo successfully updated"))}else{if(response["class"]=="Project"){App.Wireframe.Flash.success(App.lang("Project icon successfully updated"))}else{App.Wireframe.Flash.success(App.lang("Avatar successfully updated"))}}crop_avatar_anchor.parents("li:first").show();reset_avatar_anchor.parents("li:first").show();hidden_upload_form_field.val("");hidden_upload_form[0].reset();success_callback(response)}wrapper.unblock()},error:function(response,response_text){wrapper.unblock();App.Wireframe.Flash.error(App.lang("Unexpected error occurred"))}})},resetAvatar:function(){if(!confirm(App.lang("Are you sure you want to reset this picture to default one"))){return false}wrapper.block();$.ajax({type:"post",data:{submitted:"submitted"},url:App.extendUrl(reset_avatar_anchor.attr("href"),{skip_layout:1}),success:function(response){current_avatar.attr("src",default_avatar_url);wrapper.unblock();crop_avatar_anchor.parents("li:first").hide();reset_avatar_anchor.parents("li:first").hide();success_callback(response)},error:function(response,responseText){wrapper.unblock();App.Wireframe.Flash.error(App.lang("Failed to reset avatar"))}})},showCropControls:function(){avatar_table.hide();crop_widget.show();crop_widget_wrapper.css("position","static");crop_widget.css("position","static");original_image=$('<img class="original_image" />').attr("src",original_avatar_url).load(function(){if(!original_image.attr("src")){return false}var image_max_height=400;var image_max_width=800;var crop_image_width=this.naturalWidth;var crop_image_height=this.naturalHeight;var scale=Math.min(image_max_width/crop_image_width,image_max_height/crop_image_height);var final_height;if(scale<1){crop_widget_wrapper.css("width",Math.floor(crop_image_width*scale));final_height=Math.floor(crop_image_height*scale)}else{crop_widget_wrapper.css("width",crop_image_width);final_height=crop_image_height}var min_dimension=Math.min(final_height,crop_widget_wrapper.width())-2;crop_widget_wrapper.clearQueue().animate({height:final_height},400,function(){crop_widget_wrapper.css("position","relative");crop_widget_crop_controls=$('<div class="crop_controls"></div>').appendTo(crop_widget_wrapper);crop_widget_crop_controls.height(min_dimension).width(min_dimension);crop_widget_crop_controls.draggable({containment:"parent"});original_image.show()})}).appendTo(crop_widget_wrapper)},hideCropControls:function(){crop_widget.animate({opacity:0},300,function(){crop_widget_crop_controls.remove();original_image.remove();crop_widget_wrapper.css("width","auto").css("height","auto").css("position","static");crop_widget.css("position","static");crop_widget.animate({height:avatar_table.height()},300,function(){crop_widget.css("height","auto").css("opacity","1").hide();avatar_table.css("opacity",0).show().animate({opacity:1},300,function(){})})})}}}();