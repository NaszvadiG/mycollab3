(function($){var methods={init:function(options){return this.each(function(){var wrapper=$(this);var wrapper_dom=this;wrapper.addClass("advanced_upload");this.fu_variables={};this.fu_variables.wrapper_id=wrapper.attr("id");this.fu_variables.form=wrapper.parents("form:first");this.fu_variables.attachment_list=wrapper.find(".select_attachments_list:first");this.fu_variables.form_field_name=options.pending_field_name;this.fu_variables.form_delete_field_name=options.delete_field_name;this.fu_variables.uploader=new plupload.Uploader({runtimes:options.uploader_runtimes,container:options.wrapper_id+"_attach_file_button_wrapper",browse_button:options.wrapper_id+"_attach_file_button",max_file_size:options.max_file_size,url:App.extendUrl(options.upload_url,{advanced_upload:1}),file_data_name:options.upload_name,flash_swf_url:options.flash_uploader_url,silverlight_xap_url:options.silverlight_uploader_url,multipart:true,multipart_params:{submitted:"submitted"}});this.fu_variables.uploader.bind("FilesAdded",function(uploader,files){files_added.apply(wrapper_dom,[files])});this.fu_variables.uploader.bind("UploadProgress",function(uploader,file){update_file_progress.apply(wrapper_dom,[file])});this.fu_variables.uploader.bind("FileUploaded",function(uploader,file,response){eval("var response = "+response.response);if(response&&response.type=="Error"){response.file=file;upload_error.apply(wrapper_dom,[response])}else{finalize_file_upload.apply(wrapper_dom,[file,response])}});this.fu_variables.uploader.bind("Error",function(uploader,error){upload_error.apply(wrapper_dom,[error])});this.fu_variables.uploader.bind("UploadComplete",function(uploader){wrapper_dom.fu_variables.form.removeClass("uploading")});this.fu_variables.uploader.init();wrapper.on("click","td.delete_attachment a",function(){remove_file.apply(wrapper_dom,[$(this).parents("tr:first")]);return false});if(options.existing_attachments&&options.existing_attachments.length){$.each(options.existing_attachments,function(index,existing_attachment){add_file.apply(wrapper_dom,[{name:existing_attachment.filename},existing_attachment.id])})}})},reset:function(){return this.each(function(){reset.apply(this)})}};var files_added=function(files){var wrapper_dom=this;$.each(files,function(file_id,file){add_file.apply(wrapper_dom,[file])});if(this.fu_variables.uploader.state==plupload.STOPPED){setTimeout(function(){wrapper_dom.fu_variables.uploader.start()},20)}this.fu_variables.form.addClass("uploading")};var add_file=function(file,real_id){var attachment_row=$('<tr class="attachment"></tr>').appendTo(this.fu_variables.attachment_list);attachment_row.append('<td class="delete_attachment"><a href="#">'+App.lang("Remove")+"</a></td>");attachment_row.append('<td class="file_icon"><img src="'+get_icon(App.clean(file.name))+'" /></td>');attachment_row.append('<td class="filename"><div>'+App.excerpt(App.clean(file.name),24)+"</div></td>");if(real_id){attachment_row.attr("real_id",real_id)}else{attachment_row.attr("uploading_id",file.id).addClass("uploading");attachment_row.find("td.filename div").append('<span class="progressbar"><span class="progressbar_inner"></span></span>')}};var get_icon=function(file_name){var dot_index=file_name.lastIndexOf(".");var file_type=file_name.substring((dot_index+1)).toLowerCase();if(dot_index>=0&&$.inArray(file_type,App.getAvailableFileTypes())!=-1){return App.Wireframe.Utils.imageUrl("/file-types/16x16/"+file_type+".png","environment")}else{return App.Wireframe.Utils.imageUrl("/file-types/16x16/default.png","environment")}};var remove_file=function(file_row){var wrapper=$(this);var real_id=file_row.attr("real_id");var uploading_id=file_row.attr("uploading_id");if(real_id){wrapper.append('<input type="hidden" name="'+this.fu_variables.form_delete_field_name+'" value="'+real_id+'" class="attachment_pending_deletion" />')}else{this.fu_variables.uploader.removeFile(uploading_id)}file_row.remove()};var get_file_row=function(file_id){return this.fu_variables.attachment_list.find('tr[uploading_id="'+file_id+'"]:first')};var update_file_progress=function(file){var file_row=get_file_row.apply(this,[file.id]);if(file_row.length){file_row.find("span.progressbar span.progressbar_inner").css("width",file.percent+"%")}};var finalize_file_upload=function(file,uploaded_file){var file_row=get_file_row.apply(this,[file.id]);if(file_row.length){file_row.find("span.progressbar").remove();file_row.attr("uploading_id","").attr("real_id",uploaded_file.id).removeClass("uploading");file_row.find("td.filename").append('<input type="hidden" name="'+this.fu_variables.form_field_name+'" value="'+uploaded_file.id+'" />')}};var upload_error=function(error){var file=error.file;var file_row=get_file_row.apply(this,[file.id]);if(file_row.length){file_row.remove()}if(error.message){App.Wireframe.Flash.error('File ":name" is too large',{name:file.name})}else{App.Wireframe.Flash.error("Upload Failed")}this.fu_variables.uploader.refresh();if(file_row.parent().find("tr.attachment.uploading").length<1){this.fu_variables.form.removeClass("uploading")}};var reset=function(){var wrapper=$(this);this.fu_variables.uploader.stop();this.fu_variables.uploader.splice(0,this.fu_variables.uploader.files.length);this.fu_variables.uploader.refresh();this.fu_variables.attachment_list.empty();wrapper.find("input.attachment_pending_deletion").remove()};$.fn.selectAttachments=function(method){var plugin_arguments=arguments;if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(plugin_arguments,1))}else{if(typeof method==="object"||!method){return methods.init.apply(this,plugin_arguments)}else{$.error("Method "+method+" does not exist on jQuery.tooltip")}}}})(jQuery);