jQuery.fn.objectComments=function(s){var settings=jQuery.extend({total_comments:0,comments:null,first_comment:null,comments_url:"#",user_id:0,user_email:null},s);return this.each(function(){var wrapper=$(this);var add=function(comment,mode){var row=$('<div class="comment loaded" id="'+wrapper.attr("id")+"_comment_"+comment.id+'" comment_id="'+comment.id+'"><div class="comment_avatar_container"></div><div class="comment_content_container"><div class="meta"></div><div class="options"></div><div class="body formatted_content"></div></div></div>');if(comment.created_by["id"]==0){if(comment.created_by["id"]==0&&comment.created_by["email"]==settings.user_email){row.addClass("mine")}}else{if(comment.created_by["id"]==settings.user_id){row.addClass("mine")}}update(row,comment);var comment_options=row.find("div.options");var options_id_prefix=wrapper.attr("id")+"__comment_"+comment.id+"_";if(typeof(comment.options)=="object"){for(var option_name in comment.options){var option=$('<a href="'+comment.options[option_name]["url"]+'" class="auto_hide"><img src="'+comment.options[option_name]["icon"]+'"></a>').attr("id",options_id_prefix+"_"+option_name).appendTo(comment_options);if(typeof(comment.options[option_name]["attributes"])=="object"&&comment.options[option_name]["attributes"]){option.attr(comment.options[option_name]["attributes"])}if(typeof(comment.options[option_name]["classes"])=="object"&&comment.options[option_name]["classes"]){for(var i in comment.options[option_name]["classes"]){option.addClass(comment.options[option_name]["classes"][i])}}if(typeof(comment.options[option_name]["onclick"])=="string"&&comment.options[option_name]["onclick"]){var onclick=eval(comment.options[option_name]["onclick"]);if(typeof(onclick)=="function"){onclick.apply(option[0])}}}comment_options.find("#"+options_id_prefix+"_edit").click(function(){var link=$(this);var working_row=create_working_row();row.stop(true,true).animate({opacity:0},500,function(){row.after(working_row);working_row.css("height",row.height()+"px").css("line-height",row.height()+"px").show();row.hide();$.ajax({url:link.attr("href"),type:"get",success:function(response){var edit_row=$(response);working_row.after(edit_row);edit_row=edit_row.eq(0);edit_row.data("original_height",edit_row.height());working_row.stop(true,true).animate({opacity:0,height:edit_row.height()},500,function(){working_row.remove();show_comment_form_row(edit_row,true)});init_comment_form_row(edit_row,function(){edit_row.stop(true,true).animate({opacity:0},500,function(){working_row=create_working_row();working_row.insertAfter(edit_row);working_row.css("height",edit_row.height()+"px").css("line-height",edit_row.height()+"px").show();edit_row.remove();working_row.stop(true,true).animate({opacity:1},500)})},function(response){update(row,response);working_row.stop(true,true).animate({opacity:0,height:parseInt(row.height())},500,function(){working_row.remove();row.stop(true,true).show().animate({opacity:1},500)})},function(response){working_row.stop(true,true).animate({opacity:0,height:parseInt(row.height())},500,function(){working_row.remove();row.stop(true,true).show().animate({opacity:1},500)});App.Wireframe.Flash.error("Failed to update comment. Please try again later")},function(){edit_row.stop(true,true).animate({opacity:0,height:row.height()},500,function(){edit_row.remove();row.show().stop(true,true).animate({opacity:1})})})},error:function(){working_row.stop(true,true).animate({opacity:0,height:parseInt(row.height())},500,function(){working_row.remove();row.stop(true,true).show().animate({opacity:1},500)});App.Wireframe.Flash.error("Failed to update comment. Please try again later")}})});return false});comment_options.find("#"+options_id_prefix+"_trash").asyncLink({confirmation:App.lang("Are you sure that you want to permanently remove this comment?"),before_send:function(){working_row=create_working_row();row.after(working_row);working_row.css("opacity",0).css("height",row.height()+"px").css("line-height",row.height()+"px").hide();row.animate({opacity:0},500,function(){row.hide();working_row.show().animate({opacity:1},500)})},success:function(){working_row.animate({opacity:0},500,function(){working_row.animate({height:0},500,function(){working_row.remove();row.remove();settings.total_comments-=1;update_indicator_rows();refresh_comment_numbers()})})},error:function(){working_row.animate({opacity:0},500,function(){working_row.remove();row.show().animate({opacity:1},500,function(){App.Wireframe.Flash.error("Failed to remove comment. Please try again later")})})}})}switch(mode){case"new":wrapper.find("div.new_comment").after(row);settings.total_comments+=1;break;case"first":var load_more=wrapper.find("p.load_more");if(load_more.length>0){load_more.after(row)}else{wrapper.append(row)}break;case"more":var load_more=wrapper.find("p.load_more");if(load_more.length>0){load_more.before(row)}else{wrapper.append(row)}break;default:wrapper.append(row)}if(mode!="bulk"){refresh_comment_numbers()}};var update=function(row,comment){var avatar_container=row.find("div.comment_avatar_container").empty();var avatar=$("<a><img></a>").addClass("avatar").attr("href",comment.created_by["urls"]["view"]).css("background-image",'url("'+comment.created_by["avatar"]["large"]+'")').appendTo(avatar_container);avatar.find("img").attr("src",comment.created_by["avatar"]["large"]);var meta_container=row.find("div.meta").empty();$('<span class="author"></span>').append(App.Wireframe.Utils.userLink(comment.created_by,true)).appendTo(meta_container);$('<span class="date"></span>').append(App.Wireframe.Utils.ago(comment.created_on)).appendTo(meta_container);var content_container=row.find("div.comment_content_container div.body").empty();content_container.html(comment.body_formatted);if(typeof(comment.attachments)=="object"&&comment.attachments){$('<div class="object_attachments">').attr("id",wrapper.attr("id")+"_comment_"+comment.id+"_attachments").objectAttachments({attachments:comment.attachments,object:{id:comment.id,"class":comment["class"],listen:comment.event_names["updated"]}}).appendTo(content_container)}};var create_working_row=function(skip_text){var working_row=$('<div class="working"></div>').hide();if(!skip_text){working_row.append('<img src="'+App.Wireframe.Utils.indicatorUrl("small")+'" alt="" /> '+App.lang("Working"))}return working_row};var init_comment_form_row=function(row,on_valid,on_success,on_error,on_cancel){var form=row.find("form");var body_field=form.find("#"+row.attr("id")+"_comment_body");if(!body_field.is("textarea")){body_field=form.find("#"+row.attr("id")+"_comment_body_textarea")}form.find("a.comment_cancel").click(function(){on_cancel.apply(form[0]);return false});setTimeout(function(){body_field.get(0).initial_value=body_field.val()},100);form.submit(function(){if(body_field.is("textarea.visual_editor_textarea")){body_field.visualEditor("save")}var body_value=body_field.val();if(body_value==""||body_value.length<3){body_field.focus();return false}if(!App.widgets.FormPendingAction.init(form)){return false}var data=form.serialize();on_valid.apply(form[0]);setTimeout(function(){$.ajax({url:form.attr("action"),type:"post",data:data,success:function(response){on_success.apply(form[0],[response]);var editor_still_exists=body_field.parents("body:first").length;if(editor_still_exists){if(body_field.is("textarea.visual_editor_textarea")){body_field.visualEditor("setContent","")}else{body_field.val("")}}if(typeof(response.parent)=="object"&&response.parent){App.Wireframe.Events.trigger(response.parent.event_names.updated,[response.parent])}App.Wireframe.Events.trigger(response.event_names.created,[response])},error:function(response){on_error.apply(form[0],[response])}})},1000);return false})};var toggle_new_comment_form_row=function(row){if(row.is(":visible")){row.animate({opacity:0},200,function(){working_row=create_working_row(true);working_row.insertBefore(row).css("height",row.height()).show();row.hide();working_row.animate({height:0},400,function(){working_row.remove()})})}else{show_comment_form_row(row)}};var show_comment_form_row=function(row,skip_size){if(skip_size){row.css("opacity",0).show().animate({opacity:1},200,function(){var editor=row.find('textarea[name="comment[body]"]:first');if(editor.is(".visual_editor_textarea")){editor.visualEditor("focus")}else{editor.focus()}})}else{working_row=create_working_row(true);working_row.insertBefore(row).css("height","30px").show();if(row.data("original_height")===undefined){row.data("original_height",row.css("height"))}row.hide().css("opacity",0).css("height","auto");working_row.animate({height:row.data("original_height")},200,function(){working_row.remove();var select_attachments=row.show().find("div.select_attachments");select_attachments.selectAttachments("reset");var editor=row.find('textarea[name="comment[body]"]:first');if(editor.is(".visual_editor_textarea")){editor.visualEditor("focus")}else{editor.focus()}row.animate({opacity:1},200,function(){var docViewTop=$(window).scrollTop();var docViewBottom=docViewTop+$(window).height();var elemTop=$(row).offset().top;var elemBottom=elemTop+$(row).height();var is_scrolled_into_view=((elemBottom>=docViewTop)&&(elemTop<=docViewBottom)&&(elemBottom<=docViewBottom)&&(elemTop>=docViewTop));if(!is_scrolled_into_view){var object_details_container=wrapper.parents("div.objects_list_details:first");if(object_details_container.length){object_details_container.scrollTop(row.offset().top-object_details_container.offset().top+object_details_container.scrollTop())}}})})}};var refresh_comment_numbers=function(){var comments=wrapper.find("div.comment.loaded");var counter=comments.length;if(counter){comments.each(function(){var comment=$(this);var number_wrapper=comment.find("div.options span.comment_number");if(number_wrapper.length<1){number_wrapper=$('<span class="comment_number"></span>').appendTo(comment.find("div.options"))}number_wrapper.text("#"+counter);counter--})}};var add_comment_form_row=wrapper.find("div.new_comment");if(add_comment_form_row.length>0){var add_comment_button=$('<a href="#" class="section_button"><span><img src="'+App.Wireframe.Utils.imageUrl("icons/16x16/new-comment-section-button.png","comments")+'" />'+App.lang("Leave a Comment")+"</span></a>").click(function(){toggle_new_comment_form_row(add_comment_form_row);return false});var comments_locked=$('<span class="object_comments_locked"><img src="'+App.Wireframe.Utils.imageUrl("icons/24x24/comments-locked.png","comments")+'" />'+App.lang("Comments for this :object_type are locked",{object_type:settings.object.verbose_type_lowercase})+"</span>").hide();var add_comment_button_wrapper=$('<div class="section_button_wrapper"></div>').append(add_comment_button).append(comments_locked);wrapper.prepend(add_comment_button_wrapper);init_comment_form_row(add_comment_form_row,function(){add_comment_form_row.stop(true,true).animate({opacity:0},500,function(){working_row=create_working_row();working_row.insertAfter(add_comment_form_row);working_row.css("height",add_comment_form_row.height()+"px").css("line-height",add_comment_form_row.height()+"px").show();add_comment_form_row.hide();working_row.stop(true,true).animate({opacity:1},500)})},function(response){working_row.remove();add(response,"new");update_indicator_rows()},function(){working_row.animate({opacity:0},500,function(){working_row.remove();add_comment_form_row.show().animate({opacity:1},500,function(){App.Wireframe.Flash.error("Failed to post a comment. Please try again later")})})},function(){toggle_new_comment_form_row(add_comment_form_row)})}var update_indicator_rows=function(){var load_more=wrapper.find("p.load_more");if(load_more.length>0){var comments_displayed=wrapper.find("div.comment.loaded").length;if(comments_displayed==settings.total_comments){load_more.hide()}else{load_more.find("span.num").text(comments_displayed);load_more.show()}}};if(jQuery.isArray(settings.comments)){var comments_length=settings.comments.length;for(var i=0;i<comments_length;i++){add(settings.comments[i],"bulk")}refresh_comment_numbers()}else{var comments_length=0}if(settings.total_comments&&settings.total_comments>comments_length){var comments_displayed=comments_length;if(typeof(settings.first_comment)=="object"&&settings.first_comment){comments_displayed+=1}if(typeof(settings.first_comment)=="object"&&(settings.total_comments==comments_displayed)){add(settings.first_comment)}else{var load_more=$('<p class="load_more">'+App.lang('Showing <span class="num">:num</span> of <span class="total">:total</span> comments. <a href=":url" class="load_more">Load more</a>.',{num:comments_displayed,total:settings.total_comments,url:settings.comments_url})+"</p>").appendTo(wrapper);load_more.find("a.load_more").click(function(){var loaded_comments=[];wrapper.find("div.comment.loaded").each(function(){loaded_comments.push($(this).attr("comment_id"))});var loading_more=$('<p class="loading_more"><img src="'+App.Wireframe.Utils.indicatorUrl()+'"></p>');load_more.hide().after(loading_more);$.ajax({url:App.extendUrl($(this).attr("href"),{timestamp:wrapper.attr("load_timestamp"),loaded_comment_ids:loaded_comments.join(",")}),type:"get",success:function(response){loading_more.remove();if(typeof(response)=="object"&&response){for(var i in response){add(response[i],"more")}}load_more.remove()},error:function(){loading_more.remove();load_more.show();App.Wireframe.Flash.error("Failed to load more comments. Please try again later")}});return false});if(typeof(settings.first_comment)=="object"&&settings.first_comment){add(settings.first_comment,"first")}}}var comment_form=wrapper.find("div.new_comment").hide();var comment_button=wrapper.find("div.section_button_wrapper:first a.section_button").hide();var comments_locked=wrapper.find("div.section_button_wrapper:first span.object_comments_locked:first").hide();var comment_form_parent_completion=comment_form.find("#parent_completion");var comment_form_parent_label_id=comment_form.find("#parent_label_id");var comment_form_parent_assignee_id=comment_form.find("#parent_assignee_id");var comment_form_parent_parent_category_id=comment_form.find("#parent_category_id");var handle_comment_form=function(response){if(settings.object.permissions.can_comment){comment_button.show();comments_locked.hide()}else{comment_form.hide();comment_button.hide();if(settings.object.is_locked){comments_locked.show()}else{comments_locked.hide()}}if(comment_form_parent_completion.length){comment_form_parent_completion.val(settings.object.is_completed?1:0)}if(comment_form_parent_assignee_id.length&&"assignee" in settings.object){comment_form_parent_assignee_id.val(typeof(settings.object["assignee"])=="object"&&settings.object["assignee"]?settings.object["assignee"]["id"]:0)}if(comment_form_parent_label_id.length){comment_form_parent_label_id.val(typeof(settings.object["label"])=="object"&&settings.object["label"]?settings.object["label"]["id"]:settings.object["label_id"])}if(comment_form_parent_parent_category_id.length){comment_form_parent_parent_category_id.val(typeof(settings.object["category"])=="object"&&settings.object["category"]?settings.object["category"]["id"]:settings.object["category_id"])}};handle_comment_form();var subscribers_line=wrapper.find("div.comment_subscribers");var update_subscribers=function(){subscribers_line.empty().hide();if(!settings.object.subscribers||!settings.object.subscribers.length){return false}subscribers_line.show();var subscribers=new Array();App.each(settings.object.subscribers,function(index,subscriber){subscribers.push('<a href="'+subscriber.permalink+'">'+App.clean(subscriber.short_display_name)+"</a>")});subscribers_line.append(subscribers.join(", "));var manage_subscribers=$('<a href="'+settings.object.urls.subscriptions+'" class="manage_subscribers" title="'+App.lang("Manage Subscribers")+'"><img src="'+App.Wireframe.Utils.imageUrl("/icons/16x16/object-subscription-active.png","subscriptions")+'" /></a>').prependTo(subscribers_line);manage_subscribers.flyoutForm({success_event:"subscriptions_managed",width:"narrow"})};update_subscribers();var is_form_modified=function(){var new_form_row=wrapper.find("div.new_comment form");if(new_form_row.is(":visible")){var textarea=new_form_row.find("textarea.visual_editor_textarea:first");if($.trim(textarea.val())){return true}}var change_exists=false;$.each(wrapper.find("div.edit_comment.quick_comment_form:visible"),function(index,edit_row){edit_row=$(edit_row);var edit_textarea=edit_row.find("textarea.visual_editor_textarea:first");if(edit_textarea.get(0).initial_value!=edit_textarea.val()){change_exists=true;return false}});if(change_exists){return true}return false};var scope=settings.event_scope;App.Wireframe.Events.bind(settings.object.event_names.updated+"."+scope+" "+settings.object.event_names.deleted+"."+scope,function(event,object){if(!(object["class"]==settings.object["class"]&&object.id==settings.object.id)){return false}settings.object=object;handle_comment_form();update_subscribers()});App.Wireframe.Events.bind("navigate_away."+scope,function(event){if(is_form_modified()){window.prevent_navigation=true;window.target_form=App.lang("comment form");return false}})})};