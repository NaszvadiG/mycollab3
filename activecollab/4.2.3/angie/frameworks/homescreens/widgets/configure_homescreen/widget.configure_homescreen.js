jQuery.fn.configureHomescreen=function(s){var settings=jQuery.extend({add_tab_url:null,reorder_tabs_url:null,tabs:null,event_scope:"content"},s);return this.each(function(){var wrapper=$(this).addClass("configure_homescreen");var tabs_wrapper=$('<div class="homescreen_tabs"><ul></ul></div>').appendTo(wrapper);var tabs_list=tabs_wrapper.find("ul");var tab_settings_wrapper=$('<div class="homescreen_tab_settings"></div>').appendTo(wrapper);App.Wireframe.Events.bind("homescreen_tab_added."+settings.event_scope,function(e,tab){add_tab(tab,true)});var add_tab=function(tab,select){var list_item=$('<li class="homescreen_tab real_homescreen_tab" homescreen_tab_id="'+tab.id+'"><img src="'+App.Wireframe.Utils.imageUrl("widgets-drag-handle.png","homescreens")+'" class="reoder_homescreen_tabs"> <a href="#" class="select_tab">'+App.clean(tab.name)+"</a></li>");if(tabs_list.find("li.real_homescreen_tab").length>0){tabs_list.find("li.real_homescreen_tab:last").after(list_item)}else{tabs_list.prepend(list_item)}list_item.find("a.select_tab").click(function(){select_tab($(this).parent().attr("homescreen_tab_id"));return false});list_item.append('<span class="homescreen_tab_options"><a href="'+tab.urls["edit"]+'" class="rename_homescreen_tab" title="'+App.lang("Rename")+'"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/edit-tab.png","homescreens")+'"></a><a href="'+tab.urls["delete"]+'" class="delete_homescreen_tab" title="'+App.lang("Remove")+'"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/delete-tab.png","homescreens")+'"></a></span>');var settings_wrapper=$('<div class="homescreen_tab" homescreen_tab_id="'+tab.id+'"></div>').appendTo(tab_settings_wrapper);settings_wrapper.append('<div class="homescreen_tab_header"><span class="homescreen_tab_description">'+App.lang("Tab Info")+": "+(typeof(tab.description)=="string"?App.clean(tab.description):App.lang("No description provided"))+"</span></div>"+tab.manager);list_item.find("a.rename_homescreen_tab").click(function(){var link=$(this);var tab_name_wrapper=link.parents("li.homescreen_tab:first");var tab_name=tab_name_wrapper.find("a.select_tab");var homescreen_tab_id=tab_name_wrapper.attr("homescreen_tab_id");if(homescreen_tab_id){var new_homescreen_tab_name=jQuery.trim(prompt(App.lang("Please insert new tab name"),tab_name.text()));if(new_homescreen_tab_name&&new_homescreen_tab_name!=tab_name.text()){var old_homescreen_tab_name=tab_name.text();tab_name.text(new_homescreen_tab_name);$.ajax({url:link.attr("href"),type:"post",data:{"homescreen_tab[name]":new_homescreen_tab_name,submitted:"submitted"},error:function(){tab_name.text(old_homescreen_tab_name);App.Wireframe.Flash.error('Failed to rename tab from ":old_name" to ":new_name". Please try again later',{old_name:old_homescreen_tab_name,new_name:new_homescreen_tab_name})}})}}return false});list_item.find("a.delete_homescreen_tab").asyncLink({confirmation:App.lang("Are you sure that you want to remove selected home screen tab?"),success:function(){var link=$(this);var tab_name_wrapper=link.parents("li.homescreen_tab:first");var homescreen_tab_id=tab_name_wrapper.attr("homescreen_tab_id");if(homescreen_tab_id){tab_name_wrapper.remove();tab_settings_wrapper.find("div.homescreen_tab[homescreen_tab_id="+homescreen_tab_id+"]").remove();if(tabs_wrapper.find("li.homescreen_tab.real_homescreen_tab").length>0){select_first_tab()}}App.Wireframe.Flash.success("Home screen tab has been removed");App.Wireframe.Events.trigger("homescreen_tab_deleted")}});if(select===true){select_tab(tab.id)}};var select_tab=function(homescreen_tab_id){var tab=tabs_wrapper.find("li.homescreen_tab[homescreen_tab_id="+homescreen_tab_id+"]");if(!tab.is(".selected")){tabs_wrapper.find("li.homescreen_tab.selected").removeClass("selected");tab_settings_wrapper.find("div.homescreen_tab.selected").removeClass("selected");tab.addClass("selected");tab_settings_wrapper.find("div.homescreen_tab[homescreen_tab_id="+homescreen_tab_id+"]").addClass("selected")}};var select_first_tab=function(){if(tabs_wrapper.find("li.real_homescreen_tab:first").length>0){select_tab(tabs_wrapper.find("li.real_homescreen_tab:first").attr("homescreen_tab_id"))}};if(jQuery.isArray(settings.tabs)){App.each(settings.tabs,function(i,tab){add_tab(tab)})}var save_timeout;tabs_list.sortable({axis:"x",handle:"img.reoder_homescreen_tabs",items:"li.real_homescreen_tab",forcePlaceholderSize:true,update:function(event,ui){if(save_timeout){clearTimeout(save_timeout)}save_timeout=setTimeout(function(){var data={submitted:"submitted"};var counter=1;wrapper.find("li.homescreen_tab.real_homescreen_tab").each(function(){data["homescreen_tabs["+$(this).attr("homescreen_tab_id")+"]"]=counter++});$.ajax({url:settings.reorder_tabs_url,type:"post",data:data,success:function(){if(save_timeout){clearTimeout(save_timeout)}},error:function(){if(save_timeout){clearTimeout(save_timeout)}App.Wireframe.Flash.error("Failed to reorder tabs. Please try again later")}})},1000)}});select_first_tab()})};