(function($){var methods={init:function(s){var settings=jQuery.extend({columns:null,reoder_widgets_url:null},s);return this.each(function(){var wrapper=$(this);if(typeof(settings.columns)&&settings.columns){for(var column_id in settings.columns){var column_wrapper=$('<div class="homescreen_column_wrapper '+settings.columns[column_id]["wrapper_class"]+'"></div>').appendTo(wrapper);var column=$('<div class="homescreen_column homescreen_column_'+column_id+'" column_id="'+column_id+'"></div>').appendTo(column_wrapper);if(typeof(settings.columns[column_id]["widgets"])=="object"&&settings.columns[column_id]["widgets"]){$.each(settings.columns[column_id]["widgets"],function(i,widget){wrapper.manageHomescreenWidgets("add_widget",column_id,widget)})}else{column.addClass("no_widgets").append('<p class="no_widgets">'+App.lang("Empty")+"</p>")}if(settings.columns[column_id]["add_widget_url"]){$('<a href="'+settings.columns[column_id]["add_widget_url"]+'" title="'+App.lang("Add a Widget")+'" class="add_widget link_button_alternative"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/add-tab.png","homescreens")+'">'+App.lang("Add Widget")+"</a>").flyoutForm({width:800,success:function(widget){wrapper.manageHomescreenWidgets("add_widget",widget.column_id,widget)},success_event:"homescreen_widget_created"}).appendTo(column_wrapper.find("div.homescreen_column:first"))}}}var update_empty=function(){wrapper.find("div.homescreen_column").each(function(){var column=$(this);if(column.find("div.homescreen_widget").length>0){column.removeClass("no_widgets").find("p.no_widgets").remove()}else{column.addClass("no_widgets").prepend('<p class="no_widgets">'+App.lang("Empty")+"</p>")}})};if(settings.reoder_widgets_url){var reorder_timeout=false;wrapper.find("div.homescreen_column").sortable({items:"div.homescreen_widget",connectWith:"div.homescreen_column",handle:"div.reorder img",distance:10,revert:true,tolerance:"pointer",start:function(){wrapper.find("div.homescreen_column.no_widgets p.no_widgets").remove();clearTimeout(reorder_timeout);reorder_timeout=false},stop:function(){update_empty()},update:function(){if(!reorder_timeout){reorder_timeout=setTimeout(function(){var data={submitted:"submitted"};wrapper.find("div.homescreen_column").each(function(){var column=$(this);var column_id=column.attr("column_id");var position=1;column.find("div.homescreen_widget").each(function(){var widget_id=$(this).attr("widget_id");data["widgets_order["+widget_id+"][column_id]"]=column_id;data["widgets_order["+widget_id+"][position]"]=position++})});$.ajax({type:"post",url:settings.reoder_widgets_url,data:data,error:function(){App.Wireframe.Flash.error("Failed to update widgets order. Please try again later")}});clearTimeout(reorder_timeout);reorder_timeout=false},1000)}}})}})},add_widget:function(column_id,widget){var wrapper=$(this);var column=wrapper.find("div.homescreen_column[column_id="+column_id+"]");if(column.length>0){if(column.is("div.homescreen_column.no_widgets")){column.removeClass("no_widgets").find("p.no_widgets").remove()}if(typeof(widget.caption)=="string"&&widget.caption){if(widget.caption.length>20){var widget_title='<span title="'+App.clean(widget.caption)+'" class="long_caption">'+App.clean(widget.caption.substr(0,20))+'...</span> <span class="details">'+App.clean(widget.name)+"</span>"}else{var widget_title=App.clean(widget.caption)+' <span class="details">'+App.clean(widget.name)+"</span>"}}else{var widget_title=App.clean(widget.name)}var widget_row=$('<div class="homescreen_widget" widget_id="'+widget.id+'"><div class="homescreen_widget_title"><div class="reorder"><img src="'+App.Wireframe.Utils.imageUrl("widgets-drag-handle.png","homescreens")+'"></div><div class="name">'+widget_title+'</div><div class="options"></div></div></div>');if(widget.description){widget_row.append('<div class="homescreen_widget_description">'+widget.description+"</div>").addClass("with_description")}var last_widget=column.find("div.homescreen_widget:last");if(last_widget.length>0){last_widget.after(widget_row)}else{column.prepend(widget_row)}var options_cell=widget_row.find("div.options");if(widget.has_options&&widget.permissions["can_edit"]){$('<a href="'+widget.urls["edit"]+'" class="edit_widget" title="'+App.lang("Configure a Widget")+'"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/edit-tab.png","homescreens")+'"></a>').flyoutForm({width:600,success_event:"homescreen_widget_updated"}).appendTo(options_cell)}if(widget.permissions["can_delete"]){$('<a href="'+widget.urls["delete"]+'" class="delete_widget"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/delete-tab.png","homescreens")+'"></a>').asyncLink({confirmation:App.lang("Are you sure that you want to remove this widget?"),success:function(){wrapper.manageHomescreenWidgets("remove_widget",widget.id)},success_event:"homescreen_widget_deleted"}).appendTo(options_cell)}}},remove_widget:function(widget_id){var wrapper=$(this);var widget=wrapper.find("div.homescreen_widget[widget_id="+widget_id+"]");if(widget.length>0){var column=widget.parent();widget.remove();if(column.find("div.homescreen_widget").length<1){column.addClass("no_widgets").prepend('<p class="no_widgets">'+App.lang("Empty")+"</p>")}}}};$.fn.manageHomescreenWidgets=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{throw"Method "+method+" does not exist on jQuery.manageHomescreenWidgets"}}}})(jQuery);