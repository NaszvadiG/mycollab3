(function($){var public_methods={init:function(options,notifications){return this.each(function(){wrapper=$(this);var settings=jQuery.extend({},settings,options);var scope=settings.events_scope?"."+settings.events_scope:"";mark_read_url_pattern=settings.mark_read_url_pattern;mark_unread_url_pattern=settings.mark_unread_url_pattern;this.ln_data={refreshing:false,settings:settings,refresh_timer:setInterval('$("#'+this["id"]+'").listNotifications("refresh");',30000)};$(window).bind("focus"+scope,function(){wrapper.listNotifications("refresh").listNotifications("setAutoRefresh",30000)});$(window).bind("blur"+scope,function(){wrapper.listNotifications("pauseAutoRefresh")});initial_setup(notifications,settings);App.Wireframe.Events.bind("quick_view_content_loaded"+scope,function(e,c,url){wrapper.listNotifications("refresh")});App.each(notifications,function(k,notification){add_notification.apply(this,[notification,settings])})})},setAutoRefresh:function(interval){if(typeof(this["ln_data"])=="object"&&this["ln_data"]){if(typeof(interval)=="undefined"){interval=3000}this["ln_data"]["refresh_timer"]=setInterval('$("#'+wrapper.attr("id")+'").listNotifications("refresh");',interval)}},pauseAutoRefresh:function(){if(typeof(this["ln_data"])=="object"&&this["ln_data"]&&this["ln_data"]["refresh_timer"]){clearInterval(this["ln_data"]["refresh_timer"])}},refresh:function(on_success,on_error){return this.each(function(){var wrapper_dom=this;if(wrapper_dom.ln_data["refreshing"]===false){wrapper_dom.ln_data["refreshing"]=true;var unread_notification_ids=[];wrapper.find("tr.notification.unread").each(function(){unread_notification_ids.push($(this).attr("notification_id"))});$.ajax({url:wrapper_dom.ln_data["settings"]["refresh_url"],data:{last_refresh_timestamp:wrapper_dom.ln_data["settings"]["last_refresh_timestamp"],unread_notification_ids:unread_notification_ids.join(","),mark_listed_as_seen:true},type:"get",success:function(response){wrapper_dom.ln_data["refreshing"]=false;var loaded_notifications=0;if(typeof(response)=="object"&&response&&typeof(response.last_refresh_timestamp)&&typeof(response.notifications)!="undefined"){wrapper_dom.ln_data["settings"]["last_refresh_timestamp"]=response.last_refresh_timestamp;if(response.notifications){var previous_notification_id=null;App.each(response.notifications,function(k,notification){if(previous_notification_id===null){add_notification(notification,wrapper_dom.ln_data["settings"],"top")}else{add_notification(notification,wrapper_dom.ln_data["settings"],notification.id)}previous_notification_id=notification.id})}if(jQuery.isArray(response.notifications)){loaded_notifications=response.notifications.length}if(jQuery.isArray(response.mark_as_read_ids)){App.each(response.mark_as_read_ids,function(k,v){wrapper.find("tr.notification[notification_id="+v+"]").removeClass("read unread seen unseen").addClass("read seen").find("td.read_flag a").each(function(){var link=$(this);link.attr("href",link.attr("mark_unread_url"));link.find("img").attr("src",App.Wireframe.Utils.imageUrl("icons/read.png","notifications"))})})}}if(typeof(on_success)=="function"){on_success.apply(wrapper_dom,[loaded_notifications])}},error:function(){wrapper_dom.ln_data["refreshing"]=false;if(typeof(on_success)=="function"){on_success.apply(wrapper_dom)}}})}})}};var initial_setup=function(notifications,settings){buttons_wrapper=$('<div class="list_notifications_upper_buttons_wrapper">').appendTo(wrapper);notifications_wrapper=$('<div class="list_notifications_inner_wrapper"></div>').appendTo(wrapper);var cleaned_mass_edit_url=App.clean(settings.mass_edit_url);full_list_actions=$('<ul class="button_group list_notifications_mass_edit_actions"><li><a href="'+cleaned_mass_edit_url+'" mass_edit_action="mark_all_read">'+App.lang("Mark All as Read")+'</a></li><li><a href="'+cleaned_mass_edit_url+'" mass_edit_action="delete_all">'+App.lang("Delete All")+"</a></li></ul>").appendTo(buttons_wrapper);system_actions=$('<ul class="button_group system_actions"><li><a href="'+App.clean(settings.refresh_url)+'" class="list_notifications_refresh_button">'+App.lang("Refresh Now")+'</a></li><li><a href="'+App.clean(settings.settings_url)+'" class="list_notifications_settings_button">'+App.lang("Settings")+"</a></li></ul>").appendTo(buttons_wrapper);system_actions.find("a.list_notifications_refresh_button").click(function(){if(typeof(this.refreshing_notifications)!="undefined"&&this.refreshing_notifications===true){return false}this.refreshing_notifications=true;var link=$(this);link.text(App.lang("Refreshing ..."));wrapper.listNotifications("refresh",function(notifications_loaded){link.text("Refresh Now")[0].refreshing_notifications=false;if(!notifications_loaded){App.Wireframe.Flash.success("There are no new notifications")}},function(){link.text("Refresh Now")[0].refreshing_notifications=false;App.Wireframe.Flash.error("Failed to refresh notifications")});return false});system_actions.find("a.list_notifications_settings_button").flyoutForm({title:App.lang("Settings"),success_message:App.lang("Settings updated"),success_event:"notifications_settings_updated",width:700});multiselect_actions=$('<ul class="button_group list_notifications_mass_edit_actions right"><li><a href="'+cleaned_mass_edit_url+'" mass_edit_action="mark_read" class="disabled">'+App.lang("Mark as Read")+'</a></li><li><a href="'+cleaned_mass_edit_url+'" mass_edit_action="mark_unread" class="disabled">'+App.lang("Mark as Unread")+'</a></li><li><a href="'+cleaned_mass_edit_url+'" mass_edit_action="delete" class="disabled">'+App.lang("Delete")+"</a></li></ul>").appendTo(buttons_wrapper);var mass_edit_action_in_progress=false;wrapper.delegate("ul.list_notifications_mass_edit_actions a","click",function(){if(mass_edit_action_in_progress){return false}var link=$(this);if(!link.is(".disabled")){mass_edit_action_in_progress=true;var mass_edit_action=link.attr("mass_edit_action");var selected_notification_ids=[];if(mass_edit_action!="mark_all_read"&&mass_edit_action!="delete_all"){wrapper.find("tr.notification td.multiselect input[type=checkbox]:checked").each(function(){selected_notification_ids.push($(this).attr("value"))})}$.ajax({type:"post",url:link.attr("href"),data:{mass_edit_action:mass_edit_action,selected_notification_ids:selected_notification_ids.join(","),submitted:"submitted",},success:function(r){var notifications_updated=0;var notifications_deleted=0;if(mass_edit_action=="mark_all_read"){wrapper.find("tr.notification").each(function(){var row=$(this);set_read_and_seen_classes(row,true,true);row.find("td.read_flag a").each(function(){var link=$(this);link.attr("href",link.attr("mark_unread_url")).find("img").attr("src",settings.read_icon_url)});notifications_updated++})}else{if(mass_edit_action=="delete_all"){var to_delete=wrapper.find("tr.notification");notifications_deleted=to_delete.length;to_delete.remove()}else{if(mass_edit_action=="mark_read"){App.each(selected_notification_ids,function(k,notification_id){var row=wrapper.find("tr.notification[notification_id="+notification_id+"]");if(row.length>0){set_read_and_seen_classes(row,true,true);row.find("td.read_flag a").each(function(){var link=$(this);link.attr("href",link.attr("mark_unread_url")).find("img").attr("src",settings.read_icon_url)});notifications_updated++}})}else{if(mass_edit_action=="mark_unread"){App.each(selected_notification_ids,function(k,notification_id){var row=wrapper.find("tr.notification[notification_id="+notification_id+"]");if(row.length>0){set_read_and_seen_classes(row,false,true);row.find("td.read_flag a").each(function(){var link=$(this);link.attr("href",link.attr("mark_read_url")).find("img").attr("src",settings.unread_icon_url)});notifications_updated++}})}else{if(mass_edit_action=="delete"){App.each(selected_notification_ids,function(k,notification_id){var row=wrapper.find("tr.notification[notification_id="+notification_id+"]");if(row.length>0){row.remove();notifications_deleted}})}}}}}mass_edit_action_in_progress=false;refresh_table_and_empty_message_display();if(notifications_deleted==1){App.Wireframe.Flash.success("One notification has been deleted")}else{if(notifications_deleted>1){App.Wireframe.Flash.success(":num notifications have been deleted",{num:notifications_deleted})}else{if(notifications_updated==1){App.Wireframe.Flash.success("One notification has been updated")}else{if(notifications_updated>1){App.Wireframe.Flash.success(":num notifications have been updated",{num:notifications_updated})}}}}},error:function(r){App.Wireframe.Flash.error("Operation failed");mass_edit_action_in_progress=false}})}return false});empty_list_message=$('<p class="empty_page">'+App.lang("Notifications list is empty")+"</p>").hide().appendTo(notifications_wrapper);notifications_wrapper.delegate("tr.notification td.read_flag a","click",function(event){App.Delegates.asyncLinkClick.apply(this,[event,{success:function(notification){var link=$(this);var row=link.parent().parent();if(notification.is_read){link.attr({href:get_mark_as_unread_url(notification.id),title:App.lang("Click to Mark Unread")}).find("img").attr("src",settings.read_icon_url)}else{link.attr({href:get_mark_as_read_url(notification.id),title:App.lang("Click to Mark Read")}).find("img").attr("src",settings.unread_icon_url)}set_read_and_seen_classes(row,notification.is_read,notification.is_seen)}}]);return false});notifications_wrapper.delegate("tr.notification td.remove a","click",function(event){App.Delegates.asyncLinkClick.apply(this,[event,{confirmation:App.lang("Are you sure?"),success:function(response){$(this).parent().parent().remove();refresh_table_and_empty_message_display();App.Wireframe.Flash.success("Selected notification has been deleted")}}]);return false});notifications_wrapper.delegate("tr.notification td.multiselect input[type=checkbox]","click",function(event){var row=$(this).parents("tr.notification");var parent_type=row.attr("parent_type"),parent_id=row.attr("parent_id");if(this.checked){row.addClass("selected");if(parent_type&&parent_id&&event.shiftKey){notifications_wrapper.find("tr.notification[parent_type="+parent_type+"][parent_id="+parent_id+"]:not(.selected)").addClass("selected").find("td.multiselect input[type=checkbox]").prop("checked",true)}}else{row.removeClass("selected");if(parent_type&&parent_id&&event.shiftKey){notifications_wrapper.find("tr.notification.selected[parent_type="+parent_type+"][parent_id="+parent_id+"]").removeClass("selected").find("td.multiselect input[type=checkbox]").prop("checked",false)}}if(notifications_wrapper.find("tr.notification.selected").length>0){multiselect_actions.find("li a").removeClass("disabled")}else{multiselect_actions.find("li a").addClass("disabled")}});if(!(jQuery.isArray(notifications)&&notifications.length)){empty_list_message.show()}};var set_read_and_seen_classes=function(row,is_read,is_seen){row.removeClass("read unread seen unseen").addClass((is_read?"read":"unread")+" "+(is_seen?"seen":"unseen"))};var refresh_table_and_empty_message_display=function(){var tables_with_data=0;notifications_wrapper.find("table.notifications_for_day").each(function(){var table=$(this);if(table.find("tr.notification").length>0){tables_with_data++}else{table.remove()}});if(tables_with_data>0){if(notifications_wrapper.find("tr.notification.selected").length>0){multiselect_actions.find("li a").removeClass("disabled")}else{multiselect_actions.find("li a").addClass("disabled")}}else{empty_list_message.show();multiselect_actions.find("li a").addClass("disabled")}};var add_notification=function(notification,settings,where){var wrapper_dom=this;var row_class=["notification"];if(notification.is_seen){row_class.push("seen")}else{row_class.push("unseen")}if(notification.is_read){row_class.push("read");var read_status_icon_url=settings.read_icon_url;var read_status_title=App.lang("Click to Mark Unread")}else{row_class.push("unread");var read_status_icon_url=settings.unread_icon_url;var read_status_title=App.lang("Click to Mark Read")}var mark_read_url=App.clean(get_mark_as_read_url(notification.id));var mark_unread_url=App.clean(get_mark_as_unread_url(notification.id));if(typeof(notification.parent)=="object"&&notification.parent){var parent_type=notification.parent["class"],parent_id=notification.parent["id"],checkbox_description=App.lang("Shift+Click to select all notifications that are related to this :type",{type:notification.parent["verbose_type_lowercase"]})}else{var parent_type,parent_id="",checkbox_description=""}var row_html='<tr class="'+row_class.join(" ")+'" notification_id="'+notification.id+'" parent_type="'+App.clean(parent_type)+'" parent_id="'+parent_id+'"><td class="read_flag"><a href="'+(notification.is_read?mark_unread_url:mark_read_url)+'" title="'+App.clean(read_status_title)+'" mark_read_url="'+mark_read_url+'" mark_unread_url="'+mark_unread_url+'"><img src="'+read_status_icon_url+'"></a></td><td class="sender">'+(typeof(notification.sender)=="object"&&notification.sender?'<img src="'+App.clean(notification.sender["avatar"]["small"])+'" alt="'+App.clean(notification.sender["display_name"])+'">':"")+'</td><td class="message">'+notification.message+'</td><td class="timestamp">'+App.clean(notification.created_on["formatted_time"])+'</td><td class="remove"><a href="'+settings.delete_url_pattern.replace("--NOTIFICATION-ID--",notification.id)+'"><img src="'+App.Wireframe.Utils.imageUrl("/icons/12x12/delete.png","environment")+'"</a></td><td class="multiselect"><input type="checkbox" value="'+notification.id+'" title="'+checkbox_description+'"></td></tr>';var notifications_table=notifications_table_for_day(notification.created_on);if(where=="top"){notifications_table.find("tbody").prepend(row_html)}else{if(typeof(where)=="number"){var after=notifications_table.find("tr.notification[notification_id="+where+"]");if(after.length){after.after(row_html)}else{notifications_table.find("tbody").prepend(row_html)}}else{notifications_table.find("tbody").append(row_html)}}};var notifications_table_for_day=function(date_time_value){var day=date_time_value.mysql.substr(0,10);var table=notifications_wrapper.find("table.notifications_for_day[notifications_for_day="+day+"]");if(App.isYesterday(date_time_value)){var day_label=App.lang("Yesterday")}else{if(App.isToday(date_time_value)){var day_label=App.lang("Today")}else{var day_label=date_time_value.formatted_date}}if(table.length<1){table=$('<table class="notifications_for_day common" notifications_for_day="'+day+'" timestamp_reference="'+date_time_value.timestamp+'" cellspacing="0"><thead><tr><th colspan="6">'+App.clean(day_label)+"</th></tr></thead><tbody></tbody></table>");var table_added=false;notifications_wrapper.find("table.notifications_for_day").each(function(){var current_table=$(this);if(date_time_value.timestamp>current_table.attr("timestamp_reference")){current_table.before(table);table_added=true;return false}});if(!table_added){notifications_wrapper.append(table)}}return table};var get_mark_as_read_url=function(notification_id){return mark_read_url_pattern.replace("--NOTIFICATION-ID--",notification_id)};var get_mark_as_unread_url=function(notification_id){return mark_unread_url_pattern.replace("--NOTIFICATION-ID--",notification_id)};var plugin_name="listNotifications";var wrapper;var buttons_wrapper;var notifications_wrapper;var empty_list_message;var multiselect_actions;var system_actions;var full_list_actions;var mark_read_url_pattern;var mark_unread_url_pattern;var settings={settings_url:null,refresh_url:null,mass_edit_url:null,delete_url_pattern:null,mark_read_url_pattern:null,mark_unread_url_pattern:null,read_icon_url:null,unread_icon_url:null,last_refresh_timestamp:null,events_scope:""};$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);